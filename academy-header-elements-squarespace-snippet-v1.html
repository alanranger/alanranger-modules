<!--
Academy Header Elements — Squarespace Code Block
For injection into Squarespace Header (Code Injection → Header)
Displays: Welcome message, Academy Dashboard title (centered), Logo & Logout (right)
-->

<style id="ar-academy-header-style">
  /* Academy Header Elements - positioned in Squarespace header */
  #ar-academy-header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 100%;
    padding: 16px 32px;
    background: #000;
    color: #fff;
    position: relative;
    z-index: 1000;
    min-height: 80px;
  }
  
  /* Left: Welcome message */
  #ar-academy-header-welcome {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 0 0 auto;
    min-width: 280px;
  }
  
  #ar-academy-header-welcome-text {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
    line-height: 1.3;
  }
  
  #ar-academy-header-welcome-name {
    color: #E57200;
    font-weight: 800;
    font-size: 22px;
  }
  
  #ar-academy-header-last-login {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.3;
    font-weight: 500;
  }
  
  /* Center: Academy Dashboard title */
  #ar-academy-header-center {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1 1 auto;
    gap: 16px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }
  
  #ar-academy-header-logo-icon {
    width: 56px;
    height: 56px;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }
  
  #ar-academy-header-title {
    font-size: 32px;
    font-weight: 800;
    color: #fff;
    margin: 0;
    line-height: 1.2;
    letter-spacing: -0.5px;
  }
  
  #ar-academy-header-subtitle {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.85);
    margin: 4px 0 0 0;
    line-height: 1.3;
    font-weight: 500;
  }
  
  /* Right: Logo and Logout */
  #ar-academy-header-right {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 0 0 auto;
    margin-left: auto;
  }
  
  #ar-academy-header-brand-logo {
    width: 180px;
    height: auto;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }
  
  #ar-academy-header-logout-btn {
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  #ar-academy-header-logout-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.7);
    transform: translateY(-1px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    #ar-academy-header-container {
      flex-wrap: wrap;
      padding: 12px 20px;
      min-height: auto;
    }
    
    #ar-academy-header-welcome {
      order: 1;
      min-width: auto;
    }
    
    #ar-academy-header-welcome-text {
      font-size: 18px;
    }
    
    #ar-academy-header-welcome-name {
      font-size: 20px;
    }
    
    #ar-academy-header-last-login {
      font-size: 14px;
    }
    
    #ar-academy-header-center {
      position: static;
      transform: none;
      order: 2;
      width: 100%;
      margin: 12px 0;
      gap: 12px;
    }
    
    #ar-academy-header-logo-icon {
      width: 40px;
      height: 40px;
    }
    
    #ar-academy-header-title {
      font-size: 24px;
    }
    
    #ar-academy-header-subtitle {
      font-size: 14px;
    }
    
    #ar-academy-header-right {
      order: 3;
      margin-left: 0;
      gap: 12px;
    }
    
    #ar-academy-header-brand-logo {
      width: 140px;
    }
    
    #ar-academy-header-logout-btn {
      padding: 10px 20px;
      font-size: 14px;
    }
  }
</style>

<div id="ar-academy-header-container">
  <!-- Left: Welcome message -->
  <div id="ar-academy-header-welcome">
    <div id="ar-academy-header-welcome-text">
      Welcome back, <span id="ar-academy-header-welcome-name">...</span>
    </div>
    <div id="ar-academy-header-last-login">Loading...</div>
  </div>
  
  <!-- Center: Academy Dashboard title -->
  <div id="ar-academy-header-center">
    <img
      id="ar-academy-header-logo-icon"
      src="https://www.alanranger.com/s/alan-ranger-photography-academy-logo.png"
      alt="Academy"
      loading="eager"
    />
    <div>
      <h1 id="ar-academy-header-title">Your Personal Academy Dashboard</h1>
      <p id="ar-academy-header-subtitle">Your hub for modules, exams, practice packs and account status.</p>
    </div>
  </div>
  
  <!-- Right: Logo and Logout -->
  <div id="ar-academy-header-right">
    <a
      id="ar-academy-header-brand-link"
      href="https://www.alanranger.com/"
      aria-label="Back to AlanRanger.com homepage"
    >
      <img
        id="ar-academy-header-brand-logo"
        src="https://images.squarespace-cdn.com/content/v1/5013f4b2c4aaa4752ac69b17/b859ad2b-1442-4595-b9a4-410c32299bf8/ALAN+RANGER+photography+LOGO+BLACK.+switched+small.png?format=1500w"
        alt="Alan Ranger Photography"
        loading="eager"
      />
    </a>
    <button
      id="ar-academy-header-logout-btn"
      type="button"
      data-ms-action="logout"
    >
      Log out
    </button>
  </div>
</div>

<script>
(function() {
  // Only run on Academy pages
  var path = (window.location && window.location.pathname) ? window.location.pathname : "";
  var isAcademy = (path === "/academy" || path.indexOf("/academy/") === 0);
  if (!isAcademy) return;
  
  // Wait for Memberstack to load
  function waitForMemberstack() {
    return new Promise(function(resolve) {
      var start = Date.now();
      function check() {
        if (window.$memberstackDom) {
          resolve(window.$memberstackDom);
        } else if (Date.now() - start < 8000) {
          setTimeout(check, 100);
        } else {
          resolve(null);
        }
      }
      check();
    });
  }
  
  // Get member name from customFields
  function getMemberName(member) {
    if (!member || !member.data) return null;
    var customFields = member.data.customFields || {};
    var firstName = customFields["first-name"] || customFields.firstName || customFields.first_name || "";
    var lastName = customFields["last-name"] || customFields.lastName || customFields.last_name || "";
    if (firstName && lastName) return firstName + " " + lastName;
    if (firstName) return firstName;
    if (lastName) return lastName;
    // Fallback to email if no name
    var email = member.data.email || "";
    if (email) return email.split("@")[0];
    return "Member";
  }
  
  // Format last login date
  function formatLastLogin(dateStr) {
    if (!dateStr) return "First visit";
    try {
      var date = new Date(dateStr);
      var day = date.getDate();
      var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var month = monthNames[date.getMonth()];
      var year = date.getFullYear();
      var hours = String(date.getHours()).padStart(2, '0');
      var minutes = String(date.getMinutes()).padStart(2, '0');
      return "Last logged in " + day + " " + month + " " + year + " at " + hours + ":" + minutes;
    } catch (e) {
      return "Last logged in: " + dateStr;
    }
  }
  
  // Load member data and update header
  async function loadHeaderData() {
    var ms = await waitForMemberstack();
    if (!ms) {
      // Hide welcome if Memberstack not available
      var welcomeEl = document.getElementById('ar-academy-header-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';
      return;
    }
    
    try {
      var member = await ms.getCurrentMember();
      if (!member || !member.data) {
        // Not logged in - hide welcome
        var welcomeEl = document.getElementById('ar-academy-header-welcome');
        if (welcomeEl) welcomeEl.style.display = 'none';
        return;
      }
      
      // Update welcome name
      var nameEl = document.getElementById('ar-academy-header-welcome-name');
      var name = getMemberName(member);
      if (nameEl && name) {
        nameEl.textContent = name;
      }
      
      // Get last login - try multiple sources
      var lastLogin = null;
      var memberId = member.id || (member.data && member.data.id);
      var memberEmail = (member.data && member.data.email) || null;
      
      // Track login event - simplified and more reliable
      // Track if we haven't tracked in the last 1 minute (allows re-tracking after logout/login)
      var now = Date.now();
      var lastTracked = sessionStorage.getItem('ar-login-tracked-' + memberId);
      var oneMinuteAgo = 60 * 1000;
      var shouldTrack = !lastTracked || (now - parseInt(lastTracked, 10)) > oneMinuteAgo;
      
      if (memberId && shouldTrack) {
        console.log('[Academy Header] Tracking login event for member:', memberId, 'email:', memberEmail);
        
        // Track login event immediately
        fetch('https://alanranger-modules.vercel.app/api/academy/track-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            member_id: memberId,
            email: memberEmail
          })
        }).then(function(response) {
          if (response.ok) {
            return response.json();
          } else {
            return response.text().then(function(text) {
              throw new Error('HTTP ' + response.status + ': ' + text);
            });
          }
        }).then(function(data) {
          // Mark as tracked with current timestamp
          sessionStorage.setItem('ar-login-tracked-' + memberId, String(now));
          sessionStorage.setItem('ar-last-activity-' + memberId, String(now));
          console.log('[Academy Header] Login event tracked successfully:', data);
          
          // Update last login display with current time immediately
          var lastLoginEl = document.getElementById('ar-academy-header-last-login');
          if (lastLoginEl) {
            lastLoginEl.textContent = formatLastLogin(new Date().toISOString());
          }
          
          // Refresh from API after a short delay to get the recorded time
          setTimeout(function() {
            fetch('https://alanranger-modules.vercel.app/api/academy/member-data?memberId=' + encodeURIComponent(memberId))
              .then(function(response) {
                if (response.ok) {
                  return response.json();
                }
                return null;
              })
              .then(function(memberData) {
                if (memberData && memberData.last_login) {
                  var lastLoginEl = document.getElementById('ar-academy-header-last-login');
                  if (lastLoginEl) {
                    lastLoginEl.textContent = formatLastLogin(memberData.last_login);
                  }
                }
              })
              .catch(function(err) {
                console.debug('[Academy Header] Error refreshing last login:', err);
              });
          }, 2000);
        }).catch(function(err) {
          console.error('[Academy Header] Error tracking login event:', err);
          // Don't mark as tracked if it failed - allow retry
        });
      } else if (memberId) {
        // Not tracking because we recently tracked - update activity timestamp
        sessionStorage.setItem('ar-last-activity-' + memberId, String(now));
      }
      
      // First, try Memberstack JSON directly (as it worked in previous code block)
      try {
        var jsonRes = await ms.getMemberJSON();
        if (jsonRes) {
          // Check various possible locations in Memberstack JSON
          if (jsonRes.lastLogin) {
            lastLogin = jsonRes.lastLogin;
          } else if (jsonRes.data && jsonRes.data.lastLogin) {
            lastLogin = jsonRes.data.lastLogin;
          } else if (jsonRes.data && jsonRes.data.data && jsonRes.data.data.lastLogin) {
            lastLogin = jsonRes.data.data.lastLogin;
          }
        }
      } catch (e) {
        console.debug('[Academy Header] Could not get lastLogin from Memberstack JSON:', e);
      }
      
      // If not found in Memberstack, try API (Supabase)
      if (!lastLogin && memberId) {
        try {
          var response = await fetch('https://alanranger-modules.vercel.app/api/academy/member-data?memberId=' + encodeURIComponent(memberId));
          if (response.ok) {
            var memberData = await response.json();
            lastLogin = memberData.last_login || null;
            
            // Debug logging
            console.log('[Academy Header] Member data response:', {
              memberId: memberId,
              hasLastLogin: !!lastLogin,
              lastLogin: lastLogin,
              memberDataKeys: Object.keys(memberData)
            });
          } else {
            var errorText = await response.text();
            console.error('[Academy Header] Failed to fetch member data:', response.status, errorText);
          }
        } catch (e) {
          console.error('[Academy Header] Error fetching from API:', e);
        }
      }
      
      // Update last login display
      var lastLoginEl = document.getElementById('ar-academy-header-last-login');
      if (lastLoginEl) {
        if (lastLogin) {
          lastLoginEl.textContent = formatLastLogin(lastLogin);
        } else {
          lastLoginEl.textContent = "First visit";
        }
      }
      
      // Wire up logout button
      var logoutBtn = document.getElementById('ar-academy-header-logout-btn');
      if (logoutBtn && !logoutBtn.hasAttribute('data-wired')) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Track logout event before logging out
          // Use sendBeacon for reliable tracking even during page unload
          if (memberId) {
            var email = memberEmail || null;
            
            // Try to get fresh member data, but don't wait too long
            if (ms && typeof ms.getCurrentMember === 'function') {
              var memberPromise = ms.getCurrentMember().catch(function() { return null; });
              var timeoutPromise = new Promise(function(resolve) { setTimeout(function() { resolve(null); }, 100); });
              
              Promise.race([memberPromise, timeoutPromise]).then(function(currentMember) {
                if (currentMember && currentMember.data && currentMember.data.email) {
                  email = currentMember.data.email;
                }
                
                // Use sendBeacon for reliable delivery during navigation
                var data = JSON.stringify({
                  member_id: memberId,
                  email: email
                });
                
                if (navigator.sendBeacon) {
                  var blob = new Blob([data], { type: 'application/json' });
                  navigator.sendBeacon('https://alanranger-modules.vercel.app/api/academy/track-logout', blob);
                  console.log('[Academy Header] Logout event sent via sendBeacon');
                } else {
                  // Fallback to fetch with keepalive
                  fetch('https://alanranger-modules.vercel.app/api/academy/track-logout', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: data,
                    keepalive: true
                  }).catch(function(err) {
                    console.warn('[Academy Header] Error tracking logout:', err);
                  });
                }
              });
            } else {
              // No Memberstack, use what we have
              var data = JSON.stringify({
                member_id: memberId,
                email: email
              });
              
              if (navigator.sendBeacon) {
                var blob = new Blob([data], { type: 'application/json' });
                navigator.sendBeacon('https://alanranger-modules.vercel.app/api/academy/track-logout', blob);
              } else {
                fetch('https://alanranger-modules.vercel.app/api/academy/track-logout', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: data,
                  keepalive: true
                }).catch(function(err) {
                  console.warn('[Academy Header] Error tracking logout:', err);
                });
              }
            }
            
            // Clear session storage
            sessionStorage.removeItem('ar-login-tracked-' + memberId);
            sessionStorage.removeItem('ar-last-activity-' + memberId);
          }
          
          if (ms && typeof ms.logout === 'function') {
            ms.logout().then(function() {
              window.location.href = '/academy/login';
            }).catch(function(err) {
              console.error('[Academy Header] Logout error:', err);
              window.location.href = '/academy/login';
            });
          } else {
            window.location.href = '/academy/login';
          }
        });
        logoutBtn.setAttribute('data-wired', 'true');
      }
    } catch (err) {
      console.error('[Academy Header] Error loading member data:', err);
      // Hide welcome on error
      var welcomeEl = document.getElementById('ar-academy-header-welcome');
      if (welcomeEl) welcomeEl.style.display = 'none';
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadHeaderData);
  } else {
    loadHeaderData();
  }
  
  // Also try after a delay (Memberstack sometimes loads late)
  setTimeout(loadHeaderData, 1000);
  setTimeout(loadHeaderData, 2000);
})();
</script>

<!--
END: Academy Header Elements
-->
