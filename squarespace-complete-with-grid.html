<!-- AR Assessment v2.2 — Module 1 + Supabase progress + branded PDFs (Squarespace Code Block) -->
<div id="ar-quiz" style="border:1px solid #eaeaea;border-left:10px solid #F05922;background:#fafafa;padding:24px;border-radius:12px;max-width:820px;margin:28px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">
  <style>
    #ar-quiz a { color:#2563eb !important; text-decoration:none; }
    #ar-quiz a:hover { text-decoration:underline; }
    #ar-toast{ position:fixed; z-index:99999; left:50%; top:22px; transform:translateX(-50%);
      background:#111; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.15); display:none; max-width:90vw; font-size:14px; line-height:1.35; text-align:center; }
    #ar-toast.success{ background:#10b981; } #ar-toast.error{ background:#ef4444; } #ar-toast.info{ background:#2563eb; }
    .ar-field{ border:1px solid #eaeaea;background:#fff;border-radius:10px;padding:14px;margin:12px 0; }
    .ar-qtxt{ font-weight:800;margin:0 0 8px; color:#F05922; }
    .ar-opt{ display:flex; gap:10px; align-items:flex-start; margin:8px 0; cursor:pointer; }
    #results .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; }
    #results .pill-pass { background:#e8fff4; color:#067647; border:1px solid #b7f0d2; }
    #results .pill-fail { background:#fff5f5; color:#b42318; border:1px solid #fac5c5; }
    #ar-auth { display:flex; align-items:center; gap:10px; margin:0 0 8px; color:#555; font-size:14px; flex-wrap:wrap; }
    #ar-auth .badge { padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; }
    #ar-auth .mini-btn { background:#fff; color:#333; border:1px solid #ddd; border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px; }
    #ar-auth .mini-btn:disabled { opacity:.6; cursor:not-allowed; }
    #ar-status { margin:6px 0 0; font-size:14px; color:#111; }
    .muted { color:#6b7280; }
    input[type="radio"] { accent-color:#F05922; }
    input[type="radio"]:checked { accent-color:#F05922; }
  </style>

  <div id="ar-auth">
    <span id="ar-auth-status" class="badge">Not signed in</span>
    <span id="ar-auth-email"></span>
    <button id="btn-magic" type="button" class="mini-btn" style="background:#F05922;color:#fff;border-color:#F05922;">Send magic link</button>
    <button id="btn-clear" type="button" class="mini-btn" style="background:#6b7280;color:#fff;border-color:#6b7280;">Clear results / Sign out</button>
  </div>
  <div style="font-size:12px;color:#6b7280;margin:8px 0 16px 0;padding:8px;background:#f9f9f9;border-radius:6px;">
    <strong>Magic link:</strong> Enter your email and click "Send magic link" to receive a secure login link. No password needed. 
    <strong>Clear results:</strong> Use this to sign out and reset the quiz so you can retake it.
  </div>

  <h2 style="margin:0 0 12px;font-weight:700;line-height:1.2;">Module 1 Assessment: What is Exposure</h2>
  <p style="margin:0 0 16px;color:#333;">Enter your details, answer the questions, then view your score. Download your results as a PDF. If you pass, you can also download a personalised certificate.</p>

  <!-- Learner details -->
  <form id="learner-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 20px;">
    <div>
      <label for="name" style="display:block;font-weight:600;margin-bottom:6px;">Name</label>
      <input id="name" name="name" type="text" required placeholder="Your name"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
    </div>
    <div>
      <label for="email" style="display:block;font-weight:600;margin-bottom:6px;">Email (for saving progress)</label>
      <input id="email" name="email" type="email" placeholder="you@example.com"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      <div id="ar-status"></div>
    </div>
  </form>

  <!-- Assessment -->
  <form id="quiz-form" novalidate></form>

  <!-- Actions -->
  <div id="quiz-actions" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:16px;">
    <button id="btn-submit" type="button"
            style="background:#F05922;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Submit answers</button>
    <button id="btn-retake" type="button" style="display:none;"
            style="background:#dc2626;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Retake test</button>
    <button id="btn-pdf" type="button" disabled
            style="background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download results (PDF)</button>
    <button id="btn-certificate" type="button" disabled
            style="background:#10b981;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download certificate (PDF)</button>
    <button id="btn-save" type="button" disabled
            style="background:#111827;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Save to my account</button>
  </div>

  <!-- Results -->
  <div id="results" style="margin-top:20px;display:none;background:#fff;border:1px solid #eaeaea;border-radius:10px;padding:16px;">
    <h3 style="margin:0 0 10px;font-size:18px;">Your results</h3>
    <div id="results-summary" style="margin-bottom:12px;"></div>
    <div id="results-compact" class="muted" style="font-size:13px;"></div>
    <div id="results-feedback" style="margin-top:8px;"></div>
  </div>

  <div id="ar-toast" role="status" aria-live="polite"></div>
  
  <!-- Back to Modules Button -->
  <div style="text-align:center; margin-top:24px; padding-top:16px; border-top:1px solid #eaeaea;">
    <a href="https://www.alanranger.com/academy-course-exam-page-camera-settings" 
       style="display:inline-block; background:#6b7280; color:#fff; text-decoration:none; padding:12px 20px; border-radius:10px; font-weight:700;">
      ← Back to Modules
    </a>
  </div>
</div>

<!-- Deps -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- BRANDING & LINKS ---------- */
const branding = {
  orange:"#F05922",
  logoUrl:"https://www.alanranger.com/s/ALAN-RANGER-LOGO-and-Icon-BLACK.png",
  academyUrl:"https://www.alanranger.com/s/alan-ranger-photography-academy-logo.png",
  signatureUrl:"https://www.alanranger.com/s/Alan-Ranger-black-high-res.png",
  courseUrl:"https://www.alanranger.com/online-photography-course",
  exposureUrl:"https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography",
  siteUrl:"https://alanranger.com"
};

/* ---------- SUPABASE (your live values) ---------- */
const SUPABASE_URL = "https://dqrtcsvqsfgbqmnonkpt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxcnRjc3Zxc2ZnYnFtbm9ua3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTA4MjUsImV4cCI6MjA3MjU2NjgyNX0.e19j8NOUK5HWoTGZv4B62U_n0je_19Tp-F20qKGbWDk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- MODULE CONFIG ---------- */
const quizConfig = {
  moduleId:"module-01-exposure",
  moduleTitle:"Module 1: What is Exposure",
  passMarkPercent:80,
  questions:[
    { id:"q1", text:"What does the term exposure mean in photography?", options:[
      "Collecting the correct quantity of light for proper image brightness",
      "Collecting quality of light to capture the image",
      "Using autofocus to make the image sharp",
      "Ensuring the colour is right in the image"
    ], correctIndex:0, reviewHint:"Review the 'What is Exposure' definition section."},
    { id:"q2", text:"What 3 variables control exposure?", options:[
      "Aperture, Shutter Speed, ISO","The lens, Colour, Focusing","White Balance, Focus, Metering","Histogram, Composition, Lighting"
    ], correctIndex:0, reviewHint:"See the Exposure Triangle section (Aperture, Shutter Speed, ISO)."},
    { id:"q3", text:"What does the aperture control in photography?", options:[
      "Colour enhancement","Depth of Field","Shutter Speed","ISO"
    ], correctIndex:1, reviewHint:"See aperture section - aperture controls depth of field."},
    { id:"q4", text:"What does the shutter control in photography?", options:[
      "Colour and saturation","Length of exposure time","Sharpness of moving subjects","ISO"
    ], correctIndex:1, reviewHint:"Check shutter speed section - shutter controls exposure time."},
    { id:"q5", text:"What does the ISO control in photography?", options:[
      "Amount of digital noise (grain)","Image sharpness","Aperture","Shutter speed"
    ], correctIndex:0, reviewHint:"Review ISO section - ISO controls sensor sensitivity and noise."},
    { id:"q6", text:"If an image appears too dark, it is considered:", options:[
      "Overexposed","Underexposed","Correctly exposed","High contrast"
    ], correctIndex:1, reviewHint:"Check 'Underexposure vs Overexposure' with examples."},
    { id:"q7", text:"If an image appears too bright with lost highlight details, it is:", options:[
      "Overexposed","Underexposed","Correctly exposed","Low contrast"
    ], correctIndex:0, reviewHint:"Review overexposure effects - washed out highlights."},
    { id:"q8", text:"Why might a photographer deliberately over/underexpose?", options:[
      "To save battery life","To test different metering modes","To achieve a creative effect or mood","To avoid using ISO"
    ], correctIndex:2, reviewHint:"See 'Creative exposure choices' and examples."},
    { id:"q9", text:"What is the main purpose of the histogram?", options:[
      "To show camera battery level","To display image composition","To reveal exposure clipping in highlights/shadows","To show autofocus points"
    ], correctIndex:2, reviewHint:"See histogram section - it shows tonal distribution and clipping."},
    { id:"q10", text:"Exposure compensation (+/-) is used to:", options:[
      "Change the camera's metering mode","Quickly correct metering bias","Adjust the ISO setting","Change the aperture size"
    ], correctIndex:1, reviewHint:"Review exposure compensation section - quick correction for metering bias."},
    { id:"q11", text:"If you increase shutter speed without changing other settings, the image will:", options:[
      "Become darker","Become brighter","Stay the same brightness","Increase in depth of field"
    ], correctIndex:0, reviewHint:"Revisit 'Shutter speed and exposure' cause/effect."},
    { id:"q12", text:"The exposure triangle demonstrates that:", options:[
      "All three settings work independently","Changing one setting requires adjusting others to maintain exposure","Only aperture affects brightness","ISO is the most important setting"
    ], correctIndex:1, reviewHint:"See exposure triangle section - the three settings work together."}
  ],
  feedbackMap:{
    topics:[
      { key:"exposure-basics",label:"Exposure basics (definition)" },
      { key:"exposure-triangle",label:"The Exposure Triangle (Aperture, Shutter, ISO)" },
      { key:"aperture-control",label:"What aperture controls" },
      { key:"shutter-control",label:"What shutter controls" },
      { key:"iso-control",label:"What ISO controls" },
      { key:"under-over",label:"Underexposed vs Overexposed" },
      { key:"creative-exposure",label:"Creative exposure choices" },
      { key:"histogram",label:"Using the histogram for exposure" },
      { key:"exposure-compensation",label:"Exposure compensation" },
      { key:"triangle-relationships",label:"Exposure triangle relationships" }
    ],
    questionTopics:{ 
      q1:["exposure-basics"], 
      q2:["exposure-triangle"], 
      q3:["aperture-control"], 
      q4:["shutter-control"], 
      q5:["iso-control"], 
      q6:["under-over"], 
      q7:["under-over"], 
      q8:["creative-exposure"], 
      q9:["histogram"], 
      q10:["exposure-compensation"], 
      q11:["triangle-relationships"], 
      q12:["triangle-relationships"] 
    },
    topicLinks:{
      "exposure-basics":branding.exposureUrl,
      "exposure-triangle":branding.exposureUrl + "#exposure-triangle",
      "aperture-control":branding.exposureUrl + "#aperture",
      "shutter-control":branding.exposureUrl + "#shutter",
      "iso-control":branding.exposureUrl + "#iso",
      "under-over":branding.exposureUrl + "#over-under",
      "creative-exposure":branding.exposureUrl + "#creative",
      "histogram":branding.exposureUrl + "#histogram",
      "exposure-compensation":branding.exposureUrl + "#compensation",
      "triangle-relationships":branding.exposureUrl + "#exposure-triangle"
    }
  }
};

/* ---------- RENDER UI ---------- */
(function initQuiz(){
  const quizForm = document.getElementById("quiz-form");
  const frag = document.createDocumentFragment();
  quizConfig.questions.forEach((q, idx) => {
    const field = document.createElement("div"); field.className = "ar-field";
    const qtxt = document.createElement("div"); qtxt.className = "ar-qtxt"; qtxt.textContent = `Q${idx+1}. ${q.text}`;
    field.appendChild(qtxt);
    q.options.forEach((opt, i) => {
      const id = `${q.id}-${i}`;
      const label = document.createElement("label"); label.className = "ar-opt"; label.setAttribute("for", id);
      const input = document.createElement("input"); input.type="radio"; input.name=q.id; input.id=id; input.value=i; input.required=true; input.style.cssText="margin-top:4px;";
      const span = document.createElement("span"); span.textContent = opt;
      label.appendChild(input); label.appendChild(span); field.appendChild(label);
    });
    frag.appendChild(field);
  });
  quizForm.appendChild(frag);
})();

/* ---------- AUTH & PROGRESS HELPERS ---------- */
const authBadge = document.getElementById('ar-auth-status');
const authEmail = document.getElementById('ar-auth-email');
const statusDiv = document.getElementById('ar-status');
const btnMagic = document.getElementById('btn-magic');
const btnClear = document.getElementById('btn-clear');

let lastMagicSentAt = 0;
const MAGIC_DEBOUNCE_MS = 60000;

function setAuthUI(user){
  if (user){
    authBadge.textContent = "Signed in";
    authEmail.textContent = user.email || "";
    const em = document.getElementById('email');
    if (user.email && (!em.value || em.value !== user.email)) em.value = user.email;
  } else {
    authBadge.textContent = "Not signed in";
    authEmail.textContent = "";
  }
}

async function currentUser(){ const { data:{user} } = await supabase.auth.getUser(); return user; }

async function sendMagicLink(email){
  if (!email || !email.includes("@")) { showToast("Please enter a valid email address.", "error"); return; }
  const now = Date.now();
  if (now - lastMagicSentAt < MAGIC_DEBOUNCE_MS) { showToast("Use the link we just sent, or try again in ~60s.", "info", 5000); return; }

  const { error } = await supabase.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: window.location.href.split('#')[0] }
  });
  if (error) { showToast("Could not send sign‑in link.", "error"); console.error(error); }
  else { lastMagicSentAt = now; showToast("Magic link sent! Check your email to sign in.", "success", 7000); }
}

btnMagic.addEventListener("click", async () => {
  const email = (document.getElementById('email').value || "").trim();
  await sendMagicLink(email);
});

// Clear results / sign out so you can retest immediately
async function clearForRetest(){
  try { await supabase.auth.signOut(); } catch(e){}
  localStorage.removeItem('ar_pending_result');
  localStorage.removeItem('ar_pending_email');
  const lf = document.getElementById("learner-form");
  const qf = document.getElementById("quiz-form");
  if (lf) lf.reset();
  if (qf) qf.reset();
  const box = document.getElementById("results");
  if (box) box.style.display = "none";
  const pdf = document.getElementById("btn-pdf");
  const cert = document.getElementById("btn-certificate");
  const save = document.getElementById("btn-save");
  if (pdf) { pdf.disabled = true; pdf.style.opacity = .6; }
  if (cert) { cert.disabled = true; cert.style.opacity = .6; }
  if (save) { save.disabled = true; save.style.opacity = .6; }
  lastReport = null;
  setAuthUI(null);
  renderProgressBadge();
  
  // Unlock radio buttons and restore submit button
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = false;
    radio.style.cursor = 'pointer';
  });
  btnSubmit.style.display = 'inline-block';
  document.getElementById('btn-retake').style.display = 'none';
  
  showToast("Signed out and cleared previous results. You can retake now.", "info", 5000);
}
btnClear.addEventListener("click", clearForRetest);

async function getLatestStatus(moduleId){
  const user = await currentUser(); if (!user) return null;
  const { data, error } = await supabase.from('module_results')
    .select('score_percent, passed, created_at').eq('user_id', user.id).eq('module_id', moduleId)
    .order('created_at', { ascending:false }).limit(1);
  if (error || !data?.length) return null;
  return data[0];
}

async function saveResultToDB(report){
  const user = await currentUser();
  if (!user){
    const email = document.getElementById('email').value.trim();
    if (!email) { alert("Enter your email to save progress."); return; }
    localStorage.setItem('ar_pending_result', JSON.stringify(report));
    localStorage.setItem('ar_pending_email', email);
    await sendMagicLink(email);
    return;
  }
  const { count } = await supabase.from('module_results')
    .select('*', { count:'exact', head:true })
    .eq('user_id', user.id).eq('module_id', report.moduleId);

  const payload = {
    user_id: user.id,
    email: user.email || (document.getElementById('email').value.trim() || ''),
    module_id: report.moduleId,
    score_percent: report.percent,
    passed: report.pass,
    attempt: (count || 0) + 1,
    details: { misses: report.misses }
  };
  const { error } = await supabase.from('module_results').insert(payload);
  if (error){ showToast("Save failed.", "error"); console.error(error); }
  else { showToast("Progress saved to your account.", "success"); renderProgressBadge(); }
}

async function renderProgressBadge(){
  const latest = await getLatestStatus(quizConfig.moduleId);
  if (latest){
    const when = new Date(latest.created_at).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    statusDiv.innerHTML = latest.passed
      ? `Status: <strong>Completed ✓</strong> (${latest.score_percent}% on ${when})`
      : `Status: Last attempt ${latest.score_percent}% on ${when}`;
  } else {
    statusDiv.textContent = "";
  }
}

/* ---------- REHYDRATE RESULTS AFTER MAGIC LINK ---------- */
const resultsBox      = document.getElementById("results");
const resultsSummary  = document.getElementById("results-summary");
const resultsCompact  = document.getElementById("results-compact");
const resultsFeedback = document.getElementById("results-feedback");

function renderResultsFromReport(rpt){
  const passPill = rpt.pass ? `<span class="pill pill-pass">Pass</span>`
                            : `<span class="pill pill-fail">Fail</span>`;
  resultsSummary.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
      <div style="font-size:28px;font-weight:800;">${rpt.percent}%</div>
      <div>${passPill} — ${rpt.correct}/${rpt.total} correct (Pass mark: ${quizConfig.passMarkPercent}%)</div>
    </div>
    <div style="margin-top:8px;color:#555;">
      <div><strong>Name:</strong> ${escapeHtml(rpt.name)} ${rpt.email ? `| <strong>Email:</strong> ${escapeHtml(rpt.email)}` : ""}</div>
      <div><strong>Date:</strong> ${formatDate(new Date(rpt.timestamp))}</div>
      <div><strong>Module:</strong> ${escapeHtml(rpt.moduleTitle)}</div>
    </div>`;
  resultsCompact.textContent = rpt.compact || "";

  if (!rpt.misses.length){
    resultsFeedback.innerHTML =
      `<div style="padding:12px;border:1px solid #e6f4ea;background:#f6fffa;border-radius:8px;">
         Great work — no weak topics identified for this module.
       </div>`;
  } else {
    const keys = [...new Set(rpt.misses.flatMap(m => quizConfig.feedbackMap.questionTopics[m.id]||[]))];
    resultsFeedback.innerHTML = `
      <h4 style="margin:12px 0 6px;font-size:16px;">Question review</h4>
      <ol style="margin:0 0 0 18px;">
        ${rpt.misses.map((m,i)=>`<li style="margin:6px 0;"><strong>${m.id.toUpperCase()}</strong>: ${escapeHtml(m.reviewHint||'Please review the relevant section.')}</li>`).join('')}
      </ol>
      <div style="padding:12px;border:1px dashed #f3c7b4;background:#fff7f3;border-radius:8px;margin-top:8px;">
        <strong>Topics to review:</strong>
        <ul style="margin:8px 0 0 18px;">
          ${keys.map(k=>{
              const t = (quizConfig.feedbackMap.topics.find(t=>t.key===k)||{}).label||k;
              const href = quizConfig.feedbackMap.topicLinks[k];
              return href ? `<li><a href="${href}" target="_blank" rel="noopener">${t}</a></li>` : `<li>${t}</li>`;
            }).join('')}
        </ul>
      </div>`;
  }

  resultsBox.style.display = "block";
  btnPDF.disabled = false; btnPDF.style.opacity = 1;
  btnSave.disabled = false; btnSave.style.opacity = 1;
  btnCert.disabled = !rpt.pass; btnCert.style.opacity = rpt.pass ? 1 : .6;
}

supabase.auth.onAuthStateChange(async (_event, session) => {
  setAuthUI(session?.user || null);
  if (!session?.user) return;

  const pending = localStorage.getItem('ar_pending_result');
  const pendingEmail = localStorage.getItem('ar_pending_email');

  if (pending){
    const rpt = JSON.parse(pending);
    if (pendingEmail) document.getElementById('email').value = pendingEmail;

    await saveResultToDB(rpt);
    lastReport = rpt;
    renderResultsFromReport(rpt);
    if (rpt.pass) showToast("Signed in. Progress saved — you can download your PDFs now.", "success", 6000);

    localStorage.removeItem('ar_pending_result');
    localStorage.removeItem('ar_pending_email');
  } else {
    renderProgressBadge();
  }
});
(async ()=>{ const { data:{user} } = await supabase.auth.getUser(); setAuthUI(user||null); renderProgressBadge(); })();

/* ---------- TOAST & CONFETTI ---------- */
function fireConfetti(){ confetti({ particleCount: 140, spread: 80, origin: { x: 0.5, y: 0.5 } }); setTimeout(()=>confetti({ particleCount:100, spread:100, origin:{x:0.5,y:0.5}}),250); }
function showToast(msg, type="error", duration=4000){ const t=document.getElementById('ar-toast'); t.textContent=msg; t.className=type==="success"?"success":(type==="info"?"info":"error"); t.style.display="block"; clearTimeout(showToast._timer); showToast._timer=setTimeout(()=>t.style.display="none", duration); }

/* ---------- BUTTONS ---------- */
const btnSubmit = document.getElementById("btn-submit");
const btnPDF    = document.getElementById("btn-pdf");
const btnCert   = document.getElementById("btn-certificate");
const btnSave   = document.getElementById("btn-save");
let lastReport = null;

btnSubmit.addEventListener("click", async () => {
  const learnerName  = document.getElementById("name").value.trim();
  if (!learnerName) { alert("Please enter your name."); return; }

  const unanswered = quizConfig.questions.filter(q => !document.querySelector(`input[name="${q.id}"]:checked`));
  if (unanswered.length) { alert("Please answer all questions before submitting."); return; }

  let correct = 0; const misses = []; const compactParts=[];
  quizConfig.questions.forEach((q, idx) => {
    const chosen = +document.querySelector(`input[name="${q.id}"]:checked`).value;
    const isCorrect = chosen === q.correctIndex;
    if (isCorrect) correct++; else misses.push({ id:q.id, reviewHint:q.reviewHint });
    compactParts.push(`Q${idx+1}: ${isCorrect ? 'Correct' : 'Incorrect'}`);
  });
  const total = quizConfig.questions.length;
  const pct   = Math.round((correct / total) * 100);
  const pass  = pct >= quizConfig.passMarkPercent;
  const compactLine = compactParts.join(', ');

  const topicKeys = new Set();
  misses.forEach(m => (quizConfig.feedbackMap.questionTopics[m.id] || []).forEach(k => topicKeys.add(k)));

  const passPill = pass ? `<span class="pill pill-pass">Pass</span>` : `<span class="pill pill-fail">Fail</span>`;
  resultsSummary.innerHTML = `
    <div style=\"display:flex;flex-wrap:wrap;gap:16px;align-items:center;\">\n      <div style=\"font-size:28px;font-weight:800;\">${pct}%</div>\n      <div>${passPill} — ${correct}/${total} correct (Pass mark: ${quizConfig.passMarkPercent}%)</div>\n    </div>\n    <div style=\"margin-top:8px;color:#555;\">\n      <div><strong>Name:</strong> ${escapeHtml(learnerName)} ${document.getElementById("email").value ? `| <strong>Email:</strong> ${escapeHtml(document.getElementById("email").value)}` : ""}</div>\n      <div><strong>Date:</strong> ${formatDate(new Date())}</div>\n      <div><strong>Module:</strong> ${escapeHtml(quizConfig.moduleTitle)}</div>\n    </div>`;
  resultsCompact.textContent = compactLine;

  resultsFeedback.innerHTML = misses.length
    ? `<h4 style=\"margin:12px 0 6px;font-size:16px;\">Question review</h4>\n       <ol style=\"margin:0 0 0 18px;\">${
         misses.map(m => `<li style=\"margin:6px 0;\"><strong>${m.id.toUpperCase()}</strong>: ${escapeHtml(m.reviewHint || "Please review the relevant section.")}</li>`).join("")
       }</ol>\n       <div style=\"padding:12px;border:1px dashed #f3c7b4;background:#fff7f3;border-radius:8px;margin-top:8px;\">\n         <strong>Topics to review:</strong>\n         <ul style=\"margin:8px 0 0 18px;\">${
           Array.from(topicKeys).map(k => {
             const label = (quizConfig.feedbackMap.topics.find(t => t.key === k) || {}).label || k;
             const href  = quizConfig.feedbackMap.topicLinks[k];
             return href ? `<li><a href=\"${href}\" target=\"_blank\" rel=\"noopener\">${label}</a></li>` : `<li>${label}</li>`;
           }).join("")
         }</ul>\n       </div>`
    : `<div style="padding:12px;border:1px solid #e6f4ea;background:#f6fffa;border-radius:8px;">Great work — no weak topics identified for this module.</div>`;
  resultsBox.style.display = "block";

  btnPDF.disabled = false; btnPDF.style.opacity = 1;
  btnSave.disabled = false; btnSave.style.opacity = 1;
  btnCert.disabled = !pass; btnCert.style.opacity = pass ? 1 : .6;

  lastReport = {
    moduleId: quizConfig.moduleId, moduleTitle: quizConfig.moduleTitle,
    name: learnerName, email: document.getElementById("email").value.trim(),
    percent: pct, pass, correct, total, misses, compact: compactLine, timestamp: new Date().toISOString()
  };

  // Lock all radio buttons after submission
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = true;
    radio.style.cursor = 'not-allowed';
  });
  
  // Hide submit button and show retake button
  btnSubmit.style.display = 'none';
  document.getElementById('btn-retake').style.display = 'inline-block';

  if (pass){ fireConfetti(); showToast("Congrats! You passed this module. You can download your certificate now.", "success", 5000); }
  else { showToast("You didn't pass this time. Review the linked topics, then use the 'Retake test' button to try again.", "error", 6000); }
});


// Add retake button handler
document.getElementById('btn-retake').addEventListener("click", () => {
  // Preserve name and email, only reset quiz answers
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  
  document.getElementById("quiz-form").reset();
  resultsBox.style.display = "none";
  btnPDF.disabled = true; btnPDF.style.opacity = .6;
  btnCert.disabled = true; btnCert.style.opacity = .6;
  btnSave.disabled = true; btnSave.style.opacity = .6;
  lastReport = null;
  
  // Restore name and email
  document.getElementById("name").value = name;
  document.getElementById("email").value = email;
  
  // Unlock radio buttons and restore submit button
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = false;
    radio.style.cursor = 'pointer';
  });
  btnSubmit.style.display = 'inline-block';
  document.getElementById('btn-retake').style.display = 'none';
  
  showToast("Quiz reset. You can now retake the test.", "info", 3000);
});

btnSave.addEventListener("click", async () => {
  if (!lastReport) { alert("Please complete the assessment first."); return; }
  await saveResultToDB(lastReport);
});

/* ---------- PDF HELPERS ---------- */
async function toDataURL(url){ try{ const res=await fetch(url,{mode:'cors'}); const blob=await res.blob();
  return await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); } catch(e){ return null; } }
function getImgDims(dataURL){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth,h:img.naturalHeight}); img.src=dataURL; }); }
function fitWithin(sw,sh,mw,mh){ const t=Math.min(mw/sw,mh/sh); return {w:sw*t,h:sh*t}; }
function svgToPNG(svgString, width, height) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width;
    canvas.height = height;
    
    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
  });
}
function escapeHtml(s=""){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }
function slugify(s=""){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function formatDate(d){ return d.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); }
function writeWrapped(doc, text, x, y, maxWidth, lineHeight){ const lines=doc.splitTextToSize(text,maxWidth); lines.forEach(l=>{ doc.text(l,x,y); y+=lineHeight; }); return y; }
const { jsPDF } = window.jspdf;

/* ---------- RESULTS PDF ---------- */
document.getElementById("btn-pdf").addEventListener("click", async () => {
  if (!lastReport) return;
  const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
  const [logo, academy] = await Promise.all([toDataURL(branding.logoUrl), toDataURL(branding.academyUrl)]);

  doc.setFillColor(240,89,34); doc.rect(0,0,210,24,'F');
  if (logo) { const logoDims=await getImgDims(logo); const logoFitted=fitWithin(logoDims.w,logoDims.h,20,16);
    doc.addImage(logo,'PNG',8,4,logoFitted.w,logoFitted.h); }
  if (academy) doc.addImage(academy,'PNG',210-24,4,16,16);
  doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(15);
  doc.text(quizConfig.moduleTitle,28,15); doc.setTextColor(0,0,0);

  let y=34; doc.setDrawColor(230,230,230); doc.roundedRect(12,y,186,38,2,2);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`Name: ${lastReport.name}`,18,y+9);
  doc.text(`Date: ${formatDate(new Date(lastReport.timestamp))}`,18,y+16);
  doc.text(`Score: ${lastReport.percent}% (${lastReport.correct}/${lastReport.total}) — ${lastReport.pass?'Pass':'Fail'}`,18,y+23);

  doc.setFontSize(10); doc.setTextColor(90,90,90);
  doc.text(lastReport.compact || "", 18, y+31);
  doc.setTextColor(0,0,0);

  y+=48; doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('About the Alan Ranger Photography Academy',12,y); y+=6;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const blurb=`This assessment is part of the Beginners pathway (15 modules): Exposure, Aperture, Shutter Speed, ISO, Manual Exposure, Metering, Exposure Bracketing, Focusing, Depth of Field, Dynamic Range, White Balance, Camera Drive Modes, JPEG vs RAW, Full Frame vs Crop Sensor, and Focal Length.`;
  y=writeWrapped(doc, blurb, 12, y, 186, 6); y+=3;
  const link1="Course page: "+branding.courseUrl.replace(/^https?:\/\//,'');
  const link2="Module article: "+branding.exposureUrl.replace(/^https?:\/\//,'');
  doc.setTextColor(37,99,235); doc.text(link1,12,y); doc.link(12,y-4,doc.getTextWidth(link1),6,{url:branding.courseUrl}); y+=6;
  doc.text(link2,12,y); doc.link(12,y-4,doc.getTextWidth(link2),6,{url:branding.exposureUrl}); doc.setTextColor(0,0,0); y+=10;

  doc.setFont('helvetica','bold'); doc.text('Question review',12,y); y+=6; doc.setFont('helvetica','normal');
  if (!lastReport.misses.length) { y=writeWrapped(doc,'Great work — no weak topics identified for this module.',12,y,186,6); }
  else {
    lastReport.misses.forEach((m,i)=>{ y=writeWrapped(doc,`${i+1}. ${m.id.toUpperCase()}: ${m.reviewHint||'Please review the relevant section.'}`,12,y,186,6); });
    y+=4; doc.setFont('helvetica','bold'); doc.text('Topics to review',12,y); y+=6; doc.setFont('helvetica','normal');
    const keys=[...new Set(lastReport.misses.flatMap(m=>quizConfig.feedbackMap.questionTopics[m.id]||[]))];
    keys.forEach(k=>{ const label=(quizConfig.feedbackMap.topics.find(t=>t.key===k)||{}).label||k; y=writeWrapped(doc,`• ${label}`,16,y,182,6); });
  }
  doc.save(`${slugify(lastReport.moduleId)}-results-${Date.now()}.pdf`);
});

/* ---------- CERTIFICATE PDF ---------- */
document.getElementById("btn-certificate").addEventListener("click", async () => {
  console.log("Certificate button clicked", lastReport);
  if (!lastReport || !lastReport.pass) { console.log("No report or didn't pass"); return; }
  
  try {
    console.log("Starting certificate generation...");
    const doc = new jsPDF({ orientation:'l', unit:'mm', format:'a4' });
    console.log("jsPDF created");
    
    const [logo, academy, sign] = await Promise.all([toDataURL(branding.logoUrl), toDataURL(branding.academyUrl), toDataURL(branding.signatureUrl)]);
    console.log("Images loaded", {logo: !!logo, academy: !!academy, sign: !!sign});

  doc.setDrawColor(240,89,34); doc.setLineWidth(3);  doc.rect(10,10,277,187);
  doc.setDrawColor(200,200,200); doc.setLineWidth(0.6); doc.rect(16,16,265,175);

  // Add your full logo back in top-left (no distortion)
  if (logo) { const logoDims=await getImgDims(logo); const logoFitted=fitWithin(logoDims.w,logoDims.h,50,20);
    doc.addImage(logo,'PNG',22,22,logoFitted.w,logoFitted.h); }
  
  
  if (academy) doc.addImage(academy,'PNG',290-42,22,20,20);

  doc.setFont('times','bold'); doc.setFontSize(30); doc.text('Certificate of Achievement',148.5,72,{align:'center'});
  doc.setFont('times','normal'); doc.setFontSize(14); doc.text('This certifies that',148.5,88,{align:'center'});
  doc.setFont('times','bold'); doc.setFontSize(26); doc.text(lastReport.name||'Student',148.5,104,{align:'center'});
  doc.setFont('times','normal'); doc.setFontSize(14); doc.text('has successfully passed',148.5,120,{align:'center'});
  doc.setFont('times','bold'); doc.setFontSize(20); doc.text(quizConfig.moduleTitle,148.5,136,{align:'center'});
  doc.setFont('times','normal'); doc.setFontSize(13);
  doc.text(`with a score of ${lastReport.percent}% (${lastReport.correct}/${lastReport.total}) on ${formatDate(new Date(lastReport.timestamp))}.`,148.5,150,{align:'center'});
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text('Alan Ranger Photography Academy — Beginners Modules included',148.5,160,{align:'center'});

  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  doc.text('Instructor: Alan Ranger',22,172);
  const siteText='Website: alanranger.com'; doc.text(siteText,22,180); doc.link(22,176,doc.getTextWidth(siteText),6,{url:branding.siteUrl});

  const sigLineY=184;
  if (sign){ const dims=await getImgDims(sign); const fitted=fitWithin(dims.w,dims.h,130,50);
    const x=290-22-fitted.w; const y=sigLineY-fitted.h+8; doc.addImage(sign,'PNG',x,y,fitted.w,fitted.h); }
  doc.setDrawColor(240,89,34); doc.setLineWidth(0.6); doc.line(290-120,sigLineY,290-22,sigLineY);
  doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text('Signature',290-22,sigLineY+6,{align:'right'});

  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text(`Certificate ID: ${slugify(lastReport.moduleId)}-${Date.now()}`,290-16,46,{align:'right'});

  console.log("About to save certificate...");
  doc.save(`${slugify(lastReport.moduleId)}-certificate-${Date.now()}.pdf`);
  console.log("Certificate saved successfully!");
  
  } catch (error) {
    console.error("Error generating certificate:", error);
    alert("Error generating certificate: " + error.message);
  }
});
</script>
