<!--
Academy Login — Squarespace Code Block (v4.0 - NO Planless Signup Possible)
Page: /academy/login

CORE CHANGE:
- Removed ms.signupMemberEmailPassword() entirely.
- Trial signup is now handled by Memberstack's Signup Modal WITH data-ms-price:add="prc_30-day-free-trial-mg18p0u9z".
  This prevents creating a member unless a plan/checkout flow is attached.

Also:
- /academy/login?start=trial auto-opens the trial join modal (and scrolls into view).
- Existing planless members are blocked with a clear message + logout.
- Name Gate still enforces First/Last name for members who DO have a plan.

IDs:
- Trial priceId:  prc_30-day-free-trial-mg18p0u9z
- Annual priceId: prc_annual-membership-jj7y0h89
-->
<div id="arp-academy-login" style="max-width:720px;margin:0 auto;padding:28px 18px;text-align:center;">
  <style>
    :root{
      --arp-orange:#E57200;
      --arp-blue:#2563eb;
      --arp-red-bg:#fdecec;
      --arp-border: rgba(17, 24, 39, 0.14);
      --arp-text:#111827;
      --arp-muted:#6b7280;
    }

    #arp-academy-login{
      border: 1px solid var(--arp-border);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }
    #arp-academy-login:hover{
      transform: translateY(-2px);
      border-color: rgba(229,114,0,0.30);
      box-shadow: 0 18px 46px rgba(17, 24, 39, 0.14);
    }

    #arp-academy-login #arpLoginBtn,
    #arp-academy-login #arpTrialBtn,
    #arp-academy-login #arpAnnualBtn,
    #arp-academy-login #arpNameGate button[type="submit"],
    #arp-academy-login #arpLogoutInlineBtn{
      transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease;
      will-change: transform;
    }
    #arp-academy-login #arpLoginBtn:hover,
    #arp-academy-login #arpLoginBtn:focus-visible,
    #arp-academy-login #arpTrialBtn:hover,
    #arp-academy-login #arpTrialBtn:focus-visible,
    #arp-academy-login #arpAnnualBtn:hover,
    #arp-academy-login #arpAnnualBtn:focus-visible,
    #arp-academy-login #arpNameGate button[type="submit"]:hover,
    #arp-academy-login #arpNameGate button[type="submit"]:focus-visible,
    #arp-academy-login #arpLogoutInlineBtn:hover,
    #arp-academy-login #arpLogoutInlineBtn:focus-visible{
      transform: translateY(-2px) scale(1.02);
      box-shadow: rgba(0,0,0,0.22) 0px 10px 26px;
      outline: none;
    }
    @media (prefers-reduced-motion: reduce){
      #arp-academy-login *{ animation:none !important; }
    }

    #arp-academy-login .arp-warning{
      margin: 18px auto 10px auto;
      padding: 16px 16px 14px 16px;
      border-radius: 14px;
      border: 2px solid rgba(180,35,24,0.55);
      background: var(--arp-red-bg);
      color: #7a1a12;
      font-weight: 900;
      line-height: 1.35;
      text-align: center;
      max-width: 640px;
    }
    #arp-academy-login .arp-warning .arp-warning-sub{
      display:block;
      margin-top: 8px;
      font-weight: 800;
      color:#7a1a12;
      font-size: 15px;
    }
    #arp-academy-login .arp-warning u{ text-underline-offset: 3px; }

    #arp-academy-login #arpStatus{
      display:none;
      margin: 12px auto 0 auto;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(180,35,24,0.35);
      background: rgba(180,35,24,0.08);
      color: #7a1a12;
      font-weight: 800;
      text-align: left;
      max-width: 640px;
    }
    #arp-academy-login #arpStatus.is-visible{ display:block; }
    #arp-academy-login #arpStatus.is-info{
      border-color: rgba(37, 99, 235, 0.28);
      background: rgba(37, 99, 235, 0.07);
      color: #1e3a8a;
      font-weight: 800;
    }

    #arp-academy-login #arpMemberLine{
      display:none;
      margin-top: 10px;
      color: var(--arp-muted);
      font-weight: 700;
      font-size: 13px;
    }
    #arp-academy-login #arpMemberLine.is-visible{ display:block; }

    #arpLogoutInlineBtn{
      display:none;
      margin: 10px auto 0 auto;
      background:#111827;
      color:#fff;
      padding: 10px 16px;
      border:none;
      border-radius: 10px;
      font-weight: 900;
      cursor:pointer;
    }
    #arpLogoutInlineBtn.is-visible{ display:inline-flex; }

    #arpNameGate{
      display:none;
      position:fixed;
      inset:0;
      z-index:999999;
      background:rgba(0,0,0,0.55);
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    #arpNameGate.is-visible{ display:flex; }
    #arpNameGate .gate-card{
      width:100%;
      max-width:520px;
      background:#fff;
      border: 1px solid var(--arp-border);
      border-radius: 16px;
      box-shadow: 0 18px 46px rgba(17, 24, 39, 0.22);
      padding:18px;
      text-align:left;
    }
    #arpNameGate .gate-title{ font-size:20px; font-weight:900; margin:0 0 6px 0; color:var(--arp-text); }
    #arpNameGate .gate-sub{ font-size:14px; font-weight:800; margin:0 0 14px 0; color:var(--arp-muted); }
    #arpNameGate .gate-row{ margin-bottom:14px; }
    #arpNameGate label{ display:block; margin-bottom:6px; font-weight:900; font-size:13px; color:var(--arp-text); }
    #arpNameGate input{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:10px;
      font-size:15px;
      box-sizing:border-box;
      background:#fff;
    }
    #arpNameGate input:focus{
      outline:none;
      border-color: var(--arp-orange);
      box-shadow: 0 0 0 3px rgba(229,114,0,0.14);
    }
    #arpNameGate button[type="submit"]{
      width:100%;
      background: var(--arp-orange);
      color:#fff;
      padding:14px 18px;
      border:none;
      border-radius:12px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      box-shadow: rgba(0,0,0,0.18) 0px 2px 6px;
    }
    #arpNameGate .gate-error{
      display:none;
      margin-top:10px;
      padding:10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #dc2626;
      font-weight:900;
      font-size:13px;
    }
    #arpNameGate .gate-error.is-visible{ display:block; }
  </style>

  <h1 style="margin:0 0 10px 0;font-size:34px;letter-spacing:.5px;">Academy Login / Join</h1>
  <p style="margin:0 0 10px 0;color:#555;font-size:16px;line-height:1.6;">
    Log in to access your modules, exams, downloads, practice packs, and membership status.
  </p>

  <div style="display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:8px;">
    <!-- Existing members only -->
    <button
      id="arpLoginBtn"
      type="button"
      data-ms-modal="login"
      aria-label="Log in to the Academy"
      style="background:var(--arp-orange);color:#fff;padding:14px 34px;border:none;border-radius:10px;font-weight:900;font-size:16px;line-height:1.2;cursor:pointer;box-shadow:rgba(0,0,0,0.18) 0px 2px 6px;display:inline-flex !important;align-items:center;justify-content:center;min-width:180px;opacity:1 !important;visibility:visible !important;pointer-events:auto !important;position:relative !important;z-index:9999 !important;"
    >
      Log in
    </button>

    <!-- Trial join MUST include plan (price add) -->
    <button
      id="arpTrialBtn"
      type="button"
      data-ms-modal="signup"
      data-ms-price:add="prc_30-day-free-trial-mg18p0u9z"
      aria-label="Start 30-Day Free Trial"
      style="background:var(--arp-blue);color:#fff;padding:14px 34px;border:none;border-radius:10px;font-weight:900;font-size:16px;line-height:1.2;cursor:pointer;box-shadow:rgba(0,0,0,0.18) 0px 2px 6px;display:inline-flex;align-items:center;justify-content:center;min-width:180px;"
    >
      Start 30-Day Free Trial
    </button>

    <!-- Annual join already attaches plan -->
    <button
      id="arpAnnualBtn"
      type="button"
      data-ms-modal="signup"
      data-ms-price:add="prc_annual-membership-jj7y0h89"
      style="background:var(--arp-orange);color:#fff;padding:14px 34px;border:none;border-radius:10px;font-weight:900;font-size:16px;line-height:1.2;cursor:pointer;box-shadow:rgba(0,0,0,0.18) 0px 2px 6px;display:inline-flex;align-items:center;justify-content:center;min-width:180px;"
    >
      Annual Membership
    </button>
  </div>

  <div class="arp-warning" role="note" aria-label="Trial activation notice">
    IMPORTANT: Your trial is <u>only activated</u> after you complete the £0 Stripe checkout.
    <br/>If you close or leave the checkout window, your plan will NOT be created and you will NOT have Academy access.
    <span class="arp-warning-sub">Reassurance: no card details are required for the trial — you must still complete the £0 checkout.</span>
    <span class="arp-warning-sub" style="display:block;margin-top:8px;">You can cancel anytime — there is no obligation and you can cancel before your trial ends or let your account expire. No charge will be made automatically on a free trial plan.</span>
  </div>

  <div id="arpStatus"></div>

  <div id="arpMemberLine"></div>
  <button id="arpLogoutInlineBtn" type="button" aria-label="Log out">Log out</button>

  <div style="margin-top:14px;color:#666;font-size:14px;line-height:1.6;">
    Forgot your password? Use <strong>"Forgot Password"</strong> in the login form.
  </div>
</div>

<div
  id="arpNameGate"
  aria-hidden="true"
  style="display:none;position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;padding:16px;"
>
  <div class="gate-card">
    <div class="gate-title">Complete your profile</div>
    <div class="gate-sub">Please enter your first and last name to continue.</div>

    <form id="arpNameGateForm" novalidate autocomplete="off">
      <div class="gate-row">
        <label for="arpGateFirstName">First Name</label>
        <input id="arpGateFirstName" type="text" autocomplete="off" required placeholder="First name" />
      </div>
      <div class="gate-row">
        <label for="arpGateLastName">Last Name</label>
        <input id="arpGateLastName" type="text" autocomplete="off" required placeholder="Last name" />
      </div>

      <button type="submit" id="arpGateSaveBtn">Save and continue</button>
      <div class="gate-error" id="arpGateError"></div>
    </form>
  </div>
</div>

<script>
(function () {
  function norm(s){ return (s || "").toString().trim(); }

  // Safety: ensure no "allow signup" attribute exists anywhere (belt-and-braces)
  (function removeAllowSignupAttr(){
    try{
      var els = document.querySelectorAll("[data-ms-social-auth-allow-signup]");
      for (var i=0;i<els.length;i++){
        els[i].removeAttribute("data-ms-social-auth-allow-signup");
      }
    }catch(e){}
  })();

  function showStatus(msg, variant){
    var box = document.getElementById("arpStatus");
    if (!box) return;
    box.textContent = msg;
    box.classList.add("is-visible");
    box.classList.remove("is-info");
    if (variant === "info") box.classList.add("is-info");
  }
  function clearStatus(){
    var box = document.getElementById("arpStatus");
    if (!box) return;
    box.textContent = "";
    box.classList.remove("is-visible");
    box.classList.remove("is-info");
  }

  function waitForMemberstack() {
    return new Promise(function(resolve) {
      if (window.$memberstackDom) return resolve(window.$memberstackDom);
      var attempts = 0, maxAttempts = 60;
      var interval = setInterval(function() {
        attempts++;
        if (window.$memberstackDom) {
          clearInterval(interval);
          resolve(window.$memberstackDom);
        } else if (attempts >= maxAttempts) {
          clearInterval(interval);
          resolve(null);
        }
      }, 200);
    });
  }

  async function getCurrentMemberData(ms){
    var cm = await ms.getCurrentMember().catch(function(){ return null; });
    return cm && cm.data ? cm.data : null;
  }

  function memberHasPlan(member){
    var pcs = member && member.planConnections ? member.planConnections : [];
    return Array.isArray(pcs) && pcs.length > 0;
  }

  async function doLogout(){
    var ms = await waitForMemberstack();
    if (!ms || typeof ms.logout !== "function") {
      window.location.href = "/academy/login?loggedout=1";
      return;
    }
    try { await ms.logout(); } catch (e) {}
    window.location.href = "/academy/login?loggedout=1";
  }

  var logoutBtn = document.getElementById("arpLogoutInlineBtn");
  if (logoutBtn) logoutBtn.addEventListener("click", function(e){ e.preventDefault(); doLogout(); });

  // Name gate (only enforced once a plan exists)
  var gateWrap = document.getElementById("arpNameGate");
  var gateForm = document.getElementById("arpNameGateForm");
  var gateFirst = document.getElementById("arpGateFirstName");
  var gateLast = document.getElementById("arpGateLastName");
  var gateSaveBtn = document.getElementById("arpGateSaveBtn");
  var gateError = document.getElementById("arpGateError");

  function showGateError(message) {
    if (gateError) {
      gateError.textContent = message;
      gateError.classList.add("is-visible");
    }
  }
  function openGate(prefill) {
    if (!gateWrap) return;
    gateError && gateError.classList.remove("is-visible");
    gateWrap.classList.add("is-visible");
    gateWrap.style.display = "flex";
    gateWrap.setAttribute("aria-hidden", "false");
    if (prefill && gateFirst && !gateFirst.value) gateFirst.value = prefill.first || "";
    if (prefill && gateLast && !gateLast.value) gateLast.value = prefill.last || "";
    setTimeout(function(){ gateFirst && gateFirst.focus(); }, 0);
  }
  function closeGate() {
    if (!gateWrap) return;
    gateWrap.classList.remove("is-visible");
    gateWrap.style.display = "none";
    gateWrap.setAttribute("aria-hidden", "true");
  }

  async function enforceNameIfMissing(member) {
    if (!member) return;
    if (!memberHasPlan(member)) return;
    var cf = member.customFields || {};
    var first = norm(cf["first-name"] || cf.firstName || cf.firstname);
    var last  = norm(cf["last-name"]  || cf.lastName  || cf.lastname);
    if (first && last) return;
    openGate({ first:first, last:last });
  }

  if (gateForm) {
    gateForm.addEventListener("submit", async function(e){
      e.preventDefault();
      gateError && gateError.classList.remove("is-visible");

      var first = norm(gateFirst && gateFirst.value);
      var last  = norm(gateLast && gateLast.value);

      if (!first || !last) {
        showGateError("Please enter both your first and last name.");
        return;
      }

      gateSaveBtn.disabled = true;
      gateSaveBtn.textContent = "Saving...";

      try {
        var ms = await waitForMemberstack();
        if (!ms) throw new Error("Memberstack not available.");

        if (typeof ms.updateCurrentMember === "function") {
          await ms.updateCurrentMember({
            customFields: { "first-name": first, "last-name": last }
          });
        }
        closeGate();
        location.reload();
      } catch (err) {
        showGateError("Could not save your name. Please refresh and try again.");
        gateSaveBtn.disabled = false;
        gateSaveBtn.textContent = "Save and continue";
      }
    });
  }

  // Auto-open Trial flow from query param
  (function autoOpenTrialFromQuery(){
    try{
      var qp = new URLSearchParams(window.location.search || "");
      if (qp.get("start") !== "trial") return;
      var btn = document.getElementById("arpTrialBtn");
      if (!btn) return;
      btn.scrollIntoView({ behavior: "smooth", block: "center" });
      setTimeout(function(){ btn.click(); }, 200);
    } catch(e) {}
  })();

  // Show member line + block planless members
  (async function initMemberState(){
    var ms = await waitForMemberstack();
    if (!ms) return;

    var member = await getCurrentMemberData(ms);
    if (!member) {
      // If someone landed here after cancelling checkout, show a nudge (optional)
      var qp = new URLSearchParams(window.location.search || "");
      if (qp.get("trial") === "not-activated") {
        showStatus("Your trial was not activated because the £0 Stripe checkout was not completed. Please try again and complete the checkout (no card details required).");
      }
      return;
    }

    var memberLine = document.getElementById("arpMemberLine");
    if (memberLine) {
      memberLine.textContent = "You are currently logged in as: " + (member.email || "member");
      memberLine.classList.add("is-visible");
    }
    if (logoutBtn) logoutBtn.classList.add("is-visible");

    if (!memberHasPlan(member)) {
      showStatus(
        "Your account exists but no plan is active. This usually happens if checkout was not completed. Please log out, then start the trial again and complete the £0 checkout.",
        "info"
      );
      return;
    }

    clearStatus();
    enforceNameIfMissing(member).catch(function(){});
  })();

})();
</script>
