<!-- Alan Ranger — 15 Camera Settings Modules (Complete Single Page with All Features)
     Paste this single block into a Squarespace Code Block. No external files needed. -->

<div id="ar-container">
  <style>
    :root{
      --ar-orange:#E57200;      /* Brand orange */
      --ar-green:#10b981;       /* Success green */
      --ar-red:#ef4444;         /* Error red */
      --ar-gray:#eaeaea;        /* Soft border gray */
      --ar-text:#1f2937;        /* Primary text */
    }
    #ar-container{max-width:1120px;margin:32px auto;padding:0 12px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ar-text)}
    #ar-container a{color:#2563eb;text-decoration:none}
    #ar-container a:hover{text-decoration:underline}
    
    /* Hide/show sections */
    #ar-modgrid, #ar-quiz { display: block; }
    #ar-quiz { display: none; }

    /* Header + Summary row */
    #ar-modgrid .top{
      display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;margin:8px 0 18px
    }
    #ar-modgrid h2{margin:0;font-size:36px;line-height:1.2;font-weight:800}

    /* Summary box */
    #ar-modgrid .summary{
      min-width:380px;max-width:560px;
      border:1px solid var(--ar-gray);border-radius:12px;background:#fff;padding:12px 14px;box-shadow:0 1px 4px rgba(0,0,0,.06)
    }
    #ar-modgrid .summary h3{margin:0 0 6px 0;font-size:18px;font-weight:800}
    #ar-modgrid .progressline{display:flex;justify-content:space-between;align-items:center;margin:0 0 6px 0}
    #ar-modgrid .progressline .stat{font-weight:800}
    #ar-modgrid .track{margin-top:8px;height:10px;border-radius:999px;background:#f2f2f2;overflow:hidden}
    #ar-modgrid .bar{height:100%;width:0;background:var(--ar-orange);transition:width .4s ease;border-radius:999px}

    /* Auth row stretches horizontally */
    #ar-modgrid .auth{
      display:grid;
      grid-template-columns:auto 1fr auto auto; /* badge | email grows | magic | sign out */
      align-items:center;gap:8px;margin-top:10px
    }
    #ar-modgrid .badge{padding:6px 10px;border:1px solid var(--ar-gray);border-radius:999px;background:#fff;font-weight:600}
    #ar-modgrid input[type="email"]{
      width:100%;min-width:180px;padding:8px 10px;border:1px solid #ddd;border-radius:10px
    }
    #ar-modgrid .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:10px;border:1px solid var(--ar-orange);background:var(--ar-orange);color:#fff;
      font-weight:700;cursor:pointer;text-decoration:none;white-space:nowrap
    }
    /* smaller buttons used inside each card */
    #ar-modgrid .btn.sm{padding:7px 12px;border-radius:8px;font-size:14px}
    #ar-modgrid .btn.secondary{background:#fff;color:var(--ar-orange)}
    #ar-modgrid .hint{margin-top:8px;color:#444;font-size:14px}

    /* Masonry grid */
    #ar-modgrid .grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px
    }
    @media (max-width:980px){ #ar-modgrid .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:640px){
      #ar-modgrid .top{grid-template-columns:1fr}
      #ar-modgrid .grid{grid-template-columns:1fr}
      #ar-modgrid .summary{max-width:none}
    }

    /* Cards */
    #ar-modgrid .card{
      position:relative;background:#fff;border:1px solid var(--ar-gray);border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.05);
      overflow:hidden
    }
    #ar-modgrid .card::before{
      content:"";position:absolute;left:0;top:0;bottom:0;width:8px;background:var(--ar-orange)
    }
    #ar-modgrid .head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    #ar-modgrid .num{min-width:28px;height:28px;border-radius:999px;background:rgba(229,114,0,.12);color:#793d00;display:inline-flex;align-items:center;justify-content:center;font-weight:800}
    #ar-modgrid .title{font-weight:800;font-size:18px}

    /* CENTER the score/pass chips and place directly above buttons */
    #ar-modgrid .chips{
      display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;margin:4px 0 10px 0;text-align:center
    }
    #ar-modgrid .chip{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--ar-gray);background:#fff;font-size:14px
    }
    #ar-modgrid .chip.pass{background:#f6fffa;border-color:#b7f0d2;color:#067647}
    #ar-modgrid .chip.fail{background:#fff5f5;border-color:#fac5c5;color:#b42318}

    /* Centered small buttons */
    #ar-modgrid .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:4px}

    /* Status overlays */
    #ar-modgrid .card.passed{background:#f4fbf7}
    #ar-modgrid .card.failed{background:#fff7f7}
    #ar-modgrid .tick{position:absolute;right:12px;top:12px;width:28px;height:28px;border-radius:999px;background:#e6fff4;border:1px solid #b7f0d2;color:#067647;font-weight:900;display:flex;align-items:center;justify-content:center}
    #ar-modgrid .xmark{position:absolute;right:12px;top:12px;width:28px;height:28px;border-radius:999px;background:#ffecec;border:1px solid #f8caca;color:#b42318;font-weight:900;display:flex;align-items:center;justify-content:center}

    /* Toast */
    #ar-modgrid .toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);z-index:99999;background:#111;color:#fff;
      padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);display:none}
    #ar-modgrid .toast.ok{background:var(--ar-green)} #ar-modgrid .toast.err{background:var(--ar-red)}
  </style>

  <!-- Grid Section -->
  <div id="ar-modgrid">
    <div class="top">
      <h2>15 Camera Settings — Modules</h2>

      <!-- Summary / progress / auth -->
      <div class="summary" id="summary">
        <div class="progressline">
          <div class="stat"><span id="passedCount">0</span>/15 Passed</div>
          <div class="stat"><span id="progressPct">0</span>%</div>
        </div>
        <div class="track"><div class="bar" id="progressBar"></div></div>

        <div class="auth">
          <span class="badge" id="authBadge">Not signed in</span>
          <input id="loginEmail" type="email" placeholder="you@example.com" />
          <button class="btn" id="gridBtnMagic">Get magic link</button>
          <button class="btn secondary" id="gridBtnSignOut" style="display:none">Sign out</button>
        </div>
        <div class="hint">Use "Get magic link" to load your saved progress before taking an exam.</div>
      </div>
    </div>

    <!-- Grid container -->
    <div class="grid" id="grid"></div>

    <div class="toast" id="toast"></div>
    
    <!-- Results Modal -->
    <div id="resultsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100000; align-items:center; justify-content:center;">
      <div style="background:#fff; border-radius:12px; padding:24px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 id="modalTitle" style="margin:0; font-size:20px; font-weight:800;"></h3>
          <button onclick="closeResults()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
        </div>
        <div id="modalContent"></div>
        <div style="margin-top:20px; text-align:center;">
          <button onclick="closeResults()" class="btn secondary">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Section (hidden by default) -->
  <div id="ar-quiz" style="border:1px solid #eaeaea;border-left:10px solid #F05922;background:#fafafa;padding:24px;border-radius:12px;max-width:820px;margin:28px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">
    <style>
      #ar-quiz a { color:#2563eb !important; text-decoration:none; }
      #ar-quiz a:hover { text-decoration:underline; }
      #ar-toast{ position:fixed; z-index:99999; left:50%; top:22px; transform:translateX(-50%);
        background:#111; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.15); display:none; max-width:90vw; font-size:14px; line-height:1.35; text-align:center; }
      #ar-toast.success{ background:#10b981; } #ar-toast.error{ background:#ef4444; } #ar-toast.info{ background:#2563eb; }
      .ar-field{ border:1px solid #eaeaea;background:#fff;border-radius:10px;padding:14px;margin:12px 0; }
      .ar-qtxt{ font-weight:800;margin:0 0 8px; color:#F05922; }
      .ar-opt{ display:flex; gap:10px; align-items:flex-start; margin:8px 0; cursor:pointer; }
      #results .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; }
      #results .pill-pass { background:#e8fff4; color:#067647; border:1px solid #b7f0d2; }
      #results .pill-fail { background:#fff5f5; color:#b42318; border:1px solid #fac5c5; }
      #ar-auth { display:flex; align-items:center; gap:10px; margin:0 0 8px; color:#555; font-size:14px; flex-wrap:wrap; }
      #ar-auth .badge { padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; }
      #ar-auth .mini-btn { background:#fff; color:#333; border:1px solid #ddd; border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px; }
      #ar-auth .mini-btn:disabled { opacity:.6; cursor:not-allowed; }
      #ar-status { margin:6px 0 0; font-size:14px; color:#111; }
      .muted { color:#6b7280; }
      input[type="radio"] { accent-color:#F05922; }
      input[type="radio"]:checked { accent-color:#F05922; }
    </style>

    <div id="ar-auth">
      <span id="ar-auth-status" class="badge">Not signed in</span>
      <span id="ar-auth-email"></span>
      <button id="btn-magic" type="button" class="mini-btn" style="background:#F05922;color:#fff;border-color:#F05922;">Send magic link</button>
      <button id="btn-clear" type="button" class="mini-btn" style="background:#6b7280;color:#fff;border-color:#6b7280;">Clear results / Sign out</button>
    </div>
    <div style="font-size:12px;color:#6b7280;margin:8px 0 16px 0;padding:8px;background:#f9f9f9;border-radius:6px;">
      <strong>Magic link:</strong> Enter your email and click "Send magic link" to receive a secure login link. No password needed. 
      <strong>Clear results:</strong> Use this to sign out and reset the quiz so you can retake it.
    </div>

    <h2 id="quiz-title" style="margin:0 0 12px;font-weight:700;line-height:1.2;">Module 1 Assessment: What is Exposure</h2>
    <p style="margin:0 0 16px;color:#333;">Enter your details, answer the questions, then view your score. Download your results as a PDF. If you pass, you can also download a personalised certificate.</p>

    <!-- Learner details -->
    <form id="learner-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 20px;">
      <div>
        <label for="name" style="display:block;font-weight:600;margin-bottom:6px;">Name</label>
        <input id="name" name="name" type="text" required placeholder="Your name"
               style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      </div>
      <div>
        <label for="email" style="display:block;font-weight:600;margin-bottom:6px;">Email (for saving progress)</label>
        <input id="email" name="email" type="email" placeholder="you@example.com"
               style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
        <div id="ar-status"></div>
      </div>
    </form>

    <!-- Assessment -->
    <form id="quiz-form" novalidate></form>

    <!-- Actions -->
    <div id="quiz-actions" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:16px;">
      <button id="btn-submit" type="button"
              style="background:#F05922;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Submit answers</button>
      <button id="btn-retake" type="button" style="display:none;"
              style="background:#dc2626;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Retake test</button>
      <button id="btn-pdf" type="button" disabled
              style="background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download results (PDF)</button>
      <button id="btn-certificate" type="button" disabled
              style="background:#10b981;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download certificate (PDF)</button>
      <button id="btn-save" type="button" disabled
              style="background:#111827;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Save to my account</button>
    </div>

    <!-- Results -->
    <div id="results" style="margin-top:20px;display:none;background:#fff;border:1px solid #eaeaea;border-radius:10px;padding:16px;">
      <h3 style="margin:0 0 10px;font-size:18px;">Your results</h3>
      <div id="results-summary" style="margin-bottom:12px;"></div>
      <div id="results-compact" class="muted" style="font-size:13px;"></div>
      <div id="results-feedback" style="margin-top:8px;"></div>
    </div>

    <div id="ar-toast" role="status" aria-live="polite"></div>
    
    <!-- Back to Modules Button -->
    <div style="text-align:center; margin-top:24px; padding-top:16px; border-top:1px solid #eaeaea;">
      <button onclick="showGrid()" 
         style="display:inline-block; background:#6b7280; color:#fff; text-decoration:none; padding:12px 20px; border-radius:10px; font-weight:700; border:none; cursor:pointer;">
        ← Back to Modules
      </button>
    </div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Wait for DOM to be fully loaded and avoid conflicts with Squarespace
document.addEventListener('DOMContentLoaded', function() {
  // Additional delay to ensure Squarespace scripts are loaded
  setTimeout(function() {
    try {
      (function(){
        /* =============================
           CONFIG
        ==============================*/
        const SUPABASE_URL = "https://dqrtcsvqsfgbqmnonkpt.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxcnRjc3Zxc2ZnYnFtbm9ua3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTA4MjUsImV4cCI6MjA3MjU2NjgyNX0.e19j8NOUK5HWoTGZv4B62U_n0je_19Tp-F20qKGbWDk";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const branding = {
          orange:"#F05922",
          logoUrl:"https://www.alanranger.com/s/ALAN-RANGER-LOGO-and-Icon-BLACK.png",
          academyUrl:"https://www.alanranger.com/s/alan-ranger-photography-academy-logo.png",
          signatureUrl:"https://www.alanranger.com/s/Alan-Ranger-black-high-res.png",
          courseUrl:"https://www.alanranger.com/online-photography-course",
          exposureUrl:"https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography",
          siteUrl:"https://alanranger.com"
        };

        /* =============================
           DOM refs
        ==============================*/
        const gridEl = document.getElementById('grid');
        const toastEl = document.getElementById('toast');
        const authBadge = document.getElementById('authBadge');
        const emailInput = document.getElementById('loginEmail');
        const gridBtnMagic = document.getElementById('gridBtnMagic');
        const gridBtnSignOut = document.getElementById('gridBtnSignOut');
        const progressBar = document.getElementById('progressBar');
        const passedCountEl = document.getElementById('passedCount');
        const progressPctEl = document.getElementById('progressPct');

        // Check if essential elements exist
        if (!gridEl) {
          console.error('Grid element not found!');
          return;
        }

        /* =============================
           Utilities
        ==============================*/
        const showToast = (msg, type="ok", ms=3800) => {
          if (toastEl) {
            toastEl.textContent = msg;
            toastEl.className = `toast ${type === "ok" ? "ok" : "err"}`;
            toastEl.style.display = 'block';
            clearTimeout(showToast._t);
            showToast._t = setTimeout(()=> toastEl.style.display='none', ms);
          }
        };

        const debounce60 = (() => {
          let last = 0;
          return () => {
            const now = Date.now();
            if (now - last < 60000) return false;
            last = now; return true;
          };
        })();

        const setAuthUI = (user) => {
          if (user) {
            authBadge.textContent = "Signed in";
            gridBtnSignOut.style.display = '';
            if (!emailInput.value) emailInput.value = user.email || '';
          } else {
            authBadge.textContent = "Not signed in";
            gridBtnSignOut.style.display = 'none';
          }
        };

        /* =============================
           Auth / Magic Link
        ==============================*/
        gridBtnMagic.addEventListener('click', async () => {
          const email = emailInput.value.trim();
          if (!email){ showToast('Enter your email address first.', 'err'); return; }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showToast('Please enter a valid email address.', 'err'); return; }
          if (!debounce60()){ showToast('Use the link we just sent, or try again in ~60s.', 'err'); return; }

          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: window.location.href.split('#')[0] }
          });
          if (error){ showToast('Could not send sign-in link.', 'err'); console.error(error); }
          else { showToast('Magic link sent — check your inbox.', 'ok', 5200); }
        });

        gridBtnSignOut.addEventListener('click', async ()=>{
          await supabase.auth.signOut();
          setAuthUI(null);
          renderSummary({});
          renderGrid({});
          showToast('Signed out.', 'ok');
        });

        supabase.auth.onAuthStateChange(async (_evt, session)=>{
          const user = session?.user || null;
          setAuthUI(user);
          const status = await fetchStatusForUser(user);
          renderSummary(status);
          renderGrid(status);
        });

        /* =============================
           Progress fetch & summary
        ==============================*/
        async function fetchStatusForUser(user){
          if(!user) return {};
          const { data, error } = await supabase
            .from('module_results')
            .select('module_id, score_percent, passed, created_at')
            .eq('user_id', user.id)
            .order('created_at', { ascending:false });

          if (error || !data) return {};

          // Reduce to latest per module_id
          const latest = {};
          for (const row of data){
            if (!latest[row.module_id]) latest[row.module_id] = {score: row.score_percent, passed: row.passed, when: row.created_at};
          }
          return latest;
        }

        function renderSummary(statusByModuleId){
          const total = 15; // modules.length
          const passed = Object.values(statusByModuleId).filter(s => s.passed === true).length;
          passedCountEl.textContent = String(passed);
          const pct = Math.round((passed/total)*100);
          progressPctEl.textContent = String(pct);
          progressBar.style.width = pct + '%';
        }

        /* =============================
           Render Grid (dynamic)
        ==============================*/
        function renderGrid(statusByModuleId = {}) {
          gridEl.innerHTML = '';
          
          const modules = [
            {id:"module-01-exposure", n:1, title:"What is Exposure", article:"https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography"},
            {id:"module-02-aperture", n:2, title:"Aperture", article:"https://www.alanranger.com/blog-on-photography/what-is-aperture-in-photography"},
            {id:"module-03-shutter", n:3, title:"Shutter Speed", article:"https://www.alanranger.com/blog-on-photography/what-is-shutter-speed"},
            {id:"module-04-iso", n:4, title:"ISO", article:"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography"},
            {id:"module-05-manual", n:5, title:"Manual Exposure", article:"https://www.alanranger.com/blog-on-photography/what-is-manual-exposure-in-photography"},
            {id:"module-06-metering", n:6, title:"Metering", article:"https://www.alanranger.com/blog-on-photography/what-is-metering-in-photography"},
            {id:"module-07-bracketing", n:7, title:"Exposure Bracketing", article:"https://www.alanranger.com/blog-on-photography/exposure-bracketing-a-guide-for-photographers"},
            {id:"module-08-focusing", n:8, title:"Focusing", article:"https://www.alanranger.com/blog-on-photography/what-is-focus-in-photography"},
            {id:"module-09-dof", n:9, title:"Depth of Field", article:"https://www.alanranger.com/blog-on-photography/what-is-depth-of-field"},
            {id:"module-10-drange", n:10, title:"Dynamic Range", article:"https://www.alanranger.com/blog-on-photography/what-is-dynamic-range-in-photography"},
            {id:"module-11-wb", n:11, title:"White Balance", article:"https://www.alanranger.com/blog-on-photography/what-is-white-balance-in-photography"},
            {id:"module-12-drive", n:12, title:"Camera Drive Modes", article:"https://www.alanranger.com/blog-on-photography/what-are-camera-drive-modes"},
            {id:"module-13-jpeg-raw", n:13, title:"JPEG vs RAW", article:"https://www.alanranger.com/blog-on-photography/jpeg-vs-raw-the-key-differences"},
            {id:"module-14-sensors", n:14, title:"Full Frame vs Crop Sensor", article:"https://www.alanranger.com/blog-on-photography/full-frame-vs-cropped-sensor"},
            {id:"module-15-focal", n:15, title:"Focal Length", article:"https://www.alanranger.com/blog-on-photography/what-is-focal-length-in-photography"}
          ];

          modules.forEach(m => {
            const st = statusByModuleId[m.id]; // {score, passed}
            const passed = st?.passed === true;
            const failed = st && st.passed === false;

            const card = document.createElement('div');
            card.className = `card${passed ? ' passed' : ''}${failed ? ' failed' : ''}`;

            const head = document.createElement('div');
            head.className = 'head';
            head.innerHTML = `<div class="num">${m.n}</div><div class="title">${m.title}</div>`;
            card.appendChild(head);

            if (passed) {
              const tick = document.createElement('div'); tick.className='tick'; tick.textContent='✓'; card.appendChild(tick);
            } else if (failed) {
              const x = document.createElement('div'); x.className='xmark'; x.textContent='✕'; card.appendChild(x);
            }

            const chips = document.createElement('div');
            chips.className = 'chips';
            const scoreTxt = (typeof st?.score === 'number') ? `${st.score}%` : '—';
            chips.innerHTML = `
              <span class="chip">Score: <strong>${scoreTxt}</strong></span>
              <span class="chip">Pass ≥ <strong>80%</strong></span>
              ${passed ? `<span class="chip pass">Passed</span>` : (failed ? `<span class="chip fail">Failed</span>` : '')}
            `;
            card.appendChild(chips);

            const actions = document.createElement('div');
            actions.className = 'actions';
            
            if (passed || failed) {
              // Completed exam - show results and retake options
              actions.innerHTML = `
                <a class="btn sm" href="${m.article}" target="_blank" rel="noopener">Open module</a>
                <button class="btn sm secondary" onclick="showResults('${m.id}', '${m.title}', ${st?.score || 0}, ${st?.passed || false})">View Results</button>
                <button class="btn sm secondary" onclick="showQuiz('${m.id}')">Retake Exam</button>
              `;
            } else {
              // Not started - show take exam
              actions.innerHTML = `
                <a class="btn sm" href="${m.article}" target="_blank" rel="noopener">Open module</a>
                <button class="btn sm secondary" onclick="showQuiz('${m.id}')">Take exam</button>
              `;
            }
            
            card.appendChild(actions);
            gridEl.appendChild(card);
          });
        }

        // Results modal functions
        window.showResults = (moduleId, moduleTitle, score, passed) => {
          const modal = document.getElementById('resultsModal');
          const modalTitle = document.getElementById('modalTitle');
          const modalContent = document.getElementById('modalContent');
          
          modalTitle.textContent = `${moduleTitle} - Results`;
          
          const passStatus = passed ? 'Passed' : 'Failed';
          const statusColor = passed ? '#067647' : '#b42318';
          const statusBg = passed ? '#f6fffa' : '#fff5f5';
          
          modalContent.innerHTML = `
            <div style="text-align:center; margin-bottom:20px;">
              <div style="font-size:48px; font-weight:800; color:${statusColor}; margin-bottom:8px;">${score}%</div>
              <div style="padding:8px 16px; border-radius:999px; background:${statusBg}; color:${statusColor}; font-weight:700; display:inline-block;">
                ${passStatus}
              </div>
            </div>
            
            <div style="background:#f9f9f9; padding:16px; border-radius:8px; margin-bottom:20px;">
              <div style="margin-bottom:8px;"><strong>Module:</strong> ${moduleTitle}</div>
              <div style="margin-bottom:8px;"><strong>Score:</strong> ${score}%</div>
              <div style="margin-bottom:8px;"><strong>Status:</strong> ${passStatus}</div>
              <div><strong>Pass Mark:</strong> 80%</div>
            </div>
            
            <div style="text-align:center;">
              <button onclick="downloadResultsPDF('${moduleId}')" class="btn sm" style="margin:4px;">Download Results PDF</button>
              ${passed ? `<button onclick="downloadCertificate('${moduleId}')" class="btn sm" style="margin:4px;">Download Certificate</button>` : ''}
            </div>
          `;
          
          modal.style.display = 'flex';
        };

        window.closeResults = () => {
          document.getElementById('resultsModal').style.display = 'none';
        };

        // Placeholder functions for PDF downloads
        window.downloadResultsPDF = (moduleId) => {
          showToast('Results PDF download will be available from the exam page.', 'ok');
        };

        window.downloadCertificate = (moduleId) => {
          showToast('Certificate download will be available from the exam page.', 'ok');
        };

        /* =============================
           View Switching
        ==============================*/
        function showGrid() {
          document.getElementById('ar-modgrid').style.display = 'block';
          document.getElementById('ar-quiz').style.display = 'none';
          window.history.pushState({}, '', window.location.pathname);
        }

        function showQuiz(moduleId) {
          document.getElementById('ar-modgrid').style.display = 'none';
          document.getElementById('ar-quiz').style.display = 'block';
          window.history.pushState({}, '', window.location.pathname + '?m=' + encodeURIComponent(moduleId));
          
          // Load the specific module quiz
          loadModuleQuiz(moduleId);
        }

        // Check URL parameters on load
        function checkUrlParams() {
          const urlParams = new URLSearchParams(window.location.search);
          const moduleId = urlParams.get('m');
          
          if (moduleId) {
            showQuiz(moduleId);
          } else {
            showGrid();
          }
        }

        /* =============================
           Quiz Functionality
        ==============================*/
        // Module 1 Quiz Configuration (12 questions)
        const module1Config = {
          moduleId:"module-01-exposure",
          moduleTitle:"Module 1: What is Exposure",
          passMarkPercent:80,
          questions:[
            { id:"q1", text:"What does the term exposure mean in photography?", options:[
              "Collecting the correct quantity of light for proper image brightness",
              "Collecting quality of light to capture the image",
              "Using autofocus to make the image sharp",
              "Ensuring the colour is right in the image"
            ], correctIndex:0, reviewHint:"Review the 'What is Exposure' definition section."},
            { id:"q2", text:"What 3 variables control exposure?", options:[
              "Aperture, Shutter Speed, ISO","The lens, Colour, Focusing","White Balance, Focus, Metering","Histogram, Composition, Lighting"
            ], correctIndex:0, reviewHint:"See the Exposure Triangle section (Aperture, Shutter Speed, ISO)."},
            { id:"q3", text:"What does the aperture control in photography?", options:[
              "Colour enhancement","Depth of Field","Shutter Speed","ISO"
            ], correctIndex:1, reviewHint:"See aperture section - aperture controls depth of field."},
            { id:"q4", text:"What does the shutter control in photography?", options:[
              "Colour and saturation","Length of exposure time","Sharpness of moving subjects","ISO"
            ], correctIndex:1, reviewHint:"Check shutter speed section - shutter controls exposure time."},
            { id:"q5", text:"What does the ISO control in photography?", options:[
              "Amount of digital noise (grain)","Image sharpness","Aperture","Shutter speed"
            ], correctIndex:0, reviewHint:"Review ISO section - ISO controls sensor sensitivity and noise."},
            { id:"q6", text:"If an image appears too dark, it is considered:", options:[
              "Overexposed","Underexposed","Correctly exposed","High contrast"
            ], correctIndex:1, reviewHint:"Check 'Underexposure vs Overexposure' with examples."},
            { id:"q7", text:"If an image appears too bright with lost highlight details, it is:", options:[
              "Overexposed","Underexposed","Correctly exposed","Low contrast"
            ], correctIndex:0, reviewHint:"Review overexposure effects - washed out highlights."},
            { id:"q8", text:"Why might a photographer deliberately over/underexpose?", options:[
              "To save battery life","To test different metering modes","To achieve a creative effect or mood","To avoid using ISO"
            ], correctIndex:2, reviewHint:"See 'Creative exposure choices' and examples."},
            { id:"q9", text:"What is the main purpose of the histogram?", options:[
              "To show camera battery level","To display image composition","To reveal exposure clipping in highlights/shadows","To show autofocus points"
            ], correctIndex:2, reviewHint:"See histogram section - it shows tonal distribution and clipping."},
            { id:"q10", text:"Exposure compensation (+/-) is used to:", options:[
              "Change the camera's metering mode","Quickly correct metering bias","Adjust the ISO setting","Change the aperture size"
            ], correctIndex:1, reviewHint:"Review exposure compensation section - quick correction for metering bias."},
            { id:"q11", text:"If you increase shutter speed without changing other settings, the image will:", options:[
              "Become darker","Become brighter","Stay the same brightness","Increase in depth of field"
            ], correctIndex:0, reviewHint:"Revisit 'Shutter speed and exposure' cause/effect."},
            { id:"q12", text:"The exposure triangle demonstrates that:", options:[
              "All three settings work independently","Changing one setting requires adjusting others to maintain exposure","Only aperture affects brightness","ISO is the most important setting"
            ], correctIndex:1, reviewHint:"See exposure triangle section - the three settings work together."}
          ],
          feedbackMap:{
            topics:[
              { key:"exposure-basics",label:"Exposure basics (definition)" },
              { key:"exposure-triangle",label:"The Exposure Triangle (Aperture, Shutter, ISO)" },
              { key:"aperture-control",label:"What aperture controls" },
              { key:"shutter-control",label:"What shutter controls" },
              { key:"iso-control",label:"What ISO controls" },
              { key:"under-over",label:"Underexposed vs Overexposed" },
              { key:"creative-exposure",label:"Creative exposure choices" },
              { key:"histogram",label:"Using the histogram for exposure" },
              { key:"exposure-compensation",label:"Exposure compensation" },
              { key:"triangle-relationships",label:"Exposure triangle relationships" }
            ],
            questionTopics:{ 
              q1:["exposure-basics"], 
              q2:["exposure-triangle"], 
              q3:["aperture-control"], 
              q4:["shutter-control"], 
              q5:["iso-control"], 
              q6:["under-over"], 
              q7:["under-over"], 
              q8:["creative-exposure"], 
              q9:["histogram"], 
              q10:["exposure-compensation"], 
              q11:["triangle-relationships"], 
              q12:["triangle-relationships"] 
            },
            topicLinks:{
              "exposure-basics":branding.exposureUrl,
              "exposure-triangle":branding.exposureUrl + "#exposure-triangle",
              "aperture-control":branding.exposureUrl + "#aperture",
              "shutter-control":branding.exposureUrl + "#shutter",
              "iso-control":branding.exposureUrl + "#iso",
              "under-over":branding.exposureUrl + "#over-under",
              "creative-exposure":branding.exposureUrl + "#creative",
              "histogram":branding.exposureUrl + "#histogram",
              "exposure-compensation":branding.exposureUrl + "#compensation",
              "triangle-relationships":branding.exposureUrl + "#exposure-triangle"
            }
          }
        };

        let currentQuizConfig = null;
        let lastReport = null;

        function loadModuleQuiz(moduleId) {
          // For now, only Module 1 is implemented
          if (moduleId === 'module-01-exposure') {
            currentQuizConfig = module1Config;
            document.getElementById('quiz-title').textContent = currentQuizConfig.moduleTitle + ' Assessment';
            renderQuiz();
          } else {
            alert('Module ' + moduleId + ' is not yet implemented. Only Module 1 (Exposure) is available.');
            showGrid();
          }
        }

        function renderQuiz() {
          if (!currentQuizConfig) return;
          
          const quizForm = document.getElementById("quiz-form");
          quizForm.innerHTML = '';
          const frag = document.createDocumentFragment();
          
          currentQuizConfig.questions.forEach((q, idx) => {
            const field = document.createElement("div"); 
            field.className = "ar-field";
            const qtxt = document.createElement("div"); 
            qtxt.className = "ar-qtxt"; 
            qtxt.textContent = `Q${idx+1}. ${q.text}`;
            field.appendChild(qtxt);
            
            q.options.forEach((opt, i) => {
              const id = `${q.id}-${i}`;
              const label = document.createElement("label"); 
              label.className = "ar-opt"; 
              label.setAttribute("for", id);
              const input = document.createElement("input"); 
              input.type="radio"; 
              input.name=q.id; 
              input.id=id; 
              input.value=i; 
              input.required=true; 
              input.style.cssText="margin-top:4px;";
              const span = document.createElement("span"); 
              span.textContent = opt;
              label.appendChild(input); 
              label.appendChild(span); 
              field.appendChild(label);
            });
            frag.appendChild(field);
          });
          quizForm.appendChild(frag);
        }

        /* =============================
           Quiz Authentication & State
        ==============================*/
        let arUser = null;
        let arPendingResult = null;

        const arToast = document.getElementById('ar-toast');
        const arAuthStatus = document.getElementById('ar-auth-status');
        const arAuthEmail = document.getElementById('ar-auth-email');
        const arBtnMagic = document.getElementById('btn-magic');
        const arBtnClear = document.getElementById('btn-clear');
        const arStatus = document.getElementById('ar-status');

        function arShowToast(msg, type = 'info', ms = 4000) {
          if (!arToast) return;
          arToast.textContent = msg;
          arToast.className = `ar-toast ${type}`;
          arToast.style.display = 'block';
          clearTimeout(arShowToast._t);
          arShowToast._t = setTimeout(() => arToast.style.display = 'none', ms);
        }

        const arDebounce60 = (() => {
          let last = 0;
          return () => {
            const now = Date.now();
            if (now - last < 60000) return false;
            last = now; return true;
          };
        })();

        function arSetAuthUI(user) {
          arUser = user;
          if (user) {
            arAuthStatus.textContent = 'Signed in';
            arAuthEmail.textContent = user.email || '';
            arBtnMagic.disabled = true;
            arBtnMagic.textContent = '✓ Signed in';
          } else {
            arAuthStatus.textContent = 'Not signed in';
            arAuthEmail.textContent = '';
            arBtnMagic.disabled = false;
            arBtnMagic.textContent = 'Send magic link';
          }
        }

        arBtnMagic.addEventListener('click', async () => {
          const email = document.getElementById('email').value.trim();
          if (!email) { arShowToast('Enter your email address first.', 'error'); return; }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { arShowToast('Please enter a valid email address.', 'error'); return; }
          if (!arDebounce60()) { arShowToast('Use the link we just sent, or try again in ~60s.', 'error'); return; }

          const { error } = await supabase.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: window.location.href.split('#')[0] }
          });
          if (error) { arShowToast('Could not send sign-in link.', 'error'); console.error(error); }
          else { arShowToast('Magic link sent — check your inbox.', 'success', 5200); }
        });

        arBtnClear.addEventListener('click', async () => {
          await supabase.auth.signOut();
          arSetAuthUI(null);
          arPendingResult = null;
          arStatus.textContent = '';
          arShowToast('Signed out and results cleared.', 'info');
        });

        supabase.auth.onAuthStateChange(async (_evt, session) => {
          const user = session?.user || null;
          arSetAuthUI(user);
          if (user && arPendingResult) {
            await arAutoSaveQueuedResults();
          }
        });

        /* =============================
           Quiz Submission & Results
        ==============================*/
        async function arSubmitQuiz() {
          if (!currentQuizConfig) return;
          
          const learnerName = document.getElementById("name").value.trim();
          if (!learnerName) { arShowToast("Please enter your name.", 'error'); return; }

          let correct = 0;
          const answers = {};
          currentQuizConfig.questions.forEach((q) => {
            const chosen = document.querySelector(`input[name="${q.id}"]:checked`);
            if (chosen) {
              answers[q.id] = +chosen.value;
              if (+chosen.value === q.correctIndex) correct++;
            }
          });

          const total = currentQuizConfig.questions.length;
          const pct = Math.round((correct / total) * 100);
          const pass = pct >= currentQuizConfig.passMarkPercent;

          lastReport = {
            moduleId: currentQuizConfig.moduleId,
            moduleTitle: currentQuizConfig.moduleTitle,
            learnerName,
            learnerEmail: document.getElementById("email").value.trim(),
            scorePercent: pct,
            passed: pass,
            totalQuestions: total,
            correctAnswers: correct,
            answers,
            submittedAt: new Date().toISOString()
          };

          const passPill = pass ? `<span class="pill pill-pass">Pass</span>` : `<span class="pill pill-fail">Fail</span>`;
          
          document.getElementById('results-summary').innerHTML = `
            <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
              <div style="font-size:28px;font-weight:800;">${pct}%</div>
              <div>${passPill} — ${correct}/${total} correct (Pass mark: ${currentQuizConfig.passMarkPercent}%)</div>
            </div>
            <div style="margin-top:8px;color:#555;">
              <div><strong>Name:</strong> ${learnerName}</div>
              <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
              <div><strong>Module:</strong> ${currentQuizConfig.moduleTitle}</div>
            </div>
          `;

          // Compact results line
          const compactResults = currentQuizConfig.questions.map((q, idx) => {
            const isCorrect = answers[q.id] === q.correctIndex;
            return `Q${idx+1}: ${isCorrect ? 'Correct' : 'Incorrect'}`;
          }).join(' | ');
          document.getElementById('results-compact').textContent = compactResults;

          // Feedback
          const incorrectTopics = new Set();
          currentQuizConfig.questions.forEach((q, idx) => {
            if (answers[q.id] !== q.correctIndex) {
              const topics = currentQuizConfig.feedbackMap.questionTopics[q.id] || [];
              topics.forEach(t => incorrectTopics.add(t));
            }
          });

          if (incorrectTopics.size > 0) {
            const reviewLinks = Array.from(incorrectTopics).map(topicKey => {
              const topic = currentQuizConfig.feedbackMap.topics.find(t => t.key === topicKey);
              const link = currentQuizConfig.feedbackMap.topicLinks[topicKey];
              return `<a href="${link}" target="_blank" rel="noopener">${topic?.label || topicKey}</a>`;
            }).join(', ');
            document.getElementById('results-feedback').innerHTML = `<div style="margin-top:8px;font-size:14px;color:#666;"><strong>Review:</strong> ${reviewLinks}</div>`;
          }

          document.getElementById('results').style.display = 'block';
          
          // Lock radio buttons
          document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.disabled = true;
            radio.style.cursor = 'not-allowed';
          });
          
          // Show/hide buttons
          document.getElementById('btn-submit').style.display = 'none';
          document.getElementById('btn-retake').style.display = 'inline-block';
          document.getElementById('btn-pdf').disabled = false;
          document.getElementById('btn-pdf').style.opacity = '1';
          if (pass) {
            document.getElementById('btn-certificate').disabled = false;
            document.getElementById('btn-certificate').style.opacity = '1';
          }
          document.getElementById('btn-save').disabled = false;
          document.getElementById('btn-save').style.opacity = '1';

          if (pass) {
            arShowToast("Congratulations! You passed this module.", 'success');
            if (window.confetti) {
              confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
          } else {
            arShowToast("You didn't pass this time. Review the material and try again.", 'error');
          }

          // Auto-save if signed in, otherwise queue
          if (arUser) {
            await arSaveResult(lastReport);
          } else {
            arQueueResultForSave(lastReport);
          }
        }

        function arRetakeQuiz() {
          document.getElementById("quiz-form").reset();
          document.getElementById('results').style.display = 'none';
          
          // Unlock radio buttons
          document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.disabled = false;
            radio.style.cursor = 'pointer';
          });
          
          document.getElementById('btn-submit').style.display = 'inline-block';
          document.getElementById('btn-retake').style.display = 'none';
          document.getElementById('btn-pdf').disabled = true;
          document.getElementById('btn-pdf').style.opacity = '.6';
          document.getElementById('btn-certificate').disabled = true;
          document.getElementById('btn-certificate').style.opacity = '.6';
          document.getElementById('btn-save').disabled = true;
          document.getElementById('btn-save').style.opacity = '.6';
          
          // Don't clear name and email fields
          lastReport = null;
        }

        /* =============================
           Save & Queue Logic
        ==============================*/
        function arQueueResultForSave(report) {
          arPendingResult = report;
          arStatus.textContent = 'Result queued for save. Sign in to save to your account.';
          arShowToast('Result saved locally. Sign in to save to your account.', 'info');
        }

        async function arAutoSaveQueuedResults() {
          if (!arPendingResult || !arUser) return;
          try {
            await arSaveResult(arPendingResult);
            arPendingResult = null;
            arStatus.textContent = 'Result saved to your account.';
            arShowToast('Queued result saved to your account.', 'success');
          } catch (err) {
            console.error('Auto-save failed:', err);
            arShowToast('Could not save to account. Result remains queued.', 'error');
          }
        }

        async function arSaveResult(report) {
          if (!arUser) throw new Error('Not signed in');
          
          const { error } = await supabase
            .from('module_results')
            .upsert({
              user_id: arUser.id,
              module_id: report.moduleId,
              learner_name: report.learnerName,
              learner_email: report.learnerEmail,
              score_percent: report.scorePercent,
              passed: report.passed,
              total_questions: report.totalQuestions,
              correct_answers: report.correctAnswers,
              answers: report.answers,
              submitted_at: report.submittedAt
            }, { onConflict: 'user_id,module_id' });

          if (error) throw error;
          arShowToast('Result saved to your account.', 'success');
        }

        /* =============================
           PDF Generation
        ==============================*/
        async function arDownloadResultsPDF() {
          if (!lastReport) { arShowToast('No results to download.', 'error'); return; }
          
          try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Helper functions
            const toDataURL = (url) => new Promise((resolve) => {
              const img = new Image(); img.crossOrigin = 'anonymous';
              img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); c.width = img.width; c.height = img.height; ctx.drawImage(img, 0, 0); resolve(c.toDataURL('image/png')); };
              img.onerror = () => resolve(null); img.src = url;
            });
            
            const getImgDims = (dataUrl) => new Promise((resolve) => {
              const img = new Image(); img.onload = () => resolve({ w: img.width, h: img.height }); img.onerror = () => resolve({ w: 100, h: 100 }); img.src = dataUrl;
            });
            
            const fitWithin = (imgW, imgH, maxW, maxH) => {
              const scale = Math.min(maxW / imgW, maxH / imgH);
              return { w: imgW * scale, h: imgH * scale };
            };

            // Header with logo
            const logoDataUrl = await toDataURL(branding.logoUrl);
            if (logoDataUrl) {
              const dims = await getImgDims(logoDataUrl);
              const fitted = fitWithin(dims.w, dims.h, 60, 40);
              doc.addImage(logoDataUrl, 'PNG', 20, 20, fitted.w, fitted.h);
            }
            
            const academyDataUrl = await toDataURL(branding.academyUrl);
            if (academyDataUrl) {
              const dims = await getImgDims(academyDataUrl);
              const fitted = fitWithin(dims.w, dims.h, 50, 30);
              doc.addImage(academyDataUrl, 'PNG', doc.internal.pageSize.width - 20 - fitted.w, 20, fitted.w, fitted.h);
            }

            // Orange header bar
            doc.setFillColor(240, 89, 34);
            doc.rect(0, 0, doc.internal.pageSize.width, 15, 'F');

            // Title
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(lastReport.moduleTitle, 20, 35);

            // Info box
            doc.setFillColor(240, 248, 255);
            doc.rect(20, 45, 170, 25, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Name: ${lastReport.learnerName}`, 25, 52);
            doc.text(`Email: ${lastReport.learnerEmail}`, 25, 57);
            doc.text(`Score: ${lastReport.scorePercent}%`, 25, 62);
            doc.text(`Result: ${lastReport.passed ? 'PASS' : 'FAIL'}`, 25, 67);
            doc.text(`Date: ${new Date(lastReport.submittedAt).toLocaleDateString()}`, 25, 72);

            // Links
            doc.setTextColor(37, 99, 235);
            doc.textWithLink('Course: ' + branding.courseUrl, 25, 80, { url: branding.courseUrl });
            doc.textWithLink('Module: ' + branding.exposureUrl, 25, 85, { url: branding.exposureUrl });
            doc.textWithLink('Website: ' + branding.siteUrl, 25, 90, { url: branding.siteUrl });
            doc.setTextColor(0, 0, 0);

            // Results line
            const resultsLine = lastReport.answers ? Object.entries(lastReport.answers).map(([qId, answerIdx]) => {
              const q = currentQuizConfig.questions.find(q => q.id === qId);
              const isCorrect = answerIdx === q.correctIndex;
              return `Q${currentQuizConfig.questions.indexOf(q) + 1}: ${isCorrect ? 'Correct' : 'Incorrect'}`;
            }).join(' | ') : '';
            
            doc.setFontSize(9);
            doc.text(resultsLine, 20, 100);

            doc.save(`Alan-Ranger-${lastReport.moduleId}-Results.pdf`);
            arShowToast('Results PDF downloaded.', 'success');
          } catch (err) {
            console.error('PDF generation failed:', err);
            arShowToast('Could not generate PDF.', 'error');
          }
        }

        async function arDownloadCertificate() {
          if (!lastReport || !lastReport.passed) { arShowToast('Certificate only available for passed modules.', 'error'); return; }
          
          try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');
            
            const toDataURL = (url) => new Promise((resolve) => {
              const img = new Image(); img.crossOrigin = 'anonymous';
              img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); c.width = img.width; c.height = img.height; ctx.drawImage(img, 0, 0); resolve(c.toDataURL('image/png')); };
              img.onerror = () => resolve(null); img.src = url;
            });

            // Outer orange frame
            doc.setFillColor(240, 89, 34);
            doc.rect(0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');
            
            // Inner grey keyline
            doc.setFillColor(200, 200, 200);
            doc.rect(5, 5, doc.internal.pageSize.width - 10, doc.internal.pageSize.height - 10, 'F');
            
            // White background
            doc.setFillColor(255, 255, 255);
            doc.rect(8, 8, doc.internal.pageSize.width - 16, doc.internal.pageSize.height - 16, 'F');

            // Logo top left
            const logoDataUrl = await toDataURL(branding.logoUrl);
            if (logoDataUrl) {
              doc.addImage(logoDataUrl, 'PNG', 15, 15, 80, 50);
            }

            // Academy icon top right
            const academyDataUrl = await toDataURL(branding.academyUrl);
            if (academyDataUrl) {
              doc.addImage(academyDataUrl, 'PNG', doc.internal.pageSize.width - 95, 15, 80, 50);
            }

            // Main typography block
            doc.setFontSize(36);
            doc.setFont('times', 'bold');
            doc.text('Certificate of Achievement', doc.internal.pageSize.width / 2, 80, { align: 'center' });

            doc.setFontSize(18);
            doc.setFont('helvetica', 'normal');
            doc.text(`This is to certify that`, doc.internal.pageSize.width / 2, 100, { align: 'center' });

            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text(lastReport.learnerName, doc.internal.pageSize.width / 2, 120, { align: 'center' });

            doc.setFontSize(16);
            doc.setFont('helvetica', 'normal');
            doc.text(`has successfully completed`, doc.internal.pageSize.width / 2, 140, { align: 'center' });

            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(lastReport.moduleTitle, doc.internal.pageSize.width / 2, 160, { align: 'center' });

            // Strapline
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Alan Ranger Photography Academy — Beginners Modules included', doc.internal.pageSize.width / 2, 180, { align: 'center' });

            // Signature
            const signatureDataUrl = await toDataURL(branding.signatureUrl);
            if (signatureDataUrl) {
              doc.addImage(signatureDataUrl, 'PNG', 20, 190, 60, 30);
            }

            // Orange rule under signature
            doc.setDrawColor(240, 89, 34);
            doc.setLineWidth(0.5);
            doc.line(20, 225, 100, 225);

            // Footer
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Instructor', 20, 235);
            doc.text('Website: alanranger.com', 20, 245);

            doc.save(`Alan-Ranger-${lastReport.moduleId}-Certificate.pdf`);
            arShowToast('Certificate downloaded.', 'success');
          } catch (err) {
            console.error('Certificate generation failed:', err);
            arShowToast('Could not generate certificate.', 'error');
          }
        }

        // Event listeners
        document.getElementById('btn-submit').addEventListener('click', arSubmitQuiz);
        document.getElementById('btn-retake').addEventListener('click', arRetakeQuiz);
        document.getElementById('btn-pdf').addEventListener('click', arDownloadResultsPDF);
        document.getElementById('btn-certificate').addEventListener('click', arDownloadCertificate);
        document.getElementById('btn-save').addEventListener('click', async () => {
          if (!lastReport) { arShowToast('No results to save.', 'error'); return; }
          if (!arUser) { arShowToast('Please sign in to save results.', 'error'); return; }
          try {
            await arSaveResult(lastReport);
          } catch (err) {
            console.error('Save failed:', err);
            arShowToast('Could not save result.', 'error');
          }
        });

        // Make functions global
        window.showGrid = showGrid;
        window.showQuiz = showQuiz;

        /* =============================
           Initial render
        ==============================*/
        (async()=>{
          try {
            checkUrlParams();
            const { data:{ user } } = await supabase.auth.getUser();
            setAuthUI(user || null);
            const status = await fetchStatusForUser(user);
            renderSummary(status);
            renderGrid(status);
          } catch (error) {
            console.error('Error initializing app:', error);
            // Fallback: just show the grid
            showGrid();
          }
        })();
      })();
    } catch (error) {
      console.error('Error loading application:', error);
    }
  }, 1000); // 1 second delay to avoid conflicts
});
</script>
