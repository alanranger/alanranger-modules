<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Q&A API UI Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-info {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #E57200;
    }
    .test-info h2 {
      margin-top: 0;
      color: #E57200;
    }
    .test-info code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="test-info">
    <h2>Q&A API UI Test Page</h2>
    <p>This page tests the Q&A snippet UI integration.</p>
    <p><strong>API Base:</strong> <code id="api-base">https://alanranger-modules.vercel.app</code></p>
    <p><strong>Test Page URL:</strong> <code id="test-page-url"></code></p>
    <p><strong>Status:</strong> <span id="test-status">Ready</span></p>
  </div>

  <!-- Academy Q&A Section (Supabase-backed via Vercel API) -->
  <div id="academy-qa-section" style="max-width:800px; margin: 40px auto; font-family: sans-serif; text-align: left;">
    <h2 style="border-bottom: 2px solid #E57200; padding-bottom: 10px;">Academy Q&amp;A</h2>

    <div id="qa-form-container" style="background: #f4f4f4; padding: 25px; border-radius: 12px; margin-bottom: 35px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
      <h4 style="margin-top:0;">Ask a Question</h4>
      <textarea id="qa-input" placeholder="What is on your mind?" style="width: 100%; height: 100px; padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box;"></textarea>
      <button id="submit-qa" style="background: #E57200; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 16px;">Post to Academy</button>
      <div id="qa-status" style="margin-top: 10px; font-size: 14px; display: none;"></div>
      <p style="margin:14px 0 0; color:#666; font-size:14px;">Please keep questions on-topic. Don't post personal booking details.</p>
    </div>

    <div id="qa-list-container">
      <h4>Recent Questions</h4>
      <div id="qa-list">
        <p style="color: #999;">Loading questions...</p>
      </div>
    </div>
  </div>

  <script>
  (function () {
    const API_BASE = "https://alanranger-modules.vercel.app";
    const API_URL = API_BASE + "/api/academy/qa/questions";

    const pageUrl = (window.location.origin + window.location.pathname).replace(/\/$/, "");
    
    // Update test info
    document.getElementById('test-page-url').textContent = pageUrl;

    const els = {
      list: document.getElementById("qa-list"),
      status: document.getElementById("qa-status"),
      input: document.getElementById("qa-input"),
      btn: document.getElementById("submit-qa"),
    };

    function showStatus(msg, color) {
      els.status.style.display = "block";
      els.status.style.color = color || "#333";
      els.status.textContent = msg;
    }

    function hideStatusSoon() {
      setTimeout(() => { els.status.style.display = "none"; }, 4000);
    }

    async function safeFetchJson(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch (e) { json = { raw: text }; }

      if (!res.ok) {
        const err = json?.error || json?.message || ("HTTP " + res.status);
        throw new Error(err);
      }
      return json;
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderQuestions(rows) {
      if (!rows || !rows.length) {
        els.list.innerHTML = '<p style="color:#999; font-style: italic;">No questions yet. Be the first to ask!</p>';
        return;
      }

      els.list.innerHTML = "";
      rows.forEach(row => {
        const name = row.member_name || row.member_email || "Academy Member";
        const content = row.question || "";
        const date = row.created_at ? new Date(row.created_at).toLocaleDateString() : "";

        const qDiv = document.createElement("div");
        qDiv.style = "background:#fff;border:1px solid #eee;padding:20px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.02);";
        qDiv.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:12px; margin-bottom:8px;">
            <strong style="color:#E57200; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(name)}</strong>
            <span style="font-size:12px; color:#aaa; flex:0 0 auto;">${escapeHtml(date)}</span>
          </div>
          <p style="margin:0; line-height:1.5; color:#333; white-space:pre-wrap;">${escapeHtml(content)}</p>
        `;
        els.list.appendChild(qDiv);
      });
    }

    async function fetchQuestions() {
      try {
        const url = API_URL + "?page_url=" + encodeURIComponent(pageUrl) + "&limit=25";
        const json = await safeFetchJson(url, { method: "GET", cache: "no-store" });
        renderQuestions(json.data || []);
        document.getElementById('test-status').textContent = '✓ Questions loaded successfully';
        document.getElementById('test-status').style.color = 'green';
      } catch (err) {
        console.error("[Academy Q&A] Fetch failed:", err);
        els.list.innerHTML = '<p style="color:#c2410c;">Could not load questions. Check console for details.</p>';
        document.getElementById('test-status').textContent = '✗ Failed to load questions: ' + err.message;
        document.getElementById('test-status').style.color = 'red';
      }
    }

    async function getMember() {
      const ms = window.$memberstackDom;
      if (!ms || !ms.getCurrentMember) return null;

      try {
        const { data: member } = await ms.getCurrentMember();
        return member || null;
      } catch (e) {
        return null;
      }
    }

    async function submitQuestion() {
      const questionText = (els.input.value || "").trim();
      if (!questionText) return;

      // For testing, allow posting without member (will use null values)
      const member = await getMember();
      
      const memberId = member ? (member.id || member.memberId || null) : null;
      const memberEmail = member ? ((member.auth && member.auth.email) ? member.auth.email : (member.email || null)) : null;
      const memberName = member ? (
        member.name ||
        (member.customFields && (member.customFields.firstName || member.customFields.first_name) ? (
          ((member.customFields.firstName || member.customFields.first_name) + " " + (member.customFields.lastName || member.customFields.last_name || "")).trim()
        ) : null) ||
        memberEmail ||
        "Academy Member"
      ) : "Test User";

      els.btn.disabled = true;
      showStatus("Posting...", "#333");

      try {
        const payload = {
          page_url: pageUrl,
          question: questionText,
          member_id: memberId,
          member_email: memberEmail,
          member_name: memberName
        };

        await safeFetchJson(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          cache: "no-store"
        });

        els.input.value = "";
        showStatus("✓ Question posted!", "green");
        els.btn.disabled = false;
        fetchQuestions();
        hideStatusSoon();
      } catch (err) {
        console.error("[Academy Q&A] Submit failed:", err);
        showStatus("Error: Could not post question. Check console for details.", "#b91c1c");
        els.btn.disabled = false;
      }
    }

    els.btn.addEventListener("click", submitQuestion);

    // Load list
    fetchQuestions();
  })();
  </script>
</body>
</html>
