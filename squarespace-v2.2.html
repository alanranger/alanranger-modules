<!-- AR Assessment v2.58 ‚Äî Fixed Submit Answers button visibility issue with test buttons -->
<div id="ar-modgrid">
  <!-- Grid View -->
  <div id="grid-container" style="display:block; max-width:1200px; margin:0 auto; padding:20px;">
    <style>
      :root{ --ar-orange:#E57200; --ar-green:#10b981; --ar-red:#ef4444; --ar-gray:#eaeaea; --ar-text:#1f2937; }
      #ar-modgrid a{color:#2563eb;text-decoration:none} #ar-modgrid a:hover{text-decoration:underline}
      #ar-modgrid .top{ display:flex;flex-direction:column;gap:16px;margin:8px 0 18px }
      #ar-modgrid h2{margin:0;font-size:36px;line-height:1.2;font-weight:800}
      #ar-modgrid .summary{ width:100%;border:1px solid var(--ar-gray);border-radius:12px;background:#fff;padding:10px 12px;box-shadow:0 1px 4px rgba(0,0,0,.06) }
      #ar-modgrid .summary h3{margin:0 0 6px 0;font-size:18px;font-weight:800}
      #ar-modgrid .progressline{display:flex;justify-content:space-between;align-items:center;margin:0 0 4px 0}
      #ar-modgrid .progressline .stat{font-weight:800;font-size:16px}
      #ar-modgrid .track{margin-top:4px;height:8px;border-radius:999px;background:#f2f2f2;overflow:hidden}
      #ar-modgrid .bar{height:100%;width:0;background:var(--ar-orange);transition:width .4s ease;border-radius:999px}
      #ar-modgrid .auth{ display:grid; grid-template-columns:auto auto auto auto auto; align-items:center;gap:8px;margin-top:8px;justify-content:start }
      #ar-modgrid .badge{padding:4px 8px;border:1px solid var(--ar-gray);border-radius:999px;background:#fff;font-weight:600;font-size:12px}
      #ar-modgrid input[type="email"]{ width:100%;min-width:120px;max-width:200px;padding:6px 8px;border:1px solid #ddd;border-radius:8px;font-size:13px }
      #ar-modgrid .btn{ display:inline-flex;align-items:center;justify-content:center;gap:6px; padding:6px 10px;border-radius:8px;border:1px solid var(--ar-orange);background:var(--ar-orange);color:#fff; font-weight:700;cursor:pointer;text-decoration:none;white-space:nowrap;font-size:13px }
      #ar-modgrid .btn.sm{padding:5px 10px;border-radius:6px;font-size:13px}
      #ar-modgrid .btn.secondary{background:#fff;color:var(--ar-orange)}
      #ar-modgrid .hint{margin-top:6px;color:#444;font-size:12px}
      #ar-modgrid .grid{ display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:16px }
      @media (max-width:1200px){ #ar-modgrid .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
      @media (max-width:980px){ #ar-modgrid .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
      @media (max-width:640px){ #ar-modgrid .top{grid-template-columns:1fr} #ar-modgrid .grid{grid-template-columns:repeat(2,minmax(0,1fr))} #ar-modgrid .summary{max-width:none} }
      @media (max-width:480px){ #ar-modgrid .grid{grid-template-columns:1fr} }
      #ar-modgrid .card{ position:relative;background:#fff;border:1px solid var(--ar-gray);border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.05); overflow:hidden }
      #ar-modgrid .card::before{ content:"";position:absolute;left:0;top:0;bottom:0;width:8px;background:var(--ar-orange) }
      #ar-modgrid .head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
      #ar-modgrid .num{min-width:28px;height:28px;border-radius:999px;background:rgba(229,114,0,.12);color:#793d00;display:inline-flex;align-items:center;justify-content:center;font-weight:800}
      #ar-modgrid .title{font-weight:800;font-size:18px}
      #ar-modgrid .chips{ display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;margin:4px 0 10px 0;text-align:center }
      #ar-modgrid .chip{ display:inline-flex;align-items:center;justify-content:center;gap:6px; padding:6px 10px;border-radius:999px;border:1px solid var(--ar-gray);background:#fff;font-size:14px }
      #ar-modgrid .chip.pass{background:#f6fffa;border-color:#b7f0d2;color:#067647}
      #ar-modgrid .chip.fail{background:#fff5f5;border-color:#fac5c5;color:#b42318}
      #ar-modgrid .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:4px}
      #ar-modgrid .card.passed{background:#e6f7ed} #ar-modgrid .card.failed{background:#fef2f2}
      #ar-modgrid .tick{position:absolute;right:12px;top:12px;width:28px;height:28px;border-radius:999px;background:#e6fff4;border:1px solid #b7f0d2;color:#067647;font-weight:900;display:flex;align-items:center;justify-content:center}
      #ar-modgrid .xmark{position:absolute;right:12px;top:12px;width:28px;height:28px;border-radius:999px;background:#ffecec;border:1px solid #f8caca;color:#b42318;font-weight:900;display:flex;align-items:center;justify-content:center}
      #ar-modgrid .toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);z-index:99999;background:#111;color:#fff; padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);display:none}
      #ar-modgrid .toast.ok{background:var(--ar-green)} #ar-modgrid .toast.err{background:var(--ar-red)}
      
      /* Debug panel styles - VISIBLE BY DEFAULT */
      #debugPanel{ 
        position:fixed; 
        top:10px; 
        right:10px; 
        width:450px; 
        max-height:90vh; 
        background:#1a1a1a; 
        border:2px solid #8b5cf6; 
        border-radius:8px; 
        box-shadow:0 8px 32px rgba(0,0,0,.5); 
        z-index:99999; 
        display:block; /* Visible by default for debugging */
        font-family:monospace;
        color:#fff;
        overflow:hidden;
      }
      #debugHeader{ 
        padding:12px 16px; 
        background:#8b5cf6; 
        color:#fff; 
        font-weight:bold; 
        font-size:14px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:8px;
      }
      #debugToggle, #debugCopy{ 
        background:rgba(255,255,255,.2); 
        border:none; 
        color:#fff; 
        padding:4px 8px; 
        border-radius:4px; 
        cursor:pointer; 
        font-size:11px;
        transition:background 0.2s;
      }
      #debugToggle:hover, #debugCopy:hover{ 
        background:rgba(255,255,255,.3);
      }
      #debugCopy.copied{
        background:#10b981;
      }
      #debugContent{ 
        max-height:calc(90vh - 50px); 
        overflow-y:auto; 
        padding:16px; 
        font-size:11px; 
        line-height:1.6;
      }
      .debug-section{ 
        margin-bottom:16px; 
        padding-bottom:12px; 
        border-bottom:1px solid #333; 
      }
      .debug-section:last-child{ border-bottom:none; }
      .debug-section-title{ 
        color:#8b5cf6; 
        font-weight:bold; 
        margin-bottom:8px; 
        font-size:12px;
        text-transform:uppercase;
      }
      .debug-item{ 
        margin:4px 0; 
        padding:4px 0;
      }
      .debug-label{ 
        color:#aaa; 
        display:inline-block; 
        min-width:140px; 
      }
      .debug-value{ 
        color:#0f0; 
        word-break:break-all;
      }
      .debug-value.error{ color:#f44; }
      .debug-value.warning{ color:#ffa500; }
      .debug-value.info{ color:#4af; }
    </style>
    
    <div class="top">
      <h2>15 Camera Settings - Exams and Certification</h2>
      <div class="summary" id="summary">
        <div class="progressline">
          <div class="stat"><span id="passedCount">0</span>/15 Passed</div>
          <div class="stat"><span id="progressPct">0</span>%</div>
        </div>
        <div class="track"><div class="bar" id="progressBar"></div></div>
        <div class="auth">
          <span class="badge" id="authBadge">Checking authentication...</span>
          <!-- Magic-link UI hidden - Memberstack-only authentication -->
          <input id="loginEmail" type="email" placeholder="you@example.com" style="display:none;" />
          <button class="btn" id="btnMagic" style="display:none;">Get magic link</button>
          <button class="btn secondary" id="btnSignIn" style="display:none;">Sign in</button>
          <button class="btn secondary" id="btnSignOut" style="display:none">Sign out</button>
          <div id="memberstackAuthMessage" style="display:none; padding:12px; background:#fff3cd; border:1px solid #ffc107; border-radius:8px; margin-top:8px;">
            <strong>Please sign in to the Academy dashboard to use exams.</strong>
            <br><a href="/academy/login" style="color:#E57200; text-decoration:underline;">Go to Academy Login ‚Üí</a>
          </div>
          <button id="btnMigrateLegacy" class="btn secondary" style="display:none; background:#10b981; color:#fff; margin-top:8px;">
            Link my existing exam progress
          </button>
        </div>
        <div class="hint" id="authHint" style="display:none;">New users: "Get magic link" | Returning users: "Sign in" to access your saved progress.</div>
        <div class="hint" id="authTip" style="display:none; margin-top: 4px; font-size: 12px; color: #666;">
          üí° Tip: Once signed in, you'll stay signed in on this device until you sign out. If you sign out, you'll need a new magic link to sign back in.
        </div>
      </div>
    </div>
    <div class="grid" id="grid" style="display:none;"></div>
    <div class="toast" id="toast"></div>
  
  <!-- Loading spinner for sign-in process -->
  <div id="loadingSpinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:99999; background:rgba(255,255,255,0.98); padding:30px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.3); text-align:center; border:2px solid #E57200;">
    <div style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #E57200; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 12px;"></div>
    <div id="loadingText" style="font-weight:600; color:#333;">Loading your progress...</div>
  </div>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
    
  </div>
  
  <!-- Debug Panel - VISIBLE BY DEFAULT (Press Ctrl+Shift+D to toggle) - Outside containers so it stays visible in quiz view -->
  <div id="debugPanel">
    <div id="debugHeader">
      <span>üîç Exam Debug Panel</span>
      <div style="display:flex; gap:4px;">
        <button id="debugCopy" onclick="copyDebugInfo()" title="Copy all debug info to clipboard">üìã Copy</button>
        <button id="debugToggle" onclick="document.getElementById('debugPanel').style.display = document.getElementById('debugPanel').style.display === 'none' ? 'block' : 'none';" title="Toggle panel">‚úï Close</button>
      </div>
    </div>
    <div id="debugContent">
      <div class="debug-section">
        <div class="debug-section-title">‚è≥ Initializing...</div>
      </div>
    </div>
  </div>
  
  <!-- Small debug toggle button (hidden by default, show with Ctrl+Shift+D) -->
  <button id="debugShowBtn" onclick="document.getElementById('debugPanel').style.display = 'block';" style="display:none; position:fixed; bottom:20px; right:20px; z-index:99998; background:#8b5cf6; color:#fff; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size:18px; box-shadow:0 4px 12px rgba(0,0,0,.3);" title="Show Debug Panel (Ctrl+Shift+D)">üîç</button>

  <!-- Quiz View -->
  <div id="quiz-container" style="display:none;">
    <div id="ar-quiz" style="border:1px solid #eaeaea;border-left:10px solid #F05922;background:#fafafa;padding:24px;border-radius:12px;max-width:820px;margin:28px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">
  <style>
    #ar-quiz a { color:#2563eb !important; text-decoration:none; }
    #ar-quiz a:hover { text-decoration:underline; }
    #ar-toast{ position:fixed; z-index:99999; left:50%; top:22px; transform:translateX(-50%);
      background:#111; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.15); display:none; max-width:90vw; font-size:14px; line-height:1.35; text-align:center; }
    #ar-toast.success{ background:#10b981; } #ar-toast.error{ background:#ef4444; } #ar-toast.info{ background:#2563eb; }
    .ar-field{ border:1px solid #eaeaea;background:#fff;border-radius:10px;padding:14px;margin:12px 0; }
    .ar-qtxt{ font-weight:800;margin:0 0 8px; color:#F05922; }
    .ar-opt{ display:flex; gap:10px; align-items:center; margin:8px 0; cursor:pointer; }
    #results .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; }
    #results .pill-pass { background:#e8fff4; color:#067647; border:1px solid #b7f0d2; }
    #results .pill-fail { background:#fff5f5; color:#b42318; border:1px solid #fac5c5; }
    #ar-auth { display:flex; align-items:center; gap:10px; margin:0 0 8px; color:#555; font-size:14px; flex-wrap:wrap; }
    #ar-auth .badge { padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; }
    #ar-auth .mini-btn { background:#fff; color:#333; border:1px solid #ddd; border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px; }
    #ar-auth .mini-btn:disabled { opacity:.6; cursor:not-allowed; }
    #ar-status { margin:6px 0 0; font-size:14px; color:#111; }
    .muted { color:#6b7280; }
    input[type="radio"] { accent-color:#F05922; }
    input[type="radio"]:checked { accent-color:#F05922; }
  </style>

  <div id="ar-auth">
    <span id="ar-auth-status" class="badge">Not signed in</span>
    <span id="ar-auth-email"></span>
    <!-- Magic-link UI hidden - Memberstack-only authentication -->
    <button id="btn-magic" type="button" class="mini-btn" style="display:none; background:#F05922;color:#fff;border-color:#F05922;">Send magic link</button>
    <button id="btn-clear" type="button" class="mini-btn" style="display:none; background:#6b7280;color:#fff;border-color:#6b7280;">Clear results / Sign out</button>
  </div>
  <div id="quizAuthMessage" style="display:none; font-size:12px;color:#6b7280;margin:8px 0 16px 0;padding:8px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;">
    <strong>Please sign in to the Academy dashboard to use exams.</strong>
    <br><a href="/academy/login" style="color:#E57200; text-decoration:underline;">Go to Academy Login ‚Üí</a>
  </div>
  <div style="display:none; font-size:12px;color:#6b7280;margin:8px 0 16px 0;padding:8px;background:#f9f9f9;border-radius:6px;">
    <strong>Magic link:</strong> Enter your email and click "Send magic link" to receive a secure login link. No password needed. 
    <strong>Clear results:</strong> Use this to sign out and reset the quiz so you can retake it.
  </div>

  <h2 style="margin:0 0 12px;font-weight:700;line-height:1.2;">Module 1 Assessment: What is Exposure</h2>
  <p style="margin:0 0 16px;color:#333;">Enter your details, answer the questions, then view your score. Download your results as a PDF. If you pass, you can also download a personalised certificate.</p>

  <!-- Learner details -->
  <form id="learner-form" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 20px;">
    <div>
      <label for="name" style="display:block;font-weight:600;margin-bottom:6px;">Name</label>
      <input id="name" name="name" type="text" required placeholder="Your name"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;background-color:#fff5f5;border-color:#fca5a5;">
      <div style="font-size:12px;color:#666;margin-top:4px;font-style:italic;">
        üí° Enter your full name as you'd like it to appear on your certificate
      </div>
    </div>
    <div>
      <label for="email" style="display:block;font-weight:600;margin-bottom:6px;">Email (for saving progress)</label>
      <input id="email" name="email" type="email" placeholder="you@example.com"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      <div id="ar-status"></div>
    </div>
  </form>

  <!-- Assessment -->
  <form id="quiz-form" novalidate></form>

  <!-- Actions -->
  <div id="quiz-actions" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:16px;">
    <button id="btn-submit" type="button"
            style="background:#F05922;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Submit answers</button>
    <button id="btn-retake" type="button" style="display:none;"
            style="background:#dc2626;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">Retake test</button>
    <button id="btn-test-correct" type="button" 
            style="display: none; background:#10b981;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">üß™ Test: All Correct</button>
    <button id="btn-test-fail" type="button" 
            style="display: none; background:#ef4444;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;">üß™ Test: All Wrong</button>
    <button id="btn-pdf" type="button" disabled
            style="background:#2563eb;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download results (PDF)</button>
    <button id="btn-certificate" type="button" disabled
            style="background:#10b981;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Download certificate (PDF)</button>
    <button id="btn-save" type="button" disabled
            style="background:#111827;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;opacity:.6;">Save to my account</button>
  </div>

  <!-- Results -->
  <div id="results" style="margin-top:20px;display:none;background:#fff;border:1px solid #eaeaea;border-radius:10px;padding:16px;">
    <h3 style="margin:0 0 10px;font-size:18px;">Your results</h3>
    <div id="results-summary" style="margin-bottom:12px;"></div>
    <div id="results-compact" class="muted" style="font-size:13px;"></div>
    <div id="results-feedback" style="margin-top:8px;"></div>
  </div>

  <div id="ar-toast" role="status" aria-live="polite"></div>
  
  <!-- Back to Modules Button -->
  <div style="text-align:center; margin-top:24px; padding-top:16px; border-top:1px solid #eaeaea;">
    <button onclick="backToGrid()" style="display:inline-block; background:#6b7280; color:#fff; text-decoration:none; padding:12px 20px; border-radius:10px; font-weight:700; border:none; cursor:pointer;">
      ‚Üê Back to Modules
    </button>
  </div>
    </div>
  </div>
</div>

<!-- Deps -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- GRID FUNCTIONALITY ---------- */
const modules = [
  {id:"module-01-exposure", n:1, title:"Exposure", article:"https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography"},
  {id:"module-02-aperture", n:2, title:"Aperture", article:"https://www.alanranger.com/blog-on-photography/what-is-aperture-in-photography"},
  {id:"module-03-shutter", n:3, title:"Shutter Speed", article:"https://www.alanranger.com/blog-on-photography/what-is-shutter-speed"},
  {id:"module-04-iso", n:4, title:"ISO", article:"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography"},
  {id:"module-05-manual", n:5, title:"Manual Exposure", article:"https://www.alanranger.com/blog-on-photography/what-is-manual-exposure-in-photography"},
  {id:"module-06-metering", n:6, title:"Metering", article:"https://www.alanranger.com/blog-on-photography/what-is-metering-in-photography"},
  {id:"module-07-bracketing", n:7, title:"Exposure Bracketing", article:"https://www.alanranger.com/blog-on-photography/exposure-bracketing-a-guide-for-photographers"},
  {id:"module-08-focusing", n:8, title:"Focusing", article:"https://www.alanranger.com/blog-on-photography/what-is-focus-in-photography"},
  {id:"module-09-dof", n:9, title:"Depth of Field", article:"https://www.alanranger.com/blog-on-photography/what-is-depth-of-field"},
  {id:"module-10-drange", n:10, title:"Dynamic Range", article:"https://www.alanranger.com/blog-on-photography/what-is-dynamic-range-in-photography"},
  {id:"module-11-wb", n:11, title:"White Balance", article:"https://www.alanranger.com/blog-on-photography/what-is-white-balance-in-photography"},
  {id:"module-12-drive", n:12, title:"Camera Drive Modes", article:"https://www.alanranger.com/blog-on-photography/what-are-camera-drive-modes"},
  {id:"module-13-jpeg-raw", n:13, title:"JPEG vs RAW", article:"https://www.alanranger.com/blog-on-photography/jpeg-vs-raw-the-key-differences"},
  {id:"module-14-sensors", n:14, title:"Full Frame vs Crop Sensor", article:"https://www.alanranger.com/blog-on-photography/full-frame-vs-cropped-sensor"},
  {id:"module-15-focal", n:15, title:"Focal Length", article:"https://www.alanranger.com/blog-on-photography/what-is-focal-length-in-photography"},
];

// Test if modules array is accessible
console.log('üîç Modules array test:', modules);
console.log('üîç Modules length:', modules ? modules.length : 'undefined');

function renderGrid(statusByModuleId = {}) {
  // PROTECT: If Memberstack data has been loaded and we're trying to clear it, block it
  if (memberstackDataLoaded && Object.keys(statusByModuleId).length === 0) {
    debugLog('üõ°Ô∏è BLOCKED: Attempt to clear grid after Memberstack data loaded - ignoring');
    debugLog('üõ°Ô∏è Stack trace:', new Error().stack);
    return; // Don't clear the grid
  }
  
  debugLog('üé® renderGrid called with: ' + JSON.stringify(statusByModuleId));
  debugLog('üé® modules array length: ' + (modules ? modules.length : 'undefined'));
  debugLog('üé® modules type: ' + typeof modules);
  debugLog('üé® first module: ' + JSON.stringify(modules ? modules[0] : 'undefined'));
  
  const gridEl = document.getElementById('grid');
  if (!gridEl) {
    debugLog('‚ùå Grid element not found');
    return;
  }
  
  gridEl.innerHTML = '';
  if (!modules || modules.length === 0) {
    debugLog('‚ùå Modules array is empty or undefined');
    return;
  }
  
  modules.forEach(m => {
    debugLog(`üîç Processing module: ${JSON.stringify(m)}`);
    const moduleId = m.id; // Capture the moduleId in a local variable
    console.log('üîç Captured moduleId:', moduleId, 'from m.id:', m.id);
    const st = statusByModuleId[moduleId];
    const passed = st?.passed === true;
    const failed = st && st.passed === false;
    
    debugLog(`üìù Module ${moduleId}: status=${JSON.stringify(st)}, passed=${passed}, failed=${failed}`);
    
    const card = document.createElement('div');
    card.className = `card${passed ? ' passed' : ''}${failed ? ' failed' : ''}`;
    
    const head = document.createElement('div');
    head.className = 'head';
    head.innerHTML = `<div class="num">${m.n}</div><div class="title">${m.title}</div>`;
    card.appendChild(head);
    
    if (passed) {
      const tick = document.createElement('div');
      tick.className='tick'; tick.textContent='‚úì';
      card.appendChild(tick);
    } else if (failed) {
      const x = document.createElement('div');
      x.className='xmark'; x.textContent='‚úï';
      card.appendChild(x);
    }
    
    const chips = document.createElement('div');
    chips.className = 'chips';
    const scoreTxt = (typeof st?.score === 'number') ? `${st.score}%` : '‚Äî';
    const hasBeenTaken = typeof st?.score === 'number';
    const dateTxt = hasBeenTaken ? new Date(st.when).toLocaleDateString() : 'Pass ‚â• 80%';
    chips.innerHTML = `
      <span class="chip">Score: <strong>${scoreTxt}</strong></span>
      <span class="chip">${dateTxt}</span>
      ${passed ? `<span class="chip pass">Passed</span>` : (failed ? `<span class="chip fail">Failed</span>` : '')}
    `;
    card.appendChild(chips);
    
      const actions = document.createElement('div');
  actions.className = 'actions';
  const examButtonText = passed ? 'View results' : (failed ? 'Retake exam' : 'Take exam');
  const examButtonClass = passed ? 'btn sm' : 'btn sm secondary';
  
  // Create the "Open module" link
  const articleLink = document.createElement('a');
  articleLink.className = 'btn sm';
  articleLink.href = m.article;
  articleLink.target = '_blank';
  articleLink.rel = 'noopener';
  articleLink.textContent = 'Open module';
  actions.appendChild(articleLink);
  
  // Create the exam button
  const examButton = document.createElement('button');
  examButton.className = examButtonClass;
  examButton.type = 'button';
  examButton.textContent = examButtonText;
  examButton.setAttribute('data-module-id', moduleId); // Store moduleId in data attribute
  
  // Add click event listener
  examButton.addEventListener('click', () => {
    const clickedModuleId = examButton.getAttribute('data-module-id');
    console.log('üîç Button clicked for module:', clickedModuleId, 'type:', typeof clickedModuleId, 'length:', clickedModuleId?.length);
    debugLog('üîç Button clicked for module:', clickedModuleId);
    if (passed) {
      console.log('üîç View Results clicked for module:', clickedModuleId);
      debugLog('üîç View Results clicked for module:', clickedModuleId);
      window.showResultsModal(clickedModuleId);
    } else {
      console.log('üîç Load Exam clicked for module:', clickedModuleId);
      debugLog('üîç Load Exam clicked for module:', clickedModuleId);
      window.loadExam(clickedModuleId);
    }
  });
  
  actions.appendChild(examButton);
  card.appendChild(actions);
  
  // Debug logging for grid rendering
  debugLog(`üé® Rendered module ${moduleId}: passed=${passed}, buttonText="${examButtonText}", buttonClass="${examButtonClass}"`);
    
    gridEl.appendChild(card);
  });
  
  // Debug: Log the final grid state
  debugLog(`üé® Grid rendering complete. Total cards: ${gridEl.children.length}`);
  debugLog(`üé® Grid HTML preview: ${gridEl.innerHTML.substring(0, 200)}...`);
  
}

function renderSummary(statusByModuleId) {
  const total = modules.length;
  const passed = Object.values(statusByModuleId).filter(s => s.passed === true).length;
  const passedCountEl = document.getElementById('passedCount');
  const progressPctEl = document.getElementById('progressPct');
  const progressBar = document.getElementById('progressBar');
  
  if (passedCountEl) passedCountEl.textContent = String(passed);
  if (progressPctEl) {
    const pct = Math.round((passed/total)*100);
    progressPctEl.textContent = String(pct);
  }
  if (progressBar) {
    const pct = Math.round((passed/total)*100);
    progressBar.style.width = pct + '%';
  }

  // NEW: mastery button & celebration
  ensureMasteryButton();
  const masterBtn = document.getElementById('btnMasterCertificate');
  if (masterBtn) {
    masterBtn.disabled = passed !== total;
    masterBtn.style.opacity = passed === total ? '1' : '.6';
    masterBtn.title = passed === total ? 'Download your Master Certificate' : `Pass all ${total} modules to unlock`;
  }

  if (passed === total) maybeCelebrateMastery(); // confetti + modal (once)
}

// NEW: Mastery UI and celebration functions
function ensureMasteryButton(){
  const summary = document.getElementById('summary');
  if (!summary) return;
  if (document.getElementById('btnMasterCertificate')) return;

  const wrap = document.createElement('div');
  wrap.style.cssText = 'margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;';

  const btn = document.createElement('button');
  btn.id = 'btnMasterCertificate';
  btn.className = 'btn';
  btn.style.cssText = 'background:#0ea5e9;border-color:#0ea5e9;';
  btn.textContent = 'Download Master Certificate';
  btn.disabled = true;
  btn.style.opacity = '.6';
  btn.addEventListener('click', () => showMasteryModal());

  const btnTranscript = document.createElement('button');
  btnTranscript.id = 'btnMasterTranscript';
  btnTranscript.className = 'btn secondary';
  btnTranscript.textContent = 'Download Module Results';
  btnTranscript.addEventListener('click', () => window.downloadMasterTranscriptPDF());

  wrap.appendChild(btn);
  wrap.appendChild(btnTranscript);
  summary.appendChild(wrap);
}

// One-time celebration modal + mega confetti
function maybeCelebrateMastery(){
  // Prevent repeat on reload; reset if you want by clearing localStorage key
  if (localStorage.getItem('ar_mastery_celebrated') === 'yes') return;
  localStorage.setItem('ar_mastery_celebrated', 'yes');
  fireMegaConfetti();
  showMasteryModal();
}

function fireMegaConfetti(){
  // a bigger show than pass-per-module
  const bursts = [
    {particleCount: 180, spread: 80, startVelocity: 45},
    {particleCount: 120, spread: 120, startVelocity: 55},
    {particleCount: 200, spread: 70, startVelocity: 50},
  ];
  let t = 0;
  bursts.forEach(b => {
    setTimeout(() => confetti({ ...b, origin: { x: 0.5, y: 0.6 } }), t);
    t += 250;
  });
  // side cannons
  setTimeout(()=> confetti({ particleCount: 140, angle: 60, spread: 55, origin: { x: 0 } }), 500);
  setTimeout(()=> confetti({ particleCount: 140, angle: 120, spread: 55, origin: { x: 1 } }), 600);
}

function showMasteryModal(){
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:10000;
    display:flex; align-items:center; justify-content:center; padding:16px;
  `;
  modal.innerHTML = `
    <div style="background:#fff; border-radius:12px; max-width:680px; width:100%;
                box-shadow:0 24px 60px rgba(0,0,0,.2); overflow:hidden">
      <div style="padding:22px 24px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:12px;">
        <div style="width:40px; height:40px; border-radius:999px; background:#e6f7ed; color:#067647; display:flex; align-items:center; justify-content:center; font-size:22px;">‚úì</div>
        <h3 style="margin:0;font-size:20px;">All 15 Modules Passed ‚Äî Congratulations!</h3>
        <button onclick="this.closest('.modal').remove()" style="margin-left:auto; background:none; border:none; font-size:24px; cursor:pointer; color:#666;">&times;</button>
      </div>
      <div style="padding:20px 24px; line-height:1.5; color:#333;">
        <p>You've successfully completed and passed all 15 Camera Settings modules.</p>
        <p>Your <strong>Master Certificate</strong> recognises you as a <em>Competent Technical Photographer</em>.</p>
        
        <div style="margin:16px 0;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #067647;">
            Name for Master Certificate:
          </label>
          <input type="text" id="masterCertificateName" placeholder="Enter your full name" 
                 style="width: 100%; padding: 8px 12px; border: 1px solid #b7f0d2; border-radius: 6px; background: #fff;">
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            This name will appear on your Master Certificate
          </div>
        </div>
        
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <button id="btn-modal-master-cert" class="btn" style="background:#0ea5e9;border-color:#0ea5e9;">Download Master Certificate</button>
          <button id="btn-modal-transcript" class="btn secondary">Download Module Results</button>
        </div>
      </div>
    </div>
  `;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
  
  // Add event listeners for modal buttons
  const masterCertBtn = modal.querySelector('#btn-modal-master-cert');
  const transcriptBtn = modal.querySelector('#btn-modal-transcript');
  
  masterCertBtn?.addEventListener('click', () => {
    debugLog('üîç Modal Master Certificate button clicked');
    // Capture the name from the input field before generating PDF
    const nameInput = document.getElementById('masterCertificateName');
    const capturedName = nameInput?.value?.trim() || '';
    debugLog('üîç Captured name from input:', capturedName);
    window.downloadMasterCertificatePDF(capturedName);
  });
  
  transcriptBtn?.addEventListener('click', () => {
    debugLog('üîç Modal Transcript button clicked');
    window.downloadMasterTranscriptPDF();
  });
  
  // Populate the name field with user's name (only if empty)
  setTimeout(async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const nameInput = document.getElementById('masterCertificateName');
        if (nameInput && !nameInput.value.trim()) {
          const defaultName = user.user_metadata?.full_name || user.user_metadata?.name || user.email.split('@')[0] || '';
          nameInput.value = defaultName;
          debugLog('üîç Populated name field with:', defaultName);
        }
      }
    } catch (e) {
      debugLog('Could not populate name field:', e);
    }
  }, 100);
}

// Cache for user status to prevent excessive re-fetching
let userStatusCache = {};
let lastCacheTime = 0;
const CACHE_DURATION = 30000; // 30 seconds

// Debounce auth state changes to prevent excessive calls
let authStateChangeTimeout = null;

async function fetchStatusForUser(user, forceRefresh = false) {
  if (!user) {
    debugLog('‚ö†Ô∏è fetchStatusForUser: No user provided');
    return {};
  }
  
  const now = Date.now();
  const cacheKey = user.id;
  
  // Check cache first (unless force refresh)
  if (!forceRefresh && userStatusCache[cacheKey] && (now - lastCacheTime) < CACHE_DURATION) {
    debugLog('üìã Using cached status for user: ' + user.email);
    return userStatusCache[cacheKey];
  }
  
  debugLog('üîç Fetching status for user: ' + user.email + ' (ID: ' + user.id + ')');
  
  try {
    debugLog('üîç Starting Supabase query...');
    
    // Add timeout to prevent hanging
    const queryPromise = supabase
      .from('module_results')
      .select('module_id, score_percent, passed, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Query timeout after 5 seconds')), 5000)
    );
    
    const { data, error } = await Promise.race([queryPromise, timeoutPromise]);
    
    debugLog('üîç Supabase query completed');
    
    if (error) {
      debugLog('‚ùå Error fetching status: ' + JSON.stringify(error));
      return userStatusCache[cacheKey] || {};
    }
    
    if (!data) {
      debugLog('‚ö†Ô∏è No data returned from fetchStatusForUser');
      return userStatusCache[cacheKey] || {};
    }
    
    debugLog('üìã Raw data from DB: ' + JSON.stringify(data));
    debugLog('üìã Data length: ' + data.length);
    
    const latest = {};
    for (const row of data) {
      if (!latest[row.module_id]) {
        latest[row.module_id] = {
          score: row.score_percent,
          passed: row.passed,
          when: row.created_at
        };
      }
    }
    
    // Update cache
    userStatusCache[cacheKey] = latest;
    lastCacheTime = now;
    
    debugLog('üìä Processed status: ' + JSON.stringify(latest));
    return latest;
  } catch (err) {
    debugLog('‚ùå Exception in fetchStatusForUser: ' + err.message);
    return userStatusCache[cacheKey] || {};
  }
}

window.loadExam = async function(moduleId) {
  debugLog('üîç loadExam called with moduleId:', moduleId);
  
  // Check Memberstack authentication first
  if (!memberstackIdentity) {
    // Try to get identity
    memberstackIdentity = await getExamIdentity();
  }
  
  if (!memberstackIdentity) {
    // Show auth message in quiz view
    const quizAuthMessage = document.getElementById('quizAuthMessage');
    const quizContainer = document.getElementById('quiz-container');
    if (quizAuthMessage) quizAuthMessage.style.display = 'block';
    if (quizContainer) quizContainer.style.display = 'none';
    showToast('Please sign in to the Academy dashboard to use exams.', 'error');
    return;
  }
  
  // Hide auth message if authenticated
  const quizAuthMessage = document.getElementById('quizAuthMessage');
  if (quizAuthMessage) quizAuthMessage.style.display = 'none';
  
  // Close any existing modal
  const existingModal = document.querySelector('.modal');
  if (existingModal) {
    debugLog('üîç Closing existing modal');
    existingModal.remove();
  }
  
  try {
    debugLog('üîç Loading module from GitHub Pages...');
    // Load module from GitHub Pages (modular system)
    const moduleData = await loadModuleFromGitHub(moduleId);
    debugLog('üîç Module data loaded:', moduleData);
    
    // Use the module data from GitHub Pages
    currentQuizConfig = moduleData;
    
    // Clear any previous results/progress for this module
    clearPreviousResults();
    
    // Show quiz container, hide grid
    debugLog('üîç Switching to quiz view...');
    document.getElementById('grid-container').style.display = 'none';
    document.getElementById('quiz-container').style.display = 'block';
    
    // Update the quiz title
    const titleElement = document.querySelector('#quiz-container h2');
    if (titleElement) {
      titleElement.textContent = `${currentQuizConfig.moduleTitle} Assessment`;
      debugLog('üîç Updated quiz title to:', titleElement.textContent);
    }
    
    // Clear and re-render quiz with new questions
    const quizForm = document.getElementById('quiz-form');
    if (quizForm) {
      quizForm.innerHTML = ''; // Clear existing questions
      debugLog('üßπ Cleared quiz form for module:', moduleId);
    } else {
      debugLog('‚ùå Quiz form not found!');
    }
    
    // Re-initialize quiz with new config
    debugLog('üîÑ Re-initializing quiz with config:', currentQuizConfig.moduleId);
    initQuiz();
    debugLog('üîç initQuiz() called successfully');
    
    // Populate name field if user is signed in
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (user && user.email) {
        const nameField = document.getElementById('name');
        const emailField = document.getElementById('email');
        
        if (nameField) {
          // Clear the name field and show red background to prompt user input
          nameField.value = '';
          nameField.style.backgroundColor = '#fff5f5';
          nameField.style.borderColor = '#fca5a5';
          
          // Add event listener to change background when user types
          nameField.addEventListener('input', function() {
            if (this.value.trim().length > 0) {
              this.style.backgroundColor = '#fff';
              this.style.borderColor = '#10b981';
            } else {
              this.style.backgroundColor = '#fff5f5';
              this.style.borderColor = '#fca5a5';
            }
          });
        }
        
        if (emailField && !emailField.value) {
          emailField.value = user.email;
        }
      }
    } catch (error) {
      debugLog('‚ùå Error populating user fields:', error);
    }
    
  } catch (error) {
    console.error('Error loading module:', error);
    
    // Check if it's a "not found" error (module doesn't exist yet)
    if (error.message.includes('404') || error.message.includes('Failed to load module')) {
      showToast('This module is coming soon! Only Modules 1-3 are currently available.', 'warn');
    } else {
      showToast(`Failed to load module ${moduleId}`, 'err');
    }
  }
}

async function backToGrid() {
  debugLog('üîô Returning to grid from quiz');
  
  document.getElementById('quiz-container').style.display = 'none';
  document.getElementById('grid-container').style.display = 'block';
  
  // Wait a moment for DOM to update
  await new Promise(resolve => setTimeout(resolve, 500));
  
  // Refresh grid with updated results
  // PRIORITY: Use Memberstack if available, fallback to Supabase legacy
  try {
    // Check for Memberstack first
    if (!memberstackIdentity) {
      memberstackIdentity = await getExamIdentity();
    }
    
    if (memberstackIdentity) {
      debugLog('üîÑ Refreshing grid with Memberstack data...');
      const statusByModule = {};
      
      // Fetch status for all modules
      for (const module of modules) {
        try {
          const status = await getLatestStatusViaMemberstack(module.id);
          if (status) {
            statusByModule[module.id] = {
              score: status.score_percent,
              passed: status.passed,
              when: status.created_at
            };
          }
        } catch (err) {
          debugLog(`‚ö†Ô∏è Error fetching status for ${module.id}:`, err.message);
        }
      }
      
      debugLog('üìä Refreshed status for modules:', Object.keys(statusByModule).length);
      renderSummary(statusByModule);
      renderGrid(statusByModule);
      debugLog('‚úÖ Grid refreshed with Memberstack data');
    } else {
      // Fallback to Supabase legacy
      debugLog('üîç Getting current user (Supabase legacy)...');
      const { data: { user } } = await supabase.auth.getUser();
      debugLog('üë§ Current user: ' + (user ? user.email : 'None'));
      
      if (user) {
        debugLog('üîÑ Fetching user status (Supabase legacy)...');
        const status = await fetchStatusForUser(user);
        debugLog('üìä Fetched status: ' + JSON.stringify(status));
        
        debugLog('üé® Rendering summary and grid...');
        renderSummary(status);
        renderGrid(status);
        
        debugLog('‚úÖ Grid refreshed with updated results');
      } else {
        debugLog('‚ö†Ô∏è No user found, clearing grid');
        renderSummary({});
        renderGrid({});
      }
    }
  } catch (error) {
    debugLog('‚ùå Error refreshing grid: ' + error.message);
    debugLog('‚ùå Error stack: ' + error.stack);
  }
}

// Check URL parameters for direct exam access
function checkUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const moduleId = urlParams.get('m');
  if (moduleId === 'module-01-exposure') {
    setTimeout(() => loadExam(moduleId), 100);
  }
}

// Debug functions
function debugLog(message) {
  try {
    const debugContent = document.getElementById('debugContent');
    if (debugContent) {
      const timestamp = new Date().toLocaleTimeString();
      debugContent.textContent += `[${timestamp}] ${message}\n`;
      debugContent.scrollTop = debugContent.scrollHeight;
    }
    console.log(message);
  } catch (error) {
    console.log('Debug error:', error);
  }
}

function showDebugPanel() {
  const panel = document.getElementById('debugPanel');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }
}

// Comprehensive debug panel that collects all diagnostic data
let debugData = {
  timestamp: new Date().toISOString(),
  pageUrl: window.location.href,
  apiBase: 'NOT_LOADED_YET',
  memberstackClient: null,
  memberstackIdentity: null,
  cookies: {},
  apiCalls: [],
  errors: [],
  supabaseStatus: null
};

function updateDebugPanel() {
  try {
    const content = document.getElementById('debugContent');
    if (!content) {
      console.warn('Debug panel content not found');
      return;
    }
    
    // Update debugData with current values (safe access)
    debugData.pageUrl = window.location.href;
    try {
      debugData.apiBase = typeof EXAMS_API_BASE !== 'undefined' ? EXAMS_API_BASE : 'NOT_LOADED_YET';
    } catch (e) {
      debugData.apiBase = 'ERROR: ' + e.message;
    }
    
    let html = '';
    
    // API Configuration
    html += '<div class="debug-section">';
    html += '<div class="debug-section-title">üîß API Configuration</div>';
    html += `<div class="debug-item"><span class="debug-label">API Base:</span><span class="debug-value ${!debugData.apiBase || debugData.apiBase === 'UNDEFINED' ? 'error' : 'info'}">${debugData.apiBase || 'UNDEFINED'}</span></div>`;
    html += `<div class="debug-item"><span class="debug-label">Page URL:</span><span class="debug-value info">${debugData.pageUrl}</span></div>`;
    html += `<div class="debug-item"><span class="debug-label">Timestamp:</span><span class="debug-value info">${new Date().toLocaleTimeString()}</span></div>`;
    html += '</div>';
  
  // Memberstack Client API
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">üë§ Memberstack Client API</div>';
  const msAvailable = window.$memberstackDom && typeof window.$memberstackDom.getCurrentMember === 'function';
  html += `<div class="debug-item"><span class="debug-label">Available:</span><span class="debug-value ${msAvailable ? 'info' : 'error'}">${msAvailable ? 'YES' : 'NO'}</span></div>`;
  if (debugData.memberstackClient) {
    html += `<div class="debug-item"><span class="debug-label">Member ID:</span><span class="debug-value info">${debugData.memberstackClient.id || 'N/A'}</span></div>`;
    html += `<div class="debug-item"><span class="debug-label">Email:</span><span class="debug-value info">${debugData.memberstackClient.email || 'N/A'}</span></div>`;
  } else {
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value warning">Not checked yet</span></div>`;
  }
  html += '</div>';
  
  // Memberstack Identity (from API)
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">üîê Memberstack Identity (API)</div>';
  if (debugData.memberstackIdentity) {
    html += `<div class="debug-item"><span class="debug-label">Member ID:</span><span class="debug-value info">${debugData.memberstackIdentity.memberstack_id || 'N/A'}</span></div>`;
    html += `<div class="debug-item"><span class="debug-label">Email:</span><span class="debug-value info">${debugData.memberstackIdentity.email || 'N/A'}</span></div>`;
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value info">‚úÖ Authenticated</span></div>`;
  } else {
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value error">‚ùå Not authenticated</span></div>`;
  }
  html += '</div>';
  
  // Cookies
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">üç™ Cookies</div>';
  const allCookies = document.cookie;
  if (allCookies) {
    const cookies = allCookies.split(';').map(c => c.trim());
    html += `<div class="debug-item"><span class="debug-label">Total Cookies:</span><span class="debug-value info">${cookies.length}</span></div>`;
    const msCookie = cookies.find(c => c.startsWith('_ms-mid='));
    if (msCookie) {
      const token = decodeURIComponent(msCookie.split('=').slice(1).join('='));
      html += `<div class="debug-item"><span class="debug-label">_ms-mid:</span><span class="debug-value info">Found (${token.length} chars)</span></div>`;
    } else {
      html += `<div class="debug-item"><span class="debug-label">_ms-mid:</span><span class="debug-value error">NOT FOUND</span></div>`;
    }
    html += `<div class="debug-item"><span class="debug-label">All Cookie Names:</span><span class="debug-value info">${cookies.map(c => c.split('=')[0]).join(', ')}</span></div>`;
  } else {
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value error">No cookies found</span></div>`;
  }
  html += '</div>';
  
  // API Calls
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">üì° API Calls</div>';
  if (debugData.apiCalls.length === 0) {
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value warning">No API calls yet</span></div>`;
  } else {
    debugData.apiCalls.slice(-5).reverse().forEach(call => {
      const statusClass = call.status >= 200 && call.status < 300 ? 'info' : call.status === 401 ? 'warning' : 'error';
      html += `<div class="debug-item"><span class="debug-label">${call.method} ${call.url}:</span><span class="debug-value ${statusClass}">${call.status} ${call.statusText || ''}</span></div>`;
      if (call.error) {
        html += `<div class="debug-item" style="padding-left:20px;"><span class="debug-value error">${call.error}</span></div>`;
      }
    });
  }
  html += '</div>';
  
  // Errors
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">‚ùå Errors</div>';
  if (debugData.errors.length === 0) {
    html += `<div class="debug-item"><span class="debug-label">Status:</span><span class="debug-value info">No errors</span></div>`;
  } else {
    debugData.errors.slice(-3).reverse().forEach(err => {
      html += `<div class="debug-item"><span class="debug-value error">${err}</span></div>`;
    });
  }
  html += '</div>';
  
  // Supabase Status
  html += '<div class="debug-section">';
  html += '<div class="debug-section-title">üóÑÔ∏è Supabase</div>';
  const supabaseReady = typeof supabase !== 'undefined' && supabase && supabase.auth;
  html += `<div class="debug-item"><span class="debug-label">Initialized:</span><span class="debug-value ${supabaseReady ? 'info' : 'error'}">${supabaseReady ? 'YES' : 'NO'}</span></div>`;
  html += '</div>';
  
    content.innerHTML = html;
  } catch (e) {
    console.error('updateDebugPanel error:', e);
    const content = document.getElementById('debugContent');
    if (content) {
      content.innerHTML = '<div class="debug-section"><div class="debug-section-title">‚ùå Error</div><div class="debug-item"><span class="debug-value error">Failed to update debug panel: ' + e.message + '</span></div></div>';
    }
  }
}

function logApiCall(method, url, status, statusText, error) {
  debugData.apiCalls.push({
    method,
    url,
    status,
    statusText,
    error,
    timestamp: new Date().toISOString()
  });
  if (debugData.apiCalls.length > 20) debugData.apiCalls.shift();
  updateDebugPanel();
}

function logError(message) {
  debugData.errors.push(`${new Date().toLocaleTimeString()}: ${message}`);
  if (debugData.errors.length > 10) debugData.errors.shift();
  updateDebugPanel();
}

function copyDebugInfo() {
  // Collect all debug data into a formatted string
  let text = '=== EXAM DEBUG INFORMATION ===\n\n';
  text += `Timestamp: ${new Date().toISOString()}\n`;
  text += `Page URL: ${debugData.pageUrl}\n`;
  text += `API Base: ${debugData.apiBase}\n\n`;
  
  text += '--- Memberstack Client API ---\n';
  const msAvailable = window.$memberstackDom && typeof window.$memberstackDom.getCurrentMember === 'function';
  text += `Available: ${msAvailable ? 'YES' : 'NO'}\n`;
  if (debugData.memberstackClient) {
    text += `Member ID: ${debugData.memberstackClient.id || 'N/A'}\n`;
    text += `Email: ${debugData.memberstackClient.email || 'N/A'}\n`;
  } else {
    text += 'Status: Not checked yet\n';
  }
  text += '\n';
  
  text += '--- Memberstack Identity (API) ---\n';
  if (debugData.memberstackIdentity) {
    text += `Member ID: ${debugData.memberstackIdentity.memberstack_id || 'N/A'}\n`;
    text += `Email: ${debugData.memberstackIdentity.email || 'N/A'}\n`;
    text += 'Status: ‚úÖ Authenticated\n';
  } else {
    text += 'Status: ‚ùå Not authenticated\n';
  }
  text += '\n';
  
  text += '--- Cookies ---\n';
  const allCookies = document.cookie;
  if (allCookies) {
    const cookies = allCookies.split(';').map(c => c.trim());
    text += `Total Cookies: ${cookies.length}\n`;
    const msCookie = cookies.find(c => c.startsWith('_ms-mid='));
    if (msCookie) {
      const token = decodeURIComponent(msCookie.split('=').slice(1).join('='));
      text += `_ms-mid: Found (${token.length} chars)\n`;
    } else {
      text += '_ms-mid: NOT FOUND\n';
    }
    text += `All Cookie Names: ${cookies.map(c => c.split('=')[0]).join(', ')}\n`;
  } else {
    text += 'Status: No cookies found\n';
  }
  text += '\n';
  
  text += '--- API Calls (Last 10) ---\n';
  if (debugData.apiCalls.length === 0) {
    text += 'No API calls yet\n';
  } else {
    debugData.apiCalls.slice(-10).reverse().forEach(call => {
      text += `${call.method} ${call.url}: ${call.status} ${call.statusText || ''}\n`;
      if (call.error) {
        text += `  Error: ${call.error}\n`;
      }
      text += `  Time: ${new Date(call.timestamp).toLocaleTimeString()}\n`;
    });
  }
  text += '\n';
  
  text += '--- Errors (Last 10) ---\n';
  if (debugData.errors.length === 0) {
    text += 'No errors\n';
  } else {
    debugData.errors.slice(-10).reverse().forEach(err => {
      text += `${err}\n`;
    });
  }
  text += '\n';
  
  text += '--- Supabase ---\n';
  const supabaseReady = typeof supabase !== 'undefined' && supabase && supabase.auth;
  text += `Initialized: ${supabaseReady ? 'YES' : 'NO'}\n`;
  text += '\n';
  
  text += '=== END DEBUG INFO ===\n';
  
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('debugCopy');
    if (btn) {
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('copied');
      }, 2000);
    }
  }).catch(err => {
    alert('Failed to copy: ' + err.message);
  });
}

// Debug function to reset mastery celebration (for testing)
function resetMasteryCelebration() {
  localStorage.removeItem('ar_mastery_celebrated');
  showToast('Mastery celebration reset. Complete all 15 modules to trigger again.', 'info');
}

// Bulletproof event delegation using data attributes
// Simplified event handling - all buttons now use direct onclick handlers
// No complex event delegation needed

/* ---------- API CONFIGURATION ---------- */
// ‚ö†Ô∏è CRITICAL: This must point to your Vercel deployment URL
// 
// Your Vercel project URL is likely one of these:
// - https://alanranger-modules.vercel.app (default Vercel domain)
// - https://api.alanranger.com (if you've set up a custom domain in Vercel)
//
// To verify: Go to Vercel Dashboard ‚Üí Your Project ‚Üí Check the deployment URL
// If the domain below doesn't work, update it to your actual Vercel URL
const EXAMS_API_BASE = "https://alanranger-modules.vercel.app"; // Update if different

/**
 * Get Memberstack token using client-side API (preferred) or cookie fallback
 * @returns {Promise<string|null>} - Token or null
 */
async function getMemberstackToken() {
  try {
    // Method 1: Try to get token from Memberstack client API session
    if (window.$memberstackDom) {
      try {
        // Check if there's a getSessionToken or similar method
        if (typeof window.$memberstackDom.getSessionToken === 'function') {
          const token = await window.$memberstackDom.getSessionToken();
          if (token) {
            console.log("[getMemberstackToken] Token from getSessionToken()");
            return token;
          }
        }
        // Check if member object has a token property
        const member = await window.$memberstackDom.getCurrentMember();
        if (member && member.token) {
          console.log("[getMemberstackToken] Token from member object");
          return member.token;
        }
        if (member && member.data && member.data.token) {
          console.log("[getMemberstackToken] Token from member.data");
          return member.data.token;
        }
      } catch (e) {
        console.warn("[getMemberstackToken] Client API token check error:", e);
      }
    }
    
    // Method 2: Try to get token from cookie (fallback)
    const allCookies = document.cookie;
    if (!allCookies) {
      console.log("[getMemberstackToken] No cookies found");
      return null;
    }
    
    const cookies = allCookies.split(';').map(c => c.trim());
    const variations = ['_ms-mid', '_ms_mid', 'ms-mid', 'ms_mid', 'memberstack-token', 'ms_token'];
    
    for (const varName of variations) {
      const found = cookies.find(c => c.startsWith(varName + '='));
      if (found) {
        const token = decodeURIComponent(found.split('=').slice(1).join('='));
        console.log("[getMemberstackToken] Token found from cookie:", varName, "length:", token.length);
        return token;
      }
    }
    
    console.log("[getMemberstackToken] No token found - cookie _ms-mid is missing");
    console.log("[getMemberstackToken] Available cookies:", cookies.map(c => c.split('=')[0]).join(', '));
    return null;
  } catch (e) {
    console.error("[getMemberstackToken] Error:", e);
    return null;
  }
}

/**
 * Get headers for API requests (includes Authorization if token available)
 * @param {object} additionalHeaders - Additional headers to include
 * @returns {object} - Headers object
 */
async function getApiHeaders(additionalHeaders = {}) {
  const headers = {
    "Content-Type": "application/json",
    ...additionalHeaders
  };
  
  const token = await getMemberstackToken();
  if (token) {
    headers["Authorization"] = `Bearer ${token}`;
    console.log("[getApiHeaders] Added Authorization header with token (length:", token.length, ")");
  } else {
    console.warn("[getApiHeaders] No token available - using member ID fallback");
  }
  
  // ALWAYS include member ID header as fallback (even if we have a token)
  // This ensures migration works even if token verification fails
  if (memberstackIdentity && memberstackIdentity.memberstack_id) {
    headers["X-Memberstack-Id"] = memberstackIdentity.memberstack_id;
    console.log("[getApiHeaders] Added X-Memberstack-Id header:", memberstackIdentity.memberstack_id);
  } else {
    console.error("[getApiHeaders] WARNING: No memberstackIdentity available!");
  }
  
  return headers;
}

/* ---------- MEMBERSTACK API FUNCTIONS ---------- */
let memberstackIdentity = null; // { memberstack_id, email, permissions, planConnections }
let memberstackDataLoaded = false; // Flag to prevent clearing grid after Memberstack data is loaded

/**
 * Get Memberstack identity via API
 * Returns { memberstack_id, email, permissions, planConnections } or null
 */
async function getExamIdentity() {
  try {
    updateDebugPanel();
    
    // Check if Memberstack client API is available
    if (window.$memberstackDom && typeof window.$memberstackDom.getCurrentMember === 'function') {
      try {
        // Add timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Memberstack API timeout after 5s')), 5000)
        );
        
        const member = await Promise.race([
          window.$memberstackDom.getCurrentMember(),
          timeoutPromise
        ]);
        
        if (member && member.data) {
          debugData.memberstackClient = {
            id: member.data.id,
            email: member.data.auth?.email || null
          };
          // Use client API member data directly
          memberstackIdentity = {
            memberstack_id: member.data.id,
            email: member.data.auth?.email || null,
            permissions: member.data.permissions || [],
            planConnections: member.data.planConnections || []
          };
          debugData.memberstackIdentity = memberstackIdentity;
          updateDebugPanel();
          
          // Update email field with Memberstack email (ALWAYS, even if already set)
          if (memberstackIdentity.email) {
            const emailField = document.getElementById('email');
            if (emailField) {
              emailField.value = memberstackIdentity.email;
              debugLog('‚úÖ Updated email field with Memberstack email:', memberstackIdentity.email);
              // Clear any pending email from localStorage since we have Memberstack auth
              localStorage.removeItem('ar_pending_email');
            }
          }
          
          return memberstackIdentity;
        }
      } catch (e) {
        logError(`Client API failed: ${e.message}`);
        updateDebugPanel();
      }
    }
    
    // Fallback: Use server API with token
    try {
      const headers = await getApiHeaders();
      const url = `${EXAMS_API_BASE}/api/exams/whoami`;
      
      // Add timeout to fetch
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const r = await fetch(url, {
        headers: headers,
        credentials: "include",
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      logApiCall('GET', url, r.status, r.statusText);
      
      if (!r.ok) {
        const errorText = await r.text().catch(() => "Could not read error");
        logApiCall('GET', url, r.status, r.statusText, errorText);
        updateDebugPanel();
        return null;
      }
      
      const data = await r.json();
      memberstackIdentity = data;
      debugData.memberstackIdentity = data;
      updateDebugPanel();
      
      // Update email field with Memberstack email (ALWAYS, even if already set)
      if (memberstackIdentity && memberstackIdentity.email) {
        const emailField = document.getElementById('email');
        if (emailField) {
          emailField.value = memberstackIdentity.email;
          debugLog('‚úÖ Updated email field with Memberstack email:', memberstackIdentity.email);
          // Clear any pending email from localStorage since we have Memberstack auth
          localStorage.removeItem('ar_pending_email');
        }
      }
      
      return data;
    } catch (e) {
      if (e.name === 'AbortError') {
        logError(`Server API timeout: Request took longer than 5s`);
      } else {
        logError(`Server API failed: ${e.message}`);
      }
      updateDebugPanel();
      return null;
    }
  } catch (e) {
    logError(`getExamIdentity exception: ${e.message}`);
    updateDebugPanel();
    return null;
  }
}

/**
 * Save results via Memberstack API
 */
async function saveResultsViaMemberstack(report) {
  if (!memberstackIdentity) {
    throw new Error("Not authenticated");
  }
  
  // Calculate attempt number
  const latestStatus = await getLatestStatusViaMemberstack(report.moduleId);
  const attempt = latestStatus ? (latestStatus.attempt || 0) + 1 : 1;
  
  // ALWAYS use Memberstack identity email, never the form field
  const emailToUse = memberstackIdentity?.email || null;
  if (!emailToUse) {
    debugLog('‚ö†Ô∏è WARNING: No email in memberstackIdentity, cannot save');
    throw new Error("No email in Memberstack identity");
  }
  
  debugLog('üíæ Saving with Memberstack email:', emailToUse);
  
  const payload = {
    module_id: report.moduleId,
    score_percent: report.percent || report.score,
    passed: report.pass || report.passed,
    attempt: attempt,
    details: { misses: report.misses || [] },
    email: emailToUse // Always use Memberstack identity email
  };
  
  const headers = await getApiHeaders();
  debugLog('üíæ Sending save request:', {
    url: `${EXAMS_API_BASE}/api/exams/save`,
    method: 'POST',
    headers: Object.keys(headers),
    payload: { ...payload, details: '[object]' } // Don't log full details
  });
  
  const r = await fetch(`${EXAMS_API_BASE}/api/exams/save`, {
    method: "POST",
    headers: headers,
    credentials: "include",
    body: JSON.stringify(payload)
  });
  
  debugLog(`üíæ Save response status: ${r.status} ${r.statusText}`);
  
  if (!r.ok) {
    const errorText = await r.text().catch(() => "Failed to save");
    let errorObj;
    try {
      errorObj = JSON.parse(errorText);
    } catch {
      errorObj = { error: errorText };
    }
    logError(`Save failed: ${r.status} ${errorObj.error || errorText}`);
    debugLog(`‚ùå Save failed: ${r.status}`, errorObj);
    throw new Error(errorObj.error || `Failed to save (${r.status})`);
  }
  
  const result = await r.json();
  debugLog(`‚úÖ Save successful for ${report.moduleId}:`, result);
  console.log(`[saveResultsViaMemberstack] Successfully saved exam result for ${emailToUse}`);
  return result;
}

/**
 * Get latest exam status via Memberstack API
 */
async function getLatestStatusViaMemberstack(moduleId) {
  // Try to get identity if not set
  if (!memberstackIdentity) {
    debugLog(`‚ö†Ô∏è memberstackIdentity not set, attempting to get it...`);
    memberstackIdentity = await getExamIdentity();
    if (!memberstackIdentity) {
      debugLog(`‚ùå Cannot fetch status - no Memberstack identity`);
      return null;
    }
  }
  
  try {
    const headers = await getApiHeaders();
    const url = `${EXAMS_API_BASE}/api/exams/status?moduleId=${encodeURIComponent(moduleId)}`;
    
    debugLog(`üîç Fetching status for ${moduleId} with member ID: ${memberstackIdentity?.memberstack_id || 'N/A'}`);
    
    const r = await fetch(url, {
      headers: headers,
      credentials: "include"
    });
    
    logApiCall('GET', url, r.status, r.statusText, r.ok ? null : await r.text().catch(() => ''));
    
    if (!r.ok) {
      const errorText = await r.text().catch(() => '');
      logError(`Status API failed for ${moduleId}: ${r.status} ${errorText}`);
      return null;
    }
    
    const j = await r.json();
    const result = j.latest || null;
    
    // Debug logging
    if (result) {
      debugLog(`‚úÖ Status for ${moduleId}: score=${result.score_percent}, passed=${result.passed}, attempt=${result.attempt}`);
    } else {
      debugLog(`‚ö†Ô∏è No status found for ${moduleId} (API returned null)`);
    }
    
    return result;
  } catch (e) {
    logError(`getLatestStatusViaMemberstack error for ${moduleId}: ${e.message}`);
    console.error("[getLatestStatusViaMemberstack] Error:", e);
    return null;
  }
}

/**
 * Check if migration is needed (legacy results exist for this email)
 */
async function checkMigrationNeeded() {
  if (!memberstackIdentity) return false;
  
  try {
    // Check status for one module to see if we have Memberstack results
    const status = await getLatestStatusViaMemberstack('module-01-exposure');
    
    // If no Memberstack results, check if we should show migration button
    // We'll show it if user has no results in module_results_ms
    // For now, we'll show it if status is null (no results yet)
    const btnMigrateLegacy = document.getElementById('btnMigrateLegacy');
    if (btnMigrateLegacy && !status) {
      // Could have legacy results - show button
      btnMigrateLegacy.style.display = 'inline-block';
    }
    
    return !status;
  } catch (e) {
    console.error("[checkMigrationNeeded] Error:", e);
    return false;
  }
}

/**
 * Migrate legacy exam results to Memberstack
 */
async function migrateLegacyResults() {
  if (!memberstackIdentity) {
    showToast('Please sign in to Academy first', 'error');
    return;
  }
  
  try {
    showToast('Migrating legacy results...', 'info');
    logError('Starting migration for: ' + memberstackIdentity.email);
    logError('Member ID: ' + memberstackIdentity.memberstack_id);
    
    const headers = await getApiHeaders();
    logError('Headers being sent: ' + JSON.stringify(headers, null, 2));
    
    const url = `${EXAMS_API_BASE}/api/exams/migrate`;
    
    // Send email in body as fallback since member retrieval sometimes returns null
    const requestBody = {
      email: memberstackIdentity?.email || null
    };
    
    const r = await fetch(url, {
      method: "POST",
      headers: headers,
      credentials: "include",
      body: JSON.stringify(requestBody)
    });
    
    const responseText = await r.text().catch(() => '');
    logApiCall('POST', url, r.status, r.statusText, r.ok ? null : responseText);
    
    if (!r.ok) {
      const error = responseText ? JSON.parse(responseText) : { error: "Migration failed" };
      logError(`Migration failed: ${r.status} ${error.error || responseText}`);
      logError('Response headers: ' + JSON.stringify([...r.headers.entries()], null, 2));
      throw new Error(error.error || "Migration failed");
    }
    
    // Parse the response text as JSON (we already read it as text above)
    const result = responseText ? JSON.parse(responseText) : { ok: true, count: 0 };
    logError(`Migration successful: ${result.message || `Migrated ${result.count || 0} results`}`);
    showToast(result.message || `Migrated ${result.count || 0} results`, 'success');
    
    // Hide migration button
    const btnMigrateLegacy = document.getElementById('btnMigrateLegacy');
    if (btnMigrateLegacy) btnMigrateLegacy.style.display = 'none';
    
    // Refresh status from Memberstack API
    debugLog('üîÑ Refreshing exam status after migration...');
    const statusByModule = {};
    for (const module of modules) {
      try {
        const status = await getLatestStatusViaMemberstack(module.id);
        if (status) {
          statusByModule[module.id] = {
            score: status.score_percent,
            passed: status.passed,
            when: status.created_at
          };
        }
      } catch (err) {
        debugLog(`‚ö†Ô∏è Error fetching status for ${module.id}:`, err.message);
      }
    }
    
    renderSummary(statusByModule);
    renderGrid(statusByModule);
    debugLog('‚úÖ Grid refreshed after migration');
    
    return result;
  } catch (e) {
    console.error("[migrateLegacyResults] Error:", e);
    logError(`Migration exception: ${e.message}`);
    showToast('Migration failed: ' + e.message, 'error');
    throw e;
  }
}

/* ---------- SUPABASE (your live values) ---------- */
const SUPABASE_URL = "https://dqrtcsvqsfgbqmnonkpt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxcnRjc3Zxc2ZnYnFtbm9ua3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTA4MjUsImV4cCI6MjA3MjU2NjgyNX0.e19j8NOUK5HWoTGZv4B62U_n0je_19Tp-F20qKGbWDk";
// Initialize Supabase client - wait for library to load if needed
var supabase;
(function initSupabase() {
  if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('[initSupabase] Supabase client initialized');
  } else {
    console.warn('[initSupabase] Supabase library not loaded yet, retrying...');
    setTimeout(initSupabase, 100);
  }
})();

/* ---------- BRANDING & LINKS ---------- */
const branding = {
  orange:"#F05922",
  logoUrl:"https://www.alanranger.com/s/ALAN-RANGER-LOGO-and-Icon-BLACK.png",
  academyUrl:"https://www.alanranger.com/s/alan-ranger-photography-academy-logo.png",
  signatureUrl:"https://www.alanranger.com/s/Alan-Ranger-black-high-res.png",
  emblemUrl:"https://www.alanranger.com/s/academy-emblem-ndsx.png",
  courseUrl:"https://www.alanranger.com/online-photography-course",
  exposureUrl:"https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography",
  siteUrl:"https://alanranger.com"
};

/* ---------- PDF HELPER FUNCTIONS ---------- */
function getImgDims(dataURL){ return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth,h:img.naturalHeight}); img.src=dataURL; }); }
function fitWithin(sw,sh,mw,mh){ const t=Math.min(mw/sw,mh/sh); return {w:sw*t,h:sh*t}; }
function slugify(s=""){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function formatDate(d){ return d.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); }
function writeWrapped(doc, text, x, y, maxWidth, lineHeight){ const lines=doc.splitTextToSize(text,maxWidth); lines.forEach(l=>{ doc.text(l,x,y); y+=lineHeight; }); return y; }
function escapeHtml(s=""){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c])); }

/* ---------- MODULE CONFIG ---------- */
const quizConfig = {
  moduleId:"module-01-exposure",
  moduleTitle:"Module 1: What is Exposure",
  passMarkPercent:80,
  questions:[
    { id:"q1", text:"What does the term exposure mean in photography?", options:[
      "Collecting the correct quantity of light for proper image brightness",
      "Collecting quality of light to capture the image",
      "Using autofocus to make the image sharp",
      "Ensuring the colour is right in the image"
    ], correctIndex:0, reviewHint:"Review the 'What is Exposure' definition section."},
    { id:"q2", text:"What 3 variables control exposure?", options:[
      "Aperture, Shutter Speed, ISO","The lens, Colour, Focusing","White Balance, Focus, Metering","Histogram, Composition, Lighting"
    ], correctIndex:0, reviewHint:"See the Exposure Triangle section (Aperture, Shutter Speed, ISO)."},
    { id:"q3", text:"What does the aperture control in photography?", options:[
      "Colour enhancement","Depth of Field","Shutter Speed","ISO"
    ], correctIndex:1, reviewHint:"See aperture section - aperture controls depth of field."},
    { id:"q4", text:"What does the shutter control in photography?", options:[
      "Colour and saturation","Length of exposure time","Sharpness of moving subjects","ISO"
    ], correctIndex:1, reviewHint:"Check shutter speed section - shutter controls exposure time."},
    { id:"q5", text:"What does the ISO control in photography?", options:[
      "Amount of digital noise (grain)","Image sharpness","Aperture","Shutter speed"
    ], correctIndex:0, reviewHint:"Review ISO section - ISO controls sensor sensitivity and noise."},
    { id:"q6", text:"If an image appears too dark, it is considered:", options:[
      "Overexposed","Underexposed","Correctly exposed","High contrast"
    ], correctIndex:1, reviewHint:"Check 'Underexposure vs Overexposure' with examples."},
    { id:"q7", text:"If an image appears too bright with lost highlight details, it is:", options:[
      "Overexposed","Underexposed","Correctly exposed","Low contrast"
    ], correctIndex:0, reviewHint:"Review overexposure effects - washed out highlights."},
    { id:"q8", text:"Why might a photographer deliberately over/underexpose?", options:[
      "To save battery life","To test different metering modes","To achieve a creative effect or mood","To avoid using ISO"
    ], correctIndex:2, reviewHint:"See 'Creative exposure choices' and examples."},
    { id:"q9", text:"What is the main purpose of the histogram?", options:[
      "To show camera battery level","To display image composition","To reveal exposure clipping in highlights/shadows","To show autofocus points"
    ], correctIndex:2, reviewHint:"See histogram section - it shows tonal distribution and clipping."},
    { id:"q10", text:"Exposure compensation (+/-) is used to:", options:[
      "Change the camera's metering mode","Quickly correct metering bias","Adjust the ISO setting","Change the aperture size"
    ], correctIndex:1, reviewHint:"Review exposure compensation section - quick correction for metering bias."},
    { id:"q11", text:"If you increase shutter speed without changing other settings, the image will:", options:[
      "Become darker","Become brighter","Stay the same brightness","Increase in depth of field"
    ], correctIndex:0, reviewHint:"Revisit 'Shutter speed and exposure' cause/effect."},
    { id:"q12", text:"The exposure triangle demonstrates that:", options:[
      "All three settings work independently","Changing one setting requires adjusting others to maintain exposure","Only aperture affects brightness","ISO is the most important setting"
    ], correctIndex:1, reviewHint:"See exposure triangle section - the three settings work together."}
  ],
  feedbackMap:{
    topics:[
      { key:"exposure-basics",label:"Exposure basics (definition)" },
      { key:"exposure-triangle",label:"The Exposure Triangle (Aperture, Shutter, ISO)" },
      { key:"aperture-control",label:"What aperture controls" },
      { key:"shutter-control",label:"What shutter controls" },
      { key:"iso-control",label:"What ISO controls" },
      { key:"under-over",label:"Underexposed vs Overexposed" },
      { key:"creative-exposure",label:"Creative exposure choices" },
      { key:"histogram",label:"Using the histogram for exposure" },
      { key:"exposure-compensation",label:"Exposure compensation" },
      { key:"triangle-relationships",label:"Exposure triangle relationships" }
    ],
    questionTopics:{ 
      q1:["exposure-basics"], 
      q2:["exposure-triangle"], 
      q3:["aperture-control"], 
      q4:["shutter-control"], 
      q5:["iso-control"], 
      q6:["under-over"], 
      q7:["under-over"], 
      q8:["creative-exposure"], 
      q9:["histogram"], 
      q10:["exposure-compensation"], 
      q11:["triangle-relationships"], 
      q12:["triangle-relationships"] 
    },
    topicLinks:{
      "exposure-basics":branding.exposureUrl,
      "exposure-triangle":branding.exposureUrl + "#exposure-triangle",
      "aperture-control":branding.exposureUrl + "#aperture",
      "shutter-control":branding.exposureUrl + "#shutter",
      "iso-control":branding.exposureUrl + "#iso",
      "under-over":branding.exposureUrl + "#over-under",
      "creative-exposure":branding.exposureUrl + "#creative",
      "histogram":branding.exposureUrl + "#histogram",
      "exposure-compensation":branding.exposureUrl + "#compensation",
      "triangle-relationships":branding.exposureUrl + "#exposure-triangle"
    }
  }
};

// Module cache for loaded modules
const moduleCache = new Map();

// Load module from GitHub Pages
async function loadModuleFromGitHub(moduleId) {
  // Check cache first
  if (moduleCache.has(moduleId)) {
    return moduleCache.get(moduleId);
  }
  
  try {
                    const url = `https://alanranger.github.io/alanranger-modules/modules/${moduleId}.json`;
    debugLog(`üîÑ Loading module ${moduleId} from GitHub Pages...`);
    debugLog(`üîÑ URL: ${url}`);
    
    const response = await fetch(url);
    debugLog(`üîÑ Response status: ${response.status}`);
    debugLog(`üîÑ Response ok: ${response.ok}`);
    
    if (!response.ok) {
      throw new Error(`Failed to load module: ${response.status} ${response.statusText}`);
    }
    
    const moduleData = await response.json();
    
    // Convert from modular format to legacy format for compatibility
    const legacyFormat = {
      moduleId: moduleData.moduleId,
      moduleTitle: moduleData.title,
      passMarkPercent: moduleData.passMark,
      questions: moduleData.questions.map((q, index) => ({
        id: `q${index + 1}`,
        text: q.question,
        options: q.options,
        correctIndex: q.correct,
        reviewHint: q.reviewHint || ""
      })),
      feedbackMap: moduleData.feedbackMap || {
        topics: [],
        questionTopics: {},
        topicLinks: {}
      }
    };
    
    // Cache the converted module
    moduleCache.set(moduleId, legacyFormat);
    debugLog(`‚úÖ Module ${moduleId} loaded and cached successfully`);
    
    return legacyFormat;
    
  } catch (error) {
    const errorMsg = error.message || error.toString() || 'Unknown error';
    debugLog(`‚ùå Error loading module ${moduleId}:`, errorMsg);
    debugLog(`‚ùå Full error object:`, error);
    
    // Fallback to embedded modules for critical ones
    if (moduleId === "module-01-exposure") {
      debugLog(`üîÑ Falling back to embedded Module 1`);
      return quizConfig;
    }
    
    // For now, show "Coming Soon" for modules that don't have embedded fallbacks
    debugLog(`üîÑ Module ${moduleId} not available - showing coming soon message`);
    throw new Error(`Module ${moduleId} is coming soon! Only Modules 1-3 are currently available.`);
  }
}

// Legacy module registry for fallback (only Module 1)
const moduleRegistry = {
  "module-01-exposure": quizConfig
};

// Global variable to hold current quiz config
let currentQuizConfig = quizConfig;

// Clear previous results when switching modules
function clearPreviousResults() {
  debugLog('üßπ Clearing previous results for module:', currentQuizConfig?.moduleId);
  
  // Clear the results display
  const resultsSummary = document.getElementById('results-summary');
  const resultsCompact = document.getElementById('results-compact');
  const resultsFeedback = document.getElementById('results-feedback');
  const statusDiv = document.getElementById('status');
  
  if (resultsSummary) resultsSummary.innerHTML = '';
  if (resultsCompact) resultsCompact.textContent = '';
  if (resultsFeedback) resultsFeedback.innerHTML = '';
  if (statusDiv) statusDiv.innerHTML = '';
  
  // Clear the lastReport
  lastReport = null;
  
  // Reset form
  const quizForm = document.getElementById('quiz-form');
  if (quizForm) {
    quizForm.reset();
  }
  
  // Reset buttons
  const submitBtn = document.getElementById('btn-submit');
  const pdfBtn = document.getElementById('btn-pdf');
  const certBtn = document.getElementById('btn-certificate');
  const saveBtn = document.getElementById('btn-save');
  
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.display = 'inline-block';
  }
  if (pdfBtn) {
    pdfBtn.disabled = true;
    pdfBtn.style.opacity = '0.6';
  }
  if (certBtn) {
    certBtn.disabled = true;
    certBtn.style.opacity = '0.6';
  }
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.style.opacity = '0.6';
  }
  
  // Hide retake button
  const retakeBtn = document.getElementById('btn-retake');
  if (retakeBtn) {
    retakeBtn.style.display = 'none';
  }
  
  debugLog('‚úÖ Previous results cleared');
}

/* ---------- RENDER UI ---------- */
function initQuiz(){
  debugLog('üéØ initQuiz called with config:', currentQuizConfig?.moduleId);
  
  if (!currentQuizConfig) {
    debugLog("‚ùå No current quiz config loaded");
    return;
  }
  
  const quizForm = document.getElementById("quiz-form");
  if (!quizForm) {
    debugLog("‚ùå Quiz form not found");
    return;
  }
  
  debugLog('üìù Rendering', currentQuizConfig.questions.length, 'questions for module:', currentQuizConfig.moduleId);
  
  const frag = document.createDocumentFragment();
  currentQuizConfig.questions.forEach((q, idx) => {
    const field = document.createElement("div"); field.className = "ar-field";
    const qtxt = document.createElement("div"); qtxt.className = "ar-qtxt"; qtxt.textContent = `Q${idx+1}. ${q.text}`;
    field.appendChild(qtxt);
    q.options.forEach((opt, i) => {
      const id = `${q.id}-${i}`;
      const label = document.createElement("label"); label.className = "ar-opt"; label.setAttribute("for", id);
      const input = document.createElement("input"); input.type="radio"; input.name=q.id; input.id=id; input.value=i; input.required=true; input.style.cssText="margin-top:4px;";
      const span = document.createElement("span"); span.textContent = opt;
      label.appendChild(input); label.appendChild(span); field.appendChild(label);
    });
    frag.appendChild(field);
  });
  quizForm.appendChild(frag);
  
  debugLog('‚úÖ Quiz rendered successfully with', currentQuizConfig.questions.length, 'questions');
  
  // Set up test button handlers after quiz is loaded
  setupTestButtons();
  
  // Ensure submit button is visible when quiz is loaded
  const btnSubmit = document.getElementById("btn-submit");
  if (btnSubmit) {
    btnSubmit.style.display = 'inline-block';
    document.getElementById('btn-retake').style.display = 'none';
  }
}

function setupTestButtons() {
  const btnTestCorrect = document.getElementById("btn-test-correct");
  const btnTestFail = document.getElementById("btn-test-fail");
  
  console.log("üîç Setting up test buttons:", {
    btnTestCorrect: !!btnTestCorrect,
    btnTestFail: !!btnTestFail
  });
  
  if (btnTestCorrect) {
    console.log("‚úÖ Adding event listener to Test Correct button");
    btnTestCorrect.addEventListener("click", () => {
      console.log("üß™ Test: All Correct clicked");
      // Auto-select all correct answers
      const questions = document.querySelectorAll('.ar-field');
      console.log("Found questions:", questions.length);
      
      questions.forEach((field, index) => {
        if (index < currentQuizConfig.questions.length) {
          const correctIndex = currentQuizConfig.questions[index].correctIndex;
          const radioButtons = field.querySelectorAll('input[type="radio"]');
          console.log(`Question ${index + 1}: correct index ${correctIndex}, found ${radioButtons.length} radio buttons`);
          
          if (radioButtons[correctIndex]) {
            radioButtons[correctIndex].checked = true;
            console.log(`‚úÖ Selected correct answer for question ${index + 1}`);
          } else {
            console.log(`‚ùå Could not find radio button at index ${correctIndex} for question ${index + 1}`);
          }
        }
      });
      showToast("üß™ All correct answers selected for testing", "info", 2000);
      
      // Ensure submit button is visible after test
      btnSubmit.style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
    });
  } else {
    console.log("‚ùå Test Correct button not found!");
  }

  if (btnTestFail) {
    console.log("‚úÖ Adding event listener to Test Fail button");
    btnTestFail.addEventListener("click", (e) => {
      console.log("üß™ Test: All Wrong clicked - Event:", e);
      console.log("üß™ Button element:", btnTestFail);
      
      // Auto-select all wrong answers (first wrong option for each question)
      const questions = document.querySelectorAll('.ar-field');
      console.log("Found questions:", questions.length);
      
      if (questions.length === 0) {
        console.log("‚ùå No questions found! Quiz may not be loaded yet.");
        showToast("‚ùå Quiz not ready. Please wait a moment and try again.", "err", 3000);
        return;
      }
      
      questions.forEach((field, index) => {
        if (index < currentQuizConfig.questions.length) {
          const correctIndex = currentQuizConfig.questions[index].correctIndex;
          const radioButtons = field.querySelectorAll('input[type="radio"]');
          // Select the first wrong answer (index 0 if correct is not 0, otherwise index 1)
          const wrongIndex = correctIndex === 0 ? 1 : 0;
          console.log(`Question ${index + 1}: correct index ${correctIndex}, selecting wrong index ${wrongIndex}, found ${radioButtons.length} radio buttons`);
          
          if (radioButtons[wrongIndex]) {
            radioButtons[wrongIndex].checked = true;
            // Trigger change event to ensure the selection is registered
            radioButtons[wrongIndex].dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`‚úÖ Selected wrong answer for question ${index + 1}`);
          } else {
            console.log(`‚ùå Could not find radio button at index ${wrongIndex} for question ${index + 1}`);
          }
        }
      });
      showToast("üß™ All wrong answers selected for testing", "info", 2000);
      
      // Ensure submit button is visible after test
      btnSubmit.style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
    });
  } else {
    console.log("‚ùå Test Fail button not found!");
  }
}

/* ---------- AUTH & PROGRESS HELPERS ---------- */
const authBadge = document.getElementById('ar-auth-status');
const authEmail = document.getElementById('ar-auth-email');
const statusDiv = document.getElementById('ar-status');
const btnMagic = document.getElementById('btn-magic');
const btnClear = document.getElementById('btn-clear');

let lastMagicSentAt = 0;
const MAGIC_DEBOUNCE_MS = 60000;

function setAuthUI(user){
  if (user){
    authBadge.textContent = "Signed in";
    authEmail.textContent = user.email || "";
    const em = document.getElementById('email');
    if (user.email && (!em.value || em.value !== user.email)) em.value = user.email;
  } else {
    authBadge.textContent = "Not signed in";
    authEmail.textContent = "";
  }
}

async function currentUser(){ const { data:{user} } = await supabase.auth.getUser(); return user; }

async function sendMagicLink(email){
  if (!email || !email.includes("@")) { showToast("Please enter a valid email address.", "error"); return; }
  const now = Date.now();
  if (now - lastMagicSentAt < MAGIC_DEBOUNCE_MS) { showToast("Use the link we just sent, or try again in ~60s.", "info", 5000); return; }

  const { error } = await supabase.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: window.location.href.split('#')[0] }
  });
  if (error) { showToast("Could not send sign‚Äëin link.", "error"); console.error(error); }
  else { lastMagicSentAt = now; showToast("Magic link sent! Check your email to sign in.", "success", 7000); }
}

btnMagic.addEventListener("click", async () => {
  const email = (document.getElementById('email').value || "").trim();
  await sendMagicLink(email);
});

// Clear results / sign out so you can retest immediately
async function clearForRetest(){
  try { await supabase.auth.signOut(); } catch(e){}
  localStorage.removeItem('ar_pending_result');
  localStorage.removeItem('ar_pending_email');
  const lf = document.getElementById("learner-form");
  const qf = document.getElementById("quiz-form");
  if (lf) lf.reset();
  if (qf) qf.reset();
  const box = document.getElementById("results");
  if (box) box.style.display = "none";
  const pdf = document.getElementById("btn-pdf");
  const cert = document.getElementById("btn-certificate");
  const save = document.getElementById("btn-save");
  if (pdf) { pdf.disabled = true; pdf.style.opacity = .6; }
  if (cert) { cert.disabled = true; cert.style.opacity = .6; }
  if (save) { save.disabled = true; save.style.opacity = .6; }
  lastReport = null;
  setAuthUI(null);
  renderProgressBadge();
  
  // Unlock radio buttons and restore submit button
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = false;
    radio.style.cursor = 'pointer';
  });
  btnSubmit.style.display = 'inline-block';
  document.getElementById('btn-retake').style.display = 'none';
  
  showToast("Signed out and cleared previous results. You can retake now.", "info", 5000);
}
btnClear.addEventListener("click", clearForRetest);

async function getLatestStatus(moduleId){
  // Try Memberstack first
  if (memberstackIdentity) {
    const status = await getLatestStatusViaMemberstack(moduleId);
    if (status) {
      return {
        score_percent: status.score_percent,
        passed: status.passed,
        created_at: status.created_at
      };
    }
  }
  
  // Fallback to Supabase (legacy)
  const user = await currentUser(); if (!user) return null;
  const { data, error } = await supabase.from('module_results')
    .select('score_percent, passed, created_at').eq('user_id', user.id).eq('module_id', moduleId)
    .order('created_at', { ascending:false }).limit(1);
  if (error || !data?.length) return null;
  return data[0];
}

async function saveResultToDB(report){
  // Try Memberstack first - always attempt to get identity if not set
  if (!memberstackIdentity) {
    debugLog('‚ö†Ô∏è memberstackIdentity not set, attempting to get it before save...');
    try {
      memberstackIdentity = await getExamIdentity();
    } catch (err) {
      console.error("[saveResultToDB] Failed to get Memberstack identity:", err);
    }
  }
  
  if (memberstackIdentity) {
    try {
      debugLog('üíæ Saving via Memberstack API...');
      await saveResultsViaMemberstack(report);
      showToast("Progress saved to your account.", "success");
      renderProgressBadge();
      return;
    } catch (err) {
      console.error("[saveResultToDB] Memberstack save failed:", err);
      showToast("Failed to save via Memberstack. Trying fallback...", "warning");
      // Fall through to Supabase fallback
    }
  }
  
  // Fallback to Supabase (legacy) - only if Memberstack is not available
  debugLog('‚ö†Ô∏è Falling back to legacy Supabase save (Memberstack not available)');
  const user = await currentUser();
  if (!user){
    const email = document.getElementById('email').value.trim();
    if (!email) { alert("Enter your email to save progress."); return; }
    localStorage.setItem('ar_pending_result', JSON.stringify(report));
    localStorage.setItem('ar_pending_email', email);
    await sendMagicLink(email);
    return;
  }
  const { count } = await supabase.from('module_results')
    .select('*', { count:'exact', head:true })
    .eq('user_id', user.id).eq('module_id', report.moduleId);

  const payload = {
    user_id: user.id,
    email: user.email || (document.getElementById('email').value.trim() || ''),
    module_id: report.moduleId,
    score_percent: report.percent,
    passed: report.pass,
    attempt: (count || 0) + 1,
    details: { misses: report.misses }
  };
  const { error } = await supabase.from('module_results').insert(payload);
  if (error){ showToast("Save failed.", "error"); console.error(error); }
  else { showToast("Progress saved to your account.", "success"); renderProgressBadge(); }
}

async function renderProgressBadge(){
  const latest = await getLatestStatus(currentQuizConfig?.moduleId);
  if (latest){
    const when = new Date(latest.created_at).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    statusDiv.innerHTML = latest.passed
      ? `Status: <strong>Completed ‚úì</strong> (${latest.score_percent}% on ${when})`
      : `Status: Last attempt ${latest.score_percent}% on ${when}`;
  } else {
    statusDiv.textContent = "";
  }
}

/* ---------- REHYDRATE RESULTS AFTER MAGIC LINK ---------- */
const resultsBox      = document.getElementById("results");
const resultsSummary  = document.getElementById("results-summary");
const resultsCompact  = document.getElementById("results-compact");
const resultsFeedback = document.getElementById("results-feedback");

function renderResultsFromReport(rpt){
  const passPill = rpt.pass ? `<span class="pill pill-pass">Pass</span>`
                            : `<span class="pill pill-fail">Fail</span>`;
  resultsSummary.innerHTML = `
    <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
      <div style="font-size:28px;font-weight:800;">${rpt.percent}%</div>
      <div>${passPill} ‚Äî ${rpt.correct}/${rpt.total} correct (Pass mark: ${currentQuizConfig.passMarkPercent}%)</div>
    </div>
    <div style="margin-top:8px;color:#555;">
      <div><strong>Name:</strong> ${escapeHtml(rpt.name)} ${rpt.email ? `| <strong>Email:</strong> ${escapeHtml(rpt.email)}` : ""}</div>
      <div><strong>Date:</strong> ${formatDate(new Date(rpt.timestamp))}</div>
      <div><strong>Module:</strong> ${escapeHtml(rpt.moduleTitle)}</div>
    </div>`;
  resultsCompact.textContent = rpt.compact || "";

  if (!rpt.misses.length){
    resultsFeedback.innerHTML =
      `<div style="padding:12px;border:1px solid #e6f4ea;background:#f6fffa;border-radius:8px;">
         Great work ‚Äî no weak topics identified for this module.
       </div>`;
  } else {
    const keys = [...new Set(rpt.misses.flatMap(m => currentQuizConfig.feedbackMap.questionTopics[m.id]||[]))];
    resultsFeedback.innerHTML = `
      <h4 style="margin:12px 0 6px;font-size:16px;">Question review</h4>
      <ol style="margin:0 0 0 18px;">
        ${rpt.misses.map((m,i)=>`<li style="margin:6px 0;"><strong>${m.id.toUpperCase()}</strong>: ${escapeHtml(m.reviewHint||'Please review the relevant section.')}</li>`).join('')}
      </ol>
      <div style="padding:12px;border:1px dashed #f3c7b4;background:#fff7f3;border-radius:8px;margin-top:8px;">
        <strong>Topics to review:</strong>
        <ul style="margin:8px 0 0 18px;">
          ${keys.map(k=>{
              const t = (currentQuizConfig.feedbackMap.topics.find(t=>t.key===k)||{}).label||k;
              const href = currentQuizConfig.feedbackMap.topicLinks[k];
              return href ? `<li><a href="${href}" target="_blank" rel="noopener">${t}</a></li>` : `<li>${t}</li>`;
            }).join('')}
        </ul>
      </div>`;
  }

  resultsBox.style.display = "block";
  btnPDF.disabled = false; btnPDF.style.opacity = 1;
  btnSave.disabled = false; btnSave.style.opacity = 1;
  btnCert.disabled = !rpt.pass; btnCert.style.opacity = rpt.pass ? 1 : .6;
}

// Only set up auth state listener if supabase is initialized
// BUT: Only set it up if Memberstack is NOT available (to prevent conflicts)
if (typeof supabase !== 'undefined' && supabase.auth) {
  // Check if Memberstack is available - if so, skip Supabase auth listener entirely
  const memberstackAvailable = window.$memberstackDom && typeof window.$memberstackDom.getCurrentMember === 'function';
  
  if (memberstackAvailable) {
    debugLog('üîÑ Skipping Supabase auth state listener - Memberstack is available');
  } else {
    supabase.auth.onAuthStateChange(async (_event, session) => {
      // SKIP Supabase auth handling if Memberstack is authenticated
      // Memberstack takes priority and has its own loading logic
      // Check both memberstackIdentity and window.$memberstackDom to be safe
      const hasMemberstack = memberstackIdentity || (window.$memberstackDom && await window.$memberstackDom.getCurrentMember().then(m => m?.data).catch(() => null));
      
      if (hasMemberstack) {
        debugLog('üîÑ Supabase auth state change ignored - Memberstack is active');
        return;
      }
      
      debugLog('üîÑ Supabase auth state change - memberstackIdentity:', !!memberstackIdentity, 'hasMemberstack:', !!hasMemberstack);
  
  // Clear any pending auth state change
  if (authStateChangeTimeout) {
    clearTimeout(authStateChangeTimeout);
  }
  
  // Debounce auth state changes to prevent excessive calls
  authStateChangeTimeout = setTimeout(async () => {
    setAuthUI(session?.user || null);
    
    // Update grid authentication
    const authBadge = document.getElementById('authBadge');
    const emailInput = document.getElementById('loginEmail');
    const btnMagic = document.getElementById('btnMagic');
    const btnSignOut = document.getElementById('btnSignOut');
    
    if (session?.user) {
      debugLog('üîÑ Auth state change: User signed in - ' + session.user.email);
      if (authBadge) authBadge.textContent = "Signed in";
      if (btnSignOut) btnSignOut.style.display = '';
      // Only set email from Supabase if we don't have Memberstack identity
      if (emailInput && !memberstackIdentity) {
        if (!emailInput.value) emailInput.value = session.user.email || '';
      } else if (memberstackIdentity && memberstackIdentity.email && emailInput) {
        // Use Memberstack email instead
        emailInput.value = memberstackIdentity.email;
        debugLog('‚úÖ Using Memberstack email instead of Supabase email');
      }
      
      // Show loading spinner while fetching progress
      showLoadingSpinner("Loading your progress...");
      
      try {
        // Double-check Memberstack wasn't set while we were waiting
        const currentMemberstack = memberstackIdentity || (window.$memberstackDom && await window.$memberstackDom.getCurrentMember().then(m => m?.data).catch(() => null));
        if (currentMemberstack) {
          debugLog('üîÑ Memberstack detected during Supabase auth - skipping Supabase grid update');
          hideLoadingSpinner();
          return;
        }
        
        // Update grid with user's progress
        debugLog('üîÑ Auth state change: Fetching user status...');
        const status = await fetchStatusForUser(session.user);
        debugLog('üîÑ Auth state change: Status fetched, rendering...');
        debugLog('üîÑ Status keys:', Object.keys(status).length);
        
        // Only render if we have data - don't clear existing Memberstack data
        if (Object.keys(status).length > 0) {
          renderSummary(status);
          renderGrid(status);
        } else {
          debugLog('‚ö†Ô∏è No Supabase status data - keeping existing grid');
        }
      } catch (error) {
        debugLog('‚ùå Error in auth state change:', error);
        // Don't clear grid on error - keep existing data
        debugLog('‚ö†Ô∏è Error occurred but keeping existing grid data');
      } finally {
        // Always hide loading spinner
        hideLoadingSpinner();
      }
    } else {
      debugLog('üîÑ Auth state change: User signed out');
      if (authBadge) authBadge.textContent = "Not signed in";
      if (btnSignOut) btnSignOut.style.display = 'none';
      
      // Clear grid
      renderSummary({});
      renderGrid({});
    }
  }, 100); // 100ms debounce
    }); // End of onAuthStateChange callback
  } // End of else block (memberstackAvailable check)
} // End of supabase check

// Handle pending results from localStorage (wrapped in async IIFE)
(async () => {
  // Wait for Memberstack identity to load first
  if (!memberstackIdentity) {
    try {
      memberstackIdentity = await getExamIdentity();
    } catch (e) {
      console.error('Error getting Memberstack identity:', e);
    }
  }
  
  const pending = localStorage.getItem('ar_pending_result');
  const pendingEmail = localStorage.getItem('ar_pending_email');

  if (pending){
    const rpt = JSON.parse(pending);
    
    // Only use pendingEmail if we don't have Memberstack identity
    if (pendingEmail && !memberstackIdentity) {
      const emailEl = document.getElementById('email');
      if (emailEl) emailEl.value = pendingEmail;
    } else if (memberstackIdentity && memberstackIdentity.email) {
      // Use Memberstack email instead
      const emailEl = document.getElementById('email');
      if (emailEl) emailEl.value = memberstackIdentity.email;
      debugLog('‚úÖ Using Memberstack email for pending result:', memberstackIdentity.email);
    }

    await saveResultToDB(rpt);
    lastReport = rpt;
    renderResultsFromReport(rpt);
    if (rpt.pass) showToast("Signed in. Progress saved ‚Äî you can download your PDFs now.", "success", 6000);

    localStorage.removeItem('ar_pending_result');
    localStorage.removeItem('ar_pending_email');
  } else {
    renderProgressBadge();
  }
  
  // Final check: ensure email field matches Memberstack identity
  if (memberstackIdentity && memberstackIdentity.email) {
    const emailField = document.getElementById('email');
    if (emailField && emailField.value !== memberstackIdentity.email) {
      emailField.value = memberstackIdentity.email;
      debugLog('‚úÖ Final sync: Updated email field to match Memberstack identity:', memberstackIdentity.email);
    }
  }
})();

// Keyboard shortcut to toggle debug panel (Ctrl+Shift+D) - Panel is visible by default
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.shiftKey && e.key === 'D') {
    e.preventDefault();
    const panel = document.getElementById('debugPanel');
    const btn = document.getElementById('debugShowBtn');
    if (panel) {
      const isVisible = panel.style.display !== 'none';
      panel.style.display = isVisible ? 'none' : 'block';
      if (btn) {
        btn.style.display = isVisible ? 'block' : 'none';
      }
      debugLog('Debug panel toggled via keyboard shortcut (Ctrl+Shift+D).');
    }
  }
});

// Grid authentication setup
document.addEventListener('DOMContentLoaded', async () => {
  debugLog('üöÄ Grid script starting...');
  
  const authBadge = document.getElementById('authBadge');
  const authMessage = document.getElementById('memberstackAuthMessage');
  const authHint = document.getElementById('authHint');
  const authTip = document.getElementById('authTip');
  const gridContainer = document.getElementById('grid-container');
  const btnMigrateLegacy = document.getElementById('btnMigrateLegacy');
  
  // Initialize debug panel immediately
  try {
    updateDebugPanel();
  } catch (e) {
    console.error('Debug panel init error:', e);
  }
  
  // Update debug panel every 2 seconds
  setInterval(() => {
    try {
      updateDebugPanel();
    } catch (e) {
      console.error('Debug panel update error:', e);
    }
  }, 2000);
  
  // Check Memberstack identity first (primary authentication)
  try {
    // Add timeout to prevent hanging
    const identityPromise = getExamIdentity();
    const timeoutPromise = new Promise((resolve) => setTimeout(() => resolve(null), 10000));
    memberstackIdentity = await Promise.race([identityPromise, timeoutPromise]);
    
    // Update email field immediately when identity loads
    if (memberstackIdentity && memberstackIdentity.email) {
      const emailField = document.getElementById('email');
      if (emailField) {
        emailField.value = memberstackIdentity.email;
        debugLog('‚úÖ DOMContentLoaded: Updated email field with Memberstack email:', memberstackIdentity.email);
        // Clear any stale localStorage email
        localStorage.removeItem('ar_pending_email');
      }
    }
    
    if (!memberstackIdentity) {
      logError('getExamIdentity timed out or returned null');
      updateDebugPanel();
    }
    if (memberstackIdentity) {
      debugLog('‚úÖ Memberstack user authenticated:', memberstackIdentity.email);
      
      // Update auth badge
      if (authBadge) {
        authBadge.textContent = `Signed in as ${memberstackIdentity.email}`;
        authBadge.style.background = '#10b981';
        authBadge.style.color = '#fff';
      }
      
      // Hide "not signed in" message
      if (authMessage) authMessage.style.display = 'none';
      
      // Show exam UI
      if (gridContainer) gridContainer.style.display = 'block';
      
      // Show loading spinner while fetching (show immediately)
      showLoadingSpinner('Loading your exam progress...');
      debugLog('‚è≥ Loading spinner shown');
      
      // Small delay to ensure spinner is visible
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Ensure memberstackIdentity is set before fetching
      if (!memberstackIdentity) {
        debugLog('‚ö†Ô∏è memberstackIdentity not set, re-fetching...');
        memberstackIdentity = await getExamIdentity();
        if (!memberstackIdentity) {
          debugLog('‚ùå Cannot load exam status - no Memberstack identity');
          hideLoadingSpinner();
          return;
        }
      }
      
      // Fetch exam status from Memberstack API and render grid
      try {
        debugLog('üîÑ Fetching exam status from Memberstack API...');
        debugLog('üîÑ Using member ID:', memberstackIdentity.memberstack_id);
        const statusByModule = {};
        
        // Fetch status for all modules (with progress updates)
        const totalModules = modules.length;
        for (let i = 0; i < modules.length; i++) {
          const module = modules[i];
          try {
            showLoadingSpinner(`Loading progress... (${i + 1}/${totalModules})`);
            const status = await getLatestStatusViaMemberstack(module.id);
            if (status) {
              statusByModule[module.id] = {
                score: status.score_percent,
                passed: status.passed,
                when: status.created_at
              };
              debugLog(`‚úÖ Added status for ${module.id}: score=${status.score_percent}, passed=${status.passed}`);
            } else {
              debugLog(`‚ö†Ô∏è No status returned for ${module.id}`);
            }
          } catch (err) {
            debugLog(`‚ö†Ô∏è Error fetching status for ${module.id}:`, err.message);
          }
        }
        
        debugLog('üìä Fetched status for modules:', Object.keys(statusByModule).length);
        debugLog('üìä Status data keys:', Object.keys(statusByModule));
        debugLog('üìä Status data sample:', JSON.stringify(Object.entries(statusByModule).slice(0, 3), null, 2));
        
        // Always render - even if empty, show the grid
        renderSummary(statusByModule);
        renderGrid(statusByModule);
        
        // Mark that Memberstack data has been loaded - prevent any clearing
        memberstackDataLoaded = true;
        debugLog('‚úÖ Memberstack data loaded flag set - grid protected from clearing');
        
        if (Object.keys(statusByModule).length > 0) {
          debugLog('‚úÖ Grid rendered with Memberstack data');
        } else {
          debugLog('‚ö†Ô∏è Grid rendered with no data - showing empty state');
        }
        
        // Show the grid element - ALWAYS show it
        const gridEl = document.getElementById('grid');
        if (gridEl) {
          gridEl.style.display = 'grid';
          debugLog('‚úÖ Grid element displayed');
        } else {
          debugLog('‚ùå Grid element not found!');
        }
        
        // Also ensure grid container is visible
        if (gridContainer) {
          gridContainer.style.display = 'block';
          debugLog('‚úÖ Grid container displayed');
        }
      } catch (err) {
        debugLog('‚ùå Error loading exam status:', err);
        // Don't clear grid on error - keep what's there
        debugLog('‚ö†Ô∏è Error occurred but keeping existing grid data');
        
        // Show the grid element even with no data
        const gridEl = document.getElementById('grid');
        if (gridEl) {
          gridEl.style.display = 'grid';
        }
      } finally {
        // Always hide loading spinner
        hideLoadingSpinner();
        debugLog('‚úÖ Loading spinner hidden');
      }
      
      // Check if migration is needed
      await checkMigrationNeeded();
      
      // Setup migration button handler
      if (btnMigrateLegacy) {
        btnMigrateLegacy.addEventListener('click', async () => {
          try {
            await migrateLegacyResults();
            // Refresh grid after migration
            const statusByModule = {};
            for (const module of modules) {
              try {
                const status = await getLatestStatusViaMemberstack(module.id);
                if (status) {
                  statusByModule[module.id] = {
                    score: status.score_percent,
                    passed: status.passed,
                    when: status.created_at
                  };
                }
              } catch (err) {
                // Ignore individual module errors
              }
            }
            renderSummary(statusByModule);
            renderGrid(statusByModule);
          } catch (err) {
            console.error('Migration failed:', err);
          }
        });
      }
      
    } else {
      debugLog('‚ÑπÔ∏è No Memberstack session - user must sign in to Academy');
      
      // Show "not signed in" message
      if (authMessage) authMessage.style.display = 'block';
      if (authBadge) {
        authBadge.textContent = 'Not signed in';
        authBadge.style.background = '#ef4444';
        authBadge.style.color = '#fff';
      }
      
      // Hide exam UI
      if (gridContainer) gridContainer.style.display = 'none';
    }
  } catch (err) {
    debugLog('‚ö†Ô∏è Memberstack check failed:', err);
    if (authMessage) authMessage.style.display = 'block';
    if (gridContainer) gridContainer.style.display = 'none';
  }
  
  // Debug panel is always visible, no button needed
  updateDebugPanel();
  
  
  // Check for existing session on page load (Supabase legacy fallback)
  // Wait a bit to ensure Memberstack identity is set first
  // Only run if Memberstack is NOT authenticated AND data hasn't been loaded
  setTimeout(async () => {
    // Double-check Memberstack before running
    const hasMemberstack = memberstackIdentity || (window.$memberstackDom && await window.$memberstackDom.getCurrentMember().then(m => m?.data).catch(() => null));
    if (!hasMemberstack && !memberstackDataLoaded) {
      checkExistingSession();
    } else {
      debugLog('üîç Skipping checkExistingSession - Memberstack is active or data already loaded');
    }
  }, 2000); // Increased delay to 2 seconds
  
  
  
  // Function to check for existing session and auto-sign in
  async function checkExistingSession() {
    // SKIP if Memberstack is already authenticated - check both variable and API
    const hasMemberstack = memberstackIdentity || (window.$memberstackDom && await window.$memberstackDom.getCurrentMember().then(m => m?.data).catch(() => null));
    
    if (hasMemberstack) {
      debugLog('üîç Skipping Supabase session check - Memberstack is active');
      return;
    }
    
    debugLog('üîç checkExistingSession - memberstackIdentity:', !!memberstackIdentity, 'hasMemberstack:', !!hasMemberstack);
    
    try {
      debugLog('üîç Checking for existing session...');
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        debugLog('‚ùå Session check error:', error);
        return;
      }
      
      if (session && session.user) {
        // Double-check Memberstack wasn't set while we were waiting
        const currentMemberstack = memberstackIdentity || (window.$memberstackDom && await window.$memberstackDom.getCurrentMember().then(m => m?.data).catch(() => null));
        if (currentMemberstack) {
          debugLog('üîç Memberstack detected during session check - skipping Supabase grid update');
          return;
        }
        
        debugLog('‚úÖ Found existing session for:', session.user.email);
        
        // FINAL CHECK: If Memberstack data is loaded, DO NOT touch the grid
        if (memberstackDataLoaded) {
          debugLog('üõ°Ô∏è BLOCKED: checkExistingSession - Memberstack data already loaded, skipping Supabase update');
          return;
        }
        
        // User is already signed in, update UI
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          debugLog('üîÑ Auto-signing in existing user:', user.email);
          // Trigger auth state change to load progress
          const status = await fetchStatusForUser(user);
          
          // Only render if we have data - don't clear existing Memberstack data
          if (Object.keys(status).length > 0) {
            renderSummary(status);
            renderGrid(status);
          } else {
            debugLog('‚ö†Ô∏è No Supabase status data - keeping existing grid');
          }
        }
      } else {
        debugLog('‚ÑπÔ∏è No existing session found');
      }
    } catch (err) {
      debugLog('‚ùå Session check exception:', err);
    }
  }
  
  // Setup grid magic link
  const btnMagic = document.getElementById('btnMagic');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const emailInput = document.getElementById('loginEmail');
  
  if (btnMagic) {
    btnMagic.addEventListener('click', async () => {
      const email = emailInput?.value?.trim();
      if (!email) {
        showToast('Enter your email address first.', 'error');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Please enter a valid email address.', 'error');
        return;
      }
      
      debugLog('üìß Sending magic link to: ' + email);
      
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href.split('#')[0] }
      });
      
      if (error) {
        debugLog('‚ùå Magic link error: ' + error.message);
        showToast('Could not send sign-in link.', 'error');
      } else {
        debugLog('‚úÖ Magic link sent successfully');
        showToast('Magic link sent ‚Äî check your inbox.', 'success', 5200);
      }
    });
  }
  
  if (btnSignIn) {
    btnSignIn.addEventListener('click', async () => {
      const email = emailInput?.value?.trim();
      if (!email) {
        showToast('Enter your email address first.', 'error');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Please enter a valid email address.', 'error');
        return;
      }
      
      debugLog('üîê Attempting to sign in existing user: ' + email);
      
      // Check rate limiting (same as magic link)
      const now = Date.now();
      if (now - lastMagicSentAt < MAGIC_DEBOUNCE_MS) {
        const remaining = Math.ceil((MAGIC_DEBOUNCE_MS - (now - lastMagicSentAt)) / 1000);
        showToast(`Please wait ${remaining} seconds before requesting another link.`, 'error');
        return;
      }
      
      try {
        // Show immediate feedback
        showLoadingSpinner("Sending sign-in link...");
        
        // For returning users, we'll send a magic link with extended session
        const { data, error } = await supabase.auth.signInWithOtp({
          email,
          options: { 
            emailRedirectTo: window.location.href.split('#')[0]
          }
        });
        
        debugLog('üîê Sign in response:', { data, error });
        
        if (error) {
          debugLog('‚ùå Sign in error:', error);
          hideLoadingSpinner();
          showToast('Could not send sign-in link: ' + error.message, 'error');
          console.error('Sign in error:', error);
        } else {
          debugLog('‚úÖ Sign in magic link sent successfully');
          lastMagicSentAt = now; // Update timestamp for rate limiting
          hideLoadingSpinner();
          showToast('Sign-in link sent! Check your email to continue where you left off.', 'success', 7000);
        }
      } catch (err) {
        debugLog('‚ùå Sign in exception:', err);
        hideLoadingSpinner();
        showToast('An error occurred while sending sign-in link.', 'error');
        console.error('Sign in exception:', err);
      }
    });
  }
  
  if (btnSignOut) {
    btnSignOut.addEventListener('click', async () => {
      debugLog('üö™ Signing out user');
      await supabase.auth.signOut();
      showToast('Signed out.', 'success');
    });
  }
  
  
  // Initial render - show grid even if no data
  debugLog('üé® Rendering initial grid');
  renderGrid({});
  const gridEl = document.getElementById('grid');
  if (gridEl) {
    gridEl.style.display = 'grid';
    debugLog('‚úÖ Grid element displayed');
  }
  checkUrlParams();
  debugLog('‚úÖ Grid initialization completed');
});

// Initialize auth UI only if supabase is ready
(async ()=>{
  if (typeof supabase !== 'undefined' && supabase.auth) {
    try {
      const { data:{user} } = await supabase.auth.getUser();
      setAuthUI(user||null);
      renderProgressBadge();
    } catch (e) {
      console.warn('[initAuthUI] Error getting user:', e);
    }
  } else {
    console.warn('[initAuthUI] Supabase not initialized yet');
  }
})();

/* ---------- TOAST & CONFETTI ---------- */
function fireConfetti(){ confetti({ particleCount: 140, spread: 80, origin: { x: 0.5, y: 0.5 } }); setTimeout(()=>confetti({ particleCount:100, spread:100, origin:{x:0.5,y:0.5}}),250); }
function showToast(msg, type = "error", duration = 4000) {
  // Try quiz toast first, then grid toast, else fall back to alert
  const el = document.getElementById('ar-toast') || document.getElementById('toast');
  if (!el) { alert(msg); return; }

  // Map classes correctly for each container
  if (el.id === 'ar-toast') {
    el.className = (type === "success") ? "success" : (type === "info" ? "info" : "error");
  } else {
    el.className = "toast " + (type === "success" ? "ok" : (type === "err" || type === "error" ? "err" : ""));
  }

  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => { el.style.display = "none"; }, duration);
}

// --- Replace your debugLog with this variadic version ---
function debugLog(...args){
  try{
    const debugContent = document.getElementById('debugContent');
    const timestamp = new Date().toLocaleTimeString();
    const line = args.map(v=>{
      if (typeof v === 'string') return v;
      try { return JSON.stringify(v); } catch { return String(v); }
    }).join(' ');
    if (debugContent){
      debugContent.textContent += `[${timestamp}] ${line}\n`;
      debugContent.scrollTop = debugContent.scrollHeight;
    }
    // Also emit the full, multi-arg log to the console
    console.log(...args);
  }catch(e){
    console.log('Debug error:', e);
  }
}

// --- Tiny helper to make remote images PDF-safe (avoids CORS issues) ---
async function toDataURL(url){
  const res = await fetch(url, { mode: 'cors' });
  if (!res.ok) throw new Error(`Image fetch failed ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  return await new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onloadend = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

const showLoadingSpinner = (text = "Loading your progress...") => {
  const spinner = document.getElementById('loadingSpinner');
  const loadingText = document.getElementById('loadingText');
  if (spinner) {
    if (loadingText) loadingText.textContent = text;
    spinner.style.display = 'block';
    
    // Auto-hide spinner after 10 seconds as a safety measure
    clearTimeout(showLoadingSpinner._timeout);
    showLoadingSpinner._timeout = setTimeout(() => {
      hideLoadingSpinner();
      debugLog('‚ö†Ô∏è Loading spinner auto-hidden after 10 seconds');
    }, 10000);
  }
};

const hideLoadingSpinner = () => {
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) {
    spinner.style.display = 'none';
  }
  // Clear any pending timeout
  clearTimeout(showLoadingSpinner._timeout);
};

/* ---------- BUTTONS ---------- */
const btnSubmit = document.getElementById("btn-submit");
const btnPDF    = document.getElementById("btn-pdf");
const btnCert   = document.getElementById("btn-certificate");
const btnSave   = document.getElementById("btn-save");
const btnTestCorrect = document.getElementById("btn-test-correct");
const btnTestFail = document.getElementById("btn-test-fail");

// Debug: Check if buttons are found
console.log("üîç Test buttons found:", {
  btnTestCorrect: !!btnTestCorrect,
  btnTestFail: !!btnTestFail
});
let lastReport = null;

btnSubmit.addEventListener("click", async () => {
  const learnerName  = document.getElementById("name").value.trim();
  if (!learnerName) { alert("Please enter your name."); return; }

  const unanswered = currentQuizConfig.questions.filter(q => !document.querySelector(`input[name="${q.id}"]:checked`));
  if (unanswered.length) { alert("Please answer all questions before submitting."); return; }

  let correct = 0; const misses = []; const compactParts=[];
  currentQuizConfig.questions.forEach((q, idx) => {
    const chosen = +document.querySelector(`input[name="${q.id}"]:checked`).value;
    const isCorrect = chosen === q.correctIndex;
    if (isCorrect) correct++; else misses.push({ id:q.id, reviewHint:q.reviewHint });
    compactParts.push(`Q${idx+1}: ${isCorrect ? 'Correct' : 'Incorrect'}`);
  });
  const total = currentQuizConfig.questions.length;
  const pct   = Math.round((correct / total) * 100);
  const pass  = pct >= currentQuizConfig.passMarkPercent;
  const compactLine = compactParts.join(', ');

  const topicKeys = new Set();
  misses.forEach(m => (currentQuizConfig.feedbackMap.questionTopics[m.id] || []).forEach(k => topicKeys.add(k)));

  const passPill = pass ? `<span class="pill pill-pass">Pass</span>` : `<span class="pill pill-fail">Fail</span>`;
  resultsSummary.innerHTML = `
    <div style=\"display:flex;flex-wrap:wrap;gap:16px;align-items:center;\">\n      <div style=\"font-size:28px;font-weight:800;\">${pct}%</div>\n      <div>${passPill} ‚Äî ${correct}/${total} correct (Pass mark: ${currentQuizConfig.passMarkPercent}%)</div>\n    </div>\n    <div style=\"margin-top:8px;color:#555;\">\n      <div><strong>Name:</strong> ${escapeHtml(learnerName)} ${document.getElementById("email").value ? `| <strong>Email:</strong> ${escapeHtml(document.getElementById("email").value)}` : ""}</div>\n      <div><strong>Date:</strong> ${formatDate(new Date())}</div>\n      <div><strong>Module:</strong> ${escapeHtml(currentQuizConfig.moduleTitle)}</div>\n    </div>`;
  resultsCompact.textContent = compactLine;

  resultsFeedback.innerHTML = misses.length
    ? `<h4 style=\"margin:12px 0 6px;font-size:16px;\">Question review</h4>\n       <ol style=\"margin:0 0 0 18px;\">${
         misses.map(m => `<li style=\"margin:6px 0;\"><strong>${m.id.toUpperCase()}</strong>: ${escapeHtml(m.reviewHint || "Please review the relevant section.")}</li>`).join("")
       }</ol>\n       <div style=\"padding:12px;border:1px dashed #f3c7b4;background:#fff7f3;border-radius:8px;margin-top:8px;\">\n         <strong>Topics to review:</strong>\n         <ul style=\"margin:8px 0 0 18px;\">${
           Array.from(topicKeys).map(k => {
                         const label = (currentQuizConfig.feedbackMap.topics.find(t => t.key === k) || {}).label || k;
            const href  = currentQuizConfig.feedbackMap.topicLinks[k];
             return href ? `<li><a href=\"${href}\" target=\"_blank\" rel=\"noopener\">${label}</a></li>` : `<li>${label}</li>`;
           }).join("")
         }</ul>\n       </div>`
    : `<div style="padding:12px;border:1px solid #e6f4ea;background:#f6fffa;border-radius:8px;">Great work ‚Äî no weak topics identified for this module.</div>`;
  resultsBox.style.display = "block";

  btnPDF.disabled = false; btnPDF.style.opacity = 1;
  btnSave.disabled = false; btnSave.style.opacity = 1;
  btnCert.disabled = !pass; btnCert.style.opacity = pass ? 1 : .6;

  // Use Memberstack email if available, otherwise fall back to form field
  let emailForReport = null;
  if (memberstackIdentity && memberstackIdentity.email) {
    emailForReport = memberstackIdentity.email;
    debugLog('üìù Using Memberstack email for report:', emailForReport);
  } else {
    emailForReport = document.getElementById("email").value.trim();
    debugLog('üìù Using form field email for report:', emailForReport);
  }

  lastReport = {
    moduleId: currentQuizConfig.moduleId, moduleTitle: currentQuizConfig.moduleTitle,
    name: learnerName, email: emailForReport,
    percent: pct, pass, correct, total, misses, compact: compactLine, timestamp: new Date().toISOString()
  };

  // Lock all radio buttons after submission
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = true;
    radio.style.cursor = 'not-allowed';
  });
  
  // Hide submit button and show retake button
  btnSubmit.style.display = 'none';
  document.getElementById('btn-retake').style.display = 'inline-block';

  if (pass){ fireConfetti(); showToast("Congrats! You passed this module. You can download your certificate now.", "success", 5000); }
  else { showToast("You didn't pass this time. Review the linked topics, then use the 'Retake test' button to try again.", "error", 6000); }
  
  // Save results and refresh grid
  await saveResultToDB(lastReport);
  
  // Clear cache to force refresh of user status
  userStatusCache = {};
  lastCacheTime = 0;
  
  // Also refresh grid if we're in quiz view
  if (document.getElementById('quiz-container').style.display !== 'none') {
    debugLog('üîÑ Quiz completed, refreshing grid in background');
    setTimeout(async () => {
      const { data: { user } } = await supabase.auth.getUser();
      let status = await fetchStatusForUser(user);
      
      // If no user or no results from DB, check localStorage for recent results
      if (!user || Object.keys(status).length === 0) {
        debugLog('üîç No user or DB results, checking localStorage...');
        const pendingResult = localStorage.getItem('ar_pending_result');
        if (pendingResult) {
          try {
            const parsed = JSON.parse(pendingResult);
            if (parsed.moduleId === lastReport.moduleId) {
              debugLog('üìã Found matching localStorage result:', parsed);
              status = {
                [parsed.moduleId]: {
                  score: parsed.percent,
                  passed: parsed.pass,
                  when: new Date(parsed.timestamp).toISOString()
                }
              };
            }
          } catch (e) {
            debugLog('‚ùå Error parsing localStorage result:', e);
          }
        }
      }
      
      renderSummary(status);
      renderGrid(status);
    }, 1000);
  }
});


// Function to show results modal for passed modules
window.showResultsModal = async function(moduleId) {
  console.log('üîç showResultsModal called with moduleId:', moduleId);
  debugLog('üîç showResultsModal called with moduleId:', moduleId);
  debugLog('üîç moduleId type:', typeof moduleId, 'length:', moduleId ? moduleId.length : 'undefined');
  try {
    // Get the user's results for this module
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      showToast('Please sign in to view your results', 'error');
      return;
    }
    
    // Fetch the latest result for this module
    const { data, error } = await supabase
      .from('module_results')
      .select('*')
      .eq('user_id', user.id)
      .eq('module_id', moduleId)
      .order('created_at', { ascending: false })
      .limit(1);
    
    if (error) {
      console.error('Error fetching results:', error);
      showToast('Error loading results', 'error');
      return;
    }
    
    if (!data || data.length === 0) {
      showToast('No results found for this module', 'error');
      return;
    }
    
    const result = data[0];
    
    // Find the module info
    const module = modules.find(m => m.id === moduleId);
    debugLog('üîç Found module:', module);
    if (!module) {
      debugLog('‚ùå Module not found for moduleId:', moduleId);
      showToast('Module not found', 'error');
      return;
    }
    
    // Create and show the results modal
    debugLog('üîç Creating modal for moduleId:', moduleId, 'module.title:', module.title);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: #333;">${module.title} - Results</h2>
          <button onclick="this.closest('.modal').remove()" style="
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
          ">&times;</button>
        </div>
        
        <div style="
          background: #f8f9fa;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
        ">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div><strong>Score:</strong> ${result.score_percent}%</div>
            <div><strong>Status:</strong> <span style="color: ${result.passed ? '#10b981' : '#ef4444'}">${result.passed ? 'Passed' : 'Failed'}</span></div>
            <div><strong>Date:</strong> ${new Date(result.created_at).toLocaleDateString()}</div>
            <div><strong>Time:</strong> ${new Date(result.created_at).toLocaleTimeString()}</div>
          </div>
          
          ${result.passed ? `
          <div style="margin-top: 15px; padding: 15px; background: #e6f7ed; border-radius: 6px; border: 1px solid #b7f0d2;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #067647;">
              Name for Certificate:
            </label>
            <input type="text" id="certificateName" placeholder="Enter your full name" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #b7f0d2; border-radius: 6px; background: #fff;"
                   value="${user.user_metadata?.full_name || user.user_metadata?.name || user.email.split('@')[0] || ''}">
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
              üí° This name will appear on your certificate
            </div>
          </div>
          ` : ''}
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="debugLog('üîç Download Results PDF clicked for', '${moduleId}'); window.downloadResultsPDF('${moduleId}');" style="
            background: #f97316;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
          ">Download Results PDF</button>
          
          ${result.passed ? `
          <button id="btn-modal-cert" style="
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
          ">Download Certificate</button>
          ` : ''}
          
          <button onclick="debugLog('üîç Retake Exam clicked for', '${moduleId}'); window.loadExam('${moduleId}');" style="
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
          ">Retake Exam</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listener for certificate button
    const certBtn = modal.querySelector('#btn-modal-cert');
    certBtn?.addEventListener('click', () => {
      const name = document.getElementById('certificateName')?.value.trim() || null;
      debugLog('üîç Download Certificate clicked for', moduleId, 'name:', name);
      window.downloadCertificatePDF(moduleId, result.created_at, name);
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
    
  } catch (error) {
    console.error('Error showing results modal:', error);
    showToast('Error loading results', 'error');
  }
}

// Function to download results PDF for a specific module
// --- Hardened Results PDF (works even if certificate fails) ---
window.downloadResultsPDF = async function(moduleId){
  try{
    const { data:{ user } } = await supabase.auth.getUser();
    if (!user){ showToast('Please sign in to download results', 'error'); return; }

    const { data, error } = await supabase
      .from('module_results')
      .select('*')
      .eq('user_id', user.id)
      .eq('module_id', moduleId)
      .order('created_at', { ascending:false })
      .limit(1);

    if (error) throw error;
    if (!data?.length) throw new Error('No results found for this module');

    const result = data[0];
    const module = (window.modules || []).find(m=>m.id===moduleId);
    const modTitle = module?.title || moduleId;

    // Fetch module data to get exact question count
    let totalQuestions = 12; // fallback
    try {
      const moduleResponse = await fetch(`https://alanranger.github.io/alanranger-modules/modules/${moduleId}.json`);
      if (moduleResponse.ok) {
        const moduleData = await moduleResponse.json();
        totalQuestions = moduleData.questions?.length || 12;
      }
    } catch (e) {
      console.log('Could not fetch module data, using fallback');
    }

    const jsp = (window.jspdf || {}).jsPDF;
    if (!jsp) throw new Error('jsPDF not loaded (check network/ad blockers)');

    const doc = new jsp({ unit:'pt', format:'a4' });
    const pw = doc.internal.pageSize.getWidth();

    // Calculate questions ratio
    const wrongAnswers = result.details?.misses?.length || 0;
    const correctAnswers = totalQuestions - wrongAnswers;
    const questionsRatio = `${correctAnswers}/${totalQuestions}`;

    // Brand assets
    const [logo, academy] = await Promise.all([
      toDataURL(branding.logoUrl).catch(()=>null),
      toDataURL(branding.academyUrl).catch(()=>null)
    ]);

    // Header with branding
    if (logo){ 
      try {
        const d = await getImgDims(logo); 
        const f = fitWithin(d.w, d.h, 40, 20); 
        doc.addImage(logo, 'PNG', 40, 20, f.w, f.h);
      } catch(e) {}
    }
    
    if (academy) {
      try {
        doc.addImage(academy, 'PNG', pw-60, 20, 20, 20);
      } catch(e) {}
    }

    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('Assessment Results', 40, 56);
    doc.setLineWidth(1); doc.line(40, 66, pw-40, 66);

    // Body with enhanced information
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Module: ${modTitle}`, 40, 96);
    doc.text(`Email: ${user.email}`, 40, 116);
    doc.text(`Score: ${result.score_percent}%`, 40, 136);
    doc.text(`Questions: ${questionsRatio}`, 40, 156);
    doc.text(`Status: ${result.passed ? 'Passed' : 'Failed'}`, 40, 176);
    doc.text(`Date: ${new Date(result.created_at).toLocaleString()}`, 40, 196);

    // Footer with academy branding
    doc.setFontSize(10);
    doc.text('¬© Alan Ranger Photography Academy', 40, 820);
    doc.text('Alan Ranger Photography Academy ‚Äî Beginners Modules', pw/2, 820, {align:'center'});

    doc.save(`${moduleId}-results.pdf`);
    showToast('Results PDF downloaded.', 'success');
  }catch(err){
    console.error(err);
    showToast(err?.message || 'Failed to create Results PDF', 'error');
    debugLog('‚ùå Error downloading results PDF:', err?.message || err, err?.stack);
  }
}

// Function to download certificate PDF for a specific module
// --- Hardened Certificate PDF (handles images + better errors) ---
window.downloadCertificatePDF = async function(moduleId, attemptId = null, userName = null){
  try{
    debugLog('üîç downloadCertificatePDF called with:', moduleId, attemptId, userName);
    const { data:{ user } } = await supabase.auth.getUser();
    if (!user){ showToast('Please sign in to download the certificate', 'error'); return; }

    const { data, error } = await supabase
      .from('module_results')
      .select('*')
      .eq('user_id', user.id)
      .eq('module_id', moduleId)
      .order('created_at', { ascending:false })
      .limit(1);

    if (error) throw error;
    if (!data?.length) throw new Error('No results found for this module');
    const result = data[0];
    debugLog('üîç Found result:', result);
    if (!result.passed) { showToast('You need a passing result for a certificate', 'error'); return; }

    // Get the learner name - prefer live input field, fallback to userName parameter
    debugLog('üîç Getting learner name...');
    const nameEl = document.getElementById('certificateName');
    const inputName = nameEl?.value?.trim();
    let learnerName = inputName || userName || '';
    debugLog('üîç Input field value:', inputName);
    debugLog('üîç userName parameter:', userName);
    debugLog('üîç Final learnerName:', learnerName);
    if (!learnerName){ showToast('Enter the name for the certificate', 'error'); return; }

    debugLog('üîç Looking up module...');
    debugLog('üîç modules array:', modules);
    debugLog('üîç moduleId for lookup:', moduleId);
    const module = modules.find(m => m.id === moduleId);
    debugLog('üîç Found module:', module);
    if (!module) { showToast('Module not found', 'error'); return; }

    debugLog('üîç Checking jsPDF availability...');
    const jsp = (window.jspdf || {}).jsPDF;
    debugLog('üîç jsPDF object:', jsp);
    if (!jsp) throw new Error('jsPDF not loaded (check network/ad blockers)');

    const doc = new jsp({ orientation:'l', unit:'mm', format:'a4' });
    
    // Load all branding images with error handling
    const [logo, academy, sign, emblem] = await Promise.all([
      toDataURL(branding.logoUrl).catch(err => { debugLog('‚ö†Ô∏è Logo load failed:', err?.message || err); return null; }),
      toDataURL(branding.academyUrl).catch(err => { debugLog('‚ö†Ô∏è Academy logo load failed:', err?.message || err); return null; }),
      toDataURL(branding.signatureUrl).catch(err => { debugLog('‚ö†Ô∏è Signature load failed:', err?.message || err); return null; }),
      toDataURLWithTransparency(branding.emblemUrl).catch(err => { debugLog('‚ö†Ô∏è Emblem load failed:', err?.message || err); return null; })
    ]);

    // Draw borders
    doc.setDrawColor(240,89,34); doc.setLineWidth(3);  doc.rect(10,10,277,187);
    doc.setDrawColor(200,200,200); doc.setLineWidth(0.6); doc.rect(16,16,265,175);

    // Add logos
    if (logo) { 
      const logoDims = await getImgDims(logo); 
      const logoFitted = fitWithin(logoDims.w, logoDims.h, 50, 20);
      doc.addImage(logo,'PNG', 22, 22, logoFitted.w, logoFitted.h); 
    }
    
    if (academy) doc.addImage(academy,'PNG', 290-42, 22, 20, 20);
    
    // Add emblem to top center
    if (emblem) {
      try {
        const emblemDims = await getImgDims(emblem);
        const maxSize = 40;
        const fitted = fitWithin(emblemDims.w, emblemDims.h, maxSize, maxSize);
        const x = (297 - fitted.w) / 2;
        const y = 22;
        doc.addImage(emblem, 'PNG', x, y, fitted.w, fitted.h);
      } catch (err) {
        debugLog('‚ö†Ô∏è Failed to add emblem:', err?.message || err);
      }
    }

    // Certificate text
    doc.setFont('times','bold'); doc.setFontSize(30); doc.text('Certificate of Achievement', 148.5, 72, {align:'center'});
    doc.setFont('times','normal'); doc.setFontSize(14); doc.text('This certifies that', 148.5, 88, {align:'center'});
    doc.setFont('times','bold'); doc.setFontSize(26); doc.setTextColor(0,0,139); doc.text(learnerName, 148.5, 104, {align:'center'});
    doc.setFont('times','normal'); doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('has successfully passed', 148.5, 120, {align:'center'});
    doc.setFont('times','bold'); doc.setFontSize(20); doc.setTextColor(0,0,139); doc.text(module.title + ' Assessment', 148.5, 136, {align:'center'});
    
    // Score line with mixed colors and formatting
    doc.setFont('times','italic'); doc.setFontSize(13);
    const prefix = `with a score of `;
    // Determine total questions dynamically from module JSON (fallback 12)
    let totalQuestions = 12;
    try {
      const modRes = await fetch(`https://alanranger.github.io/alanranger-modules/modules/${moduleId}.json`);
      if (modRes.ok) {
        const modJson = await modRes.json();
        if (Array.isArray(modJson?.questions)) totalQuestions = modJson.questions.length;
      }
    } catch (err) {
      // keep fallback
    }
    const correctAnswers = Math.round((result.score_percent / 100) * totalQuestions);
    const scoreResults = `${result.score_percent}% (${correctAnswers}/${totalQuestions})`;
    const suffix = ` on `;
    const dateText = `${formatDate(new Date(result.created_at))}.`;
    const prefixWidth = doc.getTextWidth(prefix);
    const scoreWidth = doc.getTextWidth(scoreResults);
    const suffixWidth = doc.getTextWidth(suffix);
    const dateWidth = doc.getTextWidth(dateText);
    const totalWidth = prefixWidth + scoreWidth + suffixWidth + dateWidth;
    const startX = 148.5 - (totalWidth / 2);
    
    doc.setTextColor(0,0,0); doc.text(prefix, startX, 150);
    doc.setTextColor(50,50,50); doc.text(scoreResults, startX + prefixWidth, 150);
    doc.setTextColor(0,0,0); doc.text(suffix, startX + prefixWidth + scoreWidth, 150);
    doc.setFont('times','bold'); doc.setTextColor(0,0,0); doc.text(dateText, startX + prefixWidth + scoreWidth + suffixWidth, 150);
    
    // Academy info
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text('Alan Ranger Photography Academy ‚Äî Beginners Modules', 148.5, 160, {align:'center'});

    // Instructor details
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text('Instructor: Alan Ranger', 22, 172);
    const siteText = 'Website: alanranger.com'; 
    doc.text(siteText, 22, 180); 
    doc.link(22, 176, doc.getTextWidth(siteText), 6, {url: branding.siteUrl});

    // Signature
    const sigLineY = 184;
    if (sign){ 
      try {
        const dims = await getImgDims(sign); 
        const fitted = fitWithin(dims.w, dims.h, 130*0.8, 50*0.8);
        const x = 290-22-fitted.w; 
        const y = sigLineY-fitted.h+3; 
        doc.addImage(sign, 'PNG', x, y, fitted.w, fitted.h);
      } catch (err) {
        debugLog('‚ö†Ô∏è Failed to add signature:', err?.message || err);
      }
    }
    doc.setDrawColor(240,89,34); doc.setLineWidth(0.6); doc.line(290-80, sigLineY, 290-22, sigLineY);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text('Signature', 290-22, sigLineY+6, {align:'right'});

    // Certificate ID
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    doc.text(`Certificate ID: ${slugify(moduleId)}-${Date.now()}`, 290-16, 46, {align:'right'});

    doc.save(`${moduleId}-certificate.pdf`);
    showToast('Certificate downloaded.', 'success');
  }catch(err){
    console.error('‚ùå Certificate download failed:', err?.message ?? err, err);
    showToast(err?.message || 'Failed to create Certificate PDF', 'error');
    debugLog('‚ùå Error downloading certificate PDF:', err?.message ?? err, err?.stack);
  }
}

// Master Certificate generator
window.downloadMasterCertificatePDF = async function(capturedName = null){
  try{
    const { data:{ user } } = await supabase.auth.getUser();
    if (!user){ showToast('Please sign in to download the Master Certificate', 'error'); return; }

    // Get latest passed result per module
    const { data, error } = await supabase
      .from('module_results')
      .select('module_id, score_percent, passed, created_at')
      .eq('user_id', user.id)
      .eq('passed', true)
      .order('created_at', { ascending:false });

    if (error) throw error;
    if (!data?.length) throw new Error('No passed modules found');

    // Deduplicate to latest pass per module
    const latestPass = {};
    for (const row of data) if (!latestPass[row.module_id]) latestPass[row.module_id] = row;

    const total = modules.length;
    const passedCount = Object.keys(latestPass).length;
    if (passedCount < total){
      showToast(`You've passed ${passedCount}/${total}. Finish all to unlock the Master Certificate.`, 'info');
      return;
    }

    const jsp = (window.jspdf || {}).jsPDF;
    if (!jsp) throw new Error('jsPDF not loaded');

    const doc = new jsp({ orientation:'l', unit:'mm', format:'a4' });

    // Brand assets
    const [logo, academy, sign, emblem] = await Promise.all([
      toDataURL(branding.logoUrl).catch(()=>null),
      toDataURL(branding.academyUrl).catch(()=>null),
      toDataURL(branding.signatureUrl).catch(()=>null),
      toDataURL(branding.emblemUrl).catch(()=>null)
    ]);

    // Frame
    doc.setDrawColor(240,89,34); doc.setLineWidth(3);  doc.rect(10,10,277,187);
    doc.setDrawColor(200,200,200); doc.setLineWidth(0.6); doc.rect(16,16,265,175);

    if (logo){ const d=await getImgDims(logo); const f=fitWithin(d.w,d.h,50,20); doc.addImage(logo,'PNG',22,22,f.w,f.h); }
    if (academy) doc.addImage(academy,'PNG',290-42,22,20,20);
    if (emblem){ try{ const d=await getImgDims(emblem); const f=fitWithin(d.w,d.h,40,40); const x=(297-f.w)/2; doc.addImage(emblem,'PNG',x,22,f.w,f.h);}catch{} }

    // Headings
    doc.setFont('times','bold'); doc.setFontSize(30);
    doc.text('Master Certificate of Achievement', 148.5, 72, {align:'center'});
    doc.setFont('times','normal'); doc.setFontSize(14);
    doc.text('This certifies that', 148.5, 88, {align:'center'});
    
    // Get the learner name - prefer captured name, fallback to user metadata
    const displayName = capturedName || user.user_metadata?.full_name || user.user_metadata?.name || user.email.split('@')[0] || 'Student';
    
    // Debug logging to UI
    debugLog('üîç Master Certificate name debug:');
    debugLog('  - Captured name:', capturedName);
    debugLog('  - User metadata full_name:', user.user_metadata?.full_name);
    debugLog('  - User metadata name:', user.user_metadata?.name);
    debugLog('  - Email username:', user.email.split('@')[0]);
    debugLog('  - Final displayName:', displayName);
    
    doc.setFont('times','bold'); doc.setFontSize(26); doc.setTextColor(0,0,139);
    doc.text(displayName, 148.5, 104, {align:'center'});

    doc.setFont('times','normal'); doc.setFontSize(14); doc.setTextColor(0,0,0);
    doc.text('has successfully completed and passed the entire', 148.5, 120, {align:'center'});

    doc.setFont('times','bold'); doc.setFontSize(20); doc.setTextColor(0,0,139);
    doc.text('Camera Settings Curriculum (Modules 1‚Äì15)', 148.5, 136, {align:'center'});

    // Line with date + designation
    const line = `Awarded ${formatDate(new Date())} ‚Äî Competent Technical Photographer`;
    doc.setFont('times','italic'); doc.setFontSize(13); doc.setTextColor(0,0,0);
    doc.text(line, 148.5, 150, {align:'center'});

    // Academy tagline
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text('Alan Ranger Photography Academy ‚Äî Beginners Modules', 148.5, 160, {align:'center'});

    // Signature block
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text('Instructor: Alan Ranger', 22, 172);
    const siteText='Website: alanranger.com'; doc.text(siteText,22,180);
    doc.link(22,176,doc.getTextWidth(siteText),6,{url:branding.siteUrl});

    const sigLineY=184;
    if (sign){ try{
      const dims=await getImgDims(sign); const f=fitWithin(dims.w,dims.h,130*0.8,50*0.8);
      const x=290-22-f.w; const y=sigLineY-f.h+3; doc.addImage(sign,'PNG',x,y,f.w,f.h);
    }catch{} }
    doc.setDrawColor(240,89,34); doc.setLineWidth(0.6); doc.line(290-80,sigLineY,290-22,sigLineY);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text('Signature',290-22,sigLineY+6,{align:'right'});

    // Certificate ID only (no QR code or verify text)
    const certId = `master-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,7)}`;
    doc.setFont('helvetica','normal'); doc.setFontSize(9);
    doc.text(`Certificate ID: ${certId}`, 290-16, 46, {align:'right'});

    doc.save(`master-certificate-${displayName ? slugify(displayName) : 'student'}.pdf`);
    showToast('Master Certificate downloaded.', 'success');
  }catch(err){
    console.error(err);
    showToast(err?.message || 'Failed to create Master Certificate', 'error');
  }
};

// Optional: Transcript PDF
window.downloadMasterTranscriptPDF = async function(){
  try{
    const { data:{ user } } = await supabase.auth.getUser();
    if (!user){ showToast('Please sign in to download the transcript', 'error'); return; }

    const { data, error } = await supabase
      .from('module_results')
      .select('module_id, score_percent, passed, created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending:false });

    if (error) throw error;
    if (!data?.length) throw new Error('No attempts found');

    // Latest per module
    const latest = {};
    for (const row of data) if (!latest[row.module_id]) latest[row.module_id] = row;

    const jsp = (window.jspdf || {}).jsPDF;
    const doc = new jsp({ unit:'pt', format:'a4' });
    const pw = doc.internal.pageSize.getWidth();

    // Brand assets
    const [logo, academy] = await Promise.all([
      toDataURL(branding.logoUrl).catch(()=>null),
      toDataURL(branding.academyUrl).catch(()=>null)
    ]);

    // Header with branding
    if (logo){ 
      try {
        const d = await getImgDims(logo); 
        const f = fitWithin(d.w, d.h, 40, 20); 
        doc.addImage(logo, 'PNG', 40, 20, f.w, f.h);
      } catch(e) {}
    }
    
    if (academy) {
      try {
        doc.addImage(academy, 'PNG', pw-60, 20, 20, 20);
      } catch(e) {}
    }

    // Header (matching results PDF style exactly)
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('Assessment Results', 40, 56);
    doc.setLineWidth(1); doc.line(40, 66, pw-40, 66);
    
    // Add orange branding line
    doc.setDrawColor(249, 115, 22); // Orange color
    doc.setLineWidth(3);
    doc.line(40, 70, pw-40, 70);
    doc.setDrawColor(0, 0, 0); // Reset to black

    // Student info (matching results PDF style)
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text(`Student: ${user.user_metadata?.full_name || user.user_metadata?.name || user.email}`, 40, 96);
    doc.text(`Generated: ${formatDate(new Date())}`, 40, 116);

    // Table headers
    let y = 156;
    doc.setFont('helvetica','bold'); doc.setFontSize(12);
    doc.text('Module', 40, y);
    doc.text('Score', 200, y);
    doc.text('Questions', 250, y);
    doc.text('Status', 320, y);
    doc.text('Date', 400, y);
    
    // Table content
    doc.setFont('helvetica','normal'); y += 20;
    for (const m of modules) {
      const r = latest[m.id];
      let score = '‚Äî';
      let scoreRatio = '‚Äî';
      
      if (r) {
        // Calculate correct answers based on percentage (more reliable)
        try {
          const moduleResponse = await fetch(`https://alanranger.github.io/alanranger-modules/modules/${m.id}.json`);
          if (moduleResponse.ok) {
            const moduleData = await moduleResponse.json();
            const totalQuestions = moduleData.questions?.length || 12;
            const correctAnswers = Math.round((r.score_percent / 100) * totalQuestions);
            scoreRatio = `${correctAnswers}/${totalQuestions}`;
            debugLog(`Module ${m.id}: ${r.score_percent}% = ${correctAnswers}/${totalQuestions} correct`);
          } else {
            throw new Error('Module data not found');
          }
        } catch (e) {
          debugLog('Could not fetch module data for ratio:', m.id, e.message);
          // Fallback calculation based on percentage
          const totalQuestions = 12; // fallback
          const correctAnswers = Math.round((r.score_percent / 100) * totalQuestions);
          scoreRatio = `${correctAnswers}/${totalQuestions}`;
          debugLog(`Fallback: ${r.score_percent}% = ${correctAnswers}/${totalQuestions} correct`);
        }
        
        score = `${r.score_percent}%`;
      }
      
      const status = r ? (r.passed ? 'Passed' : 'Failed') : '‚Äî';
      const when = r ? new Date(r.created_at).toLocaleDateString() : '‚Äî';
      
      doc.text(m.title, 40, y);
      doc.text(score, 200, y);
      doc.text(scoreRatio, 250, y); // Add score ratio column
      doc.text(status, 320, y);
      doc.text(when, 400, y);
      y += 20;
      if (y > 750){ doc.addPage(); y = 40; }
    }

    // Footer with academy branding (matching results PDF style)
    doc.setFontSize(10);
    doc.text('¬© Alan Ranger Photography Academy', 40, 820);
    doc.text('Alan Ranger Photography Academy ‚Äî Beginners Modules', pw/2, 820, {align:'center'});

    doc.save('camera-settings-transcript.pdf');
    showToast('Transcript downloaded.', 'success');
  }catch(err){
    console.error(err);
    showToast(err?.message || 'Failed to create transcript', 'error');
  }
};

// Add retake button handler
document.getElementById('btn-retake').addEventListener("click", () => {
  // Preserve name and email, only reset quiz answers
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  
  document.getElementById("quiz-form").reset();
  resultsBox.style.display = "none";
  btnPDF.disabled = true; btnPDF.style.opacity = .6;
  btnCert.disabled = true; btnCert.style.opacity = .6;
  btnSave.disabled = true; btnSave.style.opacity = .6;
  lastReport = null;
  
  // Restore name and email
  document.getElementById("name").value = name;
  document.getElementById("email").value = email;
  
  // Unlock radio buttons and restore submit button
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = false;
    radio.style.cursor = 'pointer';
  });
  btnSubmit.style.display = 'inline-block';
  document.getElementById('btn-retake').style.display = 'none';
  
  showToast("Quiz reset. You can now retake the test.", "info", 3000);
});

// Test button handlers will be set up when quiz loads

btnSave.addEventListener("click", async () => {
  if (!lastReport) { 
    alert("Please complete the assessment first."); 
    return; 
  }
  
  // Ensure memberstackIdentity is set before saving
  if (!memberstackIdentity) {
    debugLog('‚ö†Ô∏è memberstackIdentity not set, attempting to get it...');
    try {
      memberstackIdentity = await getExamIdentity();
      if (!memberstackIdentity) {
        showToast("Please sign in to save results.", "error");
        console.error("[btnSave] No Memberstack identity available");
        return;
      }
    } catch (err) {
      console.error("[btnSave] Failed to get Memberstack identity:", err);
      showToast("Failed to authenticate. Please refresh the page and try again.", "error");
      return;
    }
  }
  
  debugLog('üíæ Save button clicked, saving report:', lastReport);
  try {
    await saveResultToDB(lastReport);
  } catch (err) {
    console.error("[btnSave] Save failed:", err);
    showToast("Failed to save results: " + (err.message || "Unknown error"), "error");
  }
});

/* ---------- PDF HELPERS ---------- */

// Special function for emblem to handle transparency properly
async function toDataURLWithTransparency(url) {
  try {
    const res = await fetch(url, {mode: 'cors'});
    const blob = await res.blob();
    
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        
        // Clear canvas with transparent background
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw image preserving transparency
        ctx.drawImage(img, 0, 0);
        
        // Convert to data URL with transparency
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = () => resolve(null);
      img.src = URL.createObjectURL(blob);
    });
  } catch (e) {
    return null;
  }
}
function svgToPNG(svgString, width, height) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width;
    canvas.height = height;
    
    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/png'));
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
  });
}
const { jsPDF } = window.jspdf;

/* ---------- RESULTS PDF ---------- */
document.getElementById("btn-pdf").addEventListener("click", async () => {
  if (!lastReport) return;
  const doc = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });
  const [logo, academy] = await Promise.all([toDataURL(branding.logoUrl), toDataURL(branding.academyUrl)]);

  doc.setFillColor(240,89,34); doc.rect(0,0,210,24,'F');
  if (logo) { const logoDims=await getImgDims(logo); const logoFitted=fitWithin(logoDims.w,logoDims.h,20,16);
    doc.addImage(logo,'PNG',8,4,logoFitted.w,logoFitted.h); }
  if (academy) doc.addImage(academy,'PNG',210-24,4,16,16);
  doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(15);
  doc.text(currentQuizConfig.moduleTitle,28,15); doc.setTextColor(0,0,0);

  let y=34; doc.setDrawColor(230,230,230); doc.roundedRect(12,y,186,38,2,2);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`Name: ${lastReport.name}`,18,y+9);
  doc.text(`Date: ${formatDate(new Date(lastReport.timestamp))}`,18,y+16);
  doc.text(`Score: ${lastReport.percent}% (${lastReport.correct}/${lastReport.total}) ‚Äî ${lastReport.pass?'Pass':'Fail'}`,18,y+23);

  doc.setFontSize(10); doc.setTextColor(90,90,90);
  doc.text(lastReport.compact || "", 18, y+31);
  doc.setTextColor(0,0,0);

  y+=48; doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('About the Alan Ranger Photography Academy',12,y); y+=6;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const blurb=`This assessment is part of the Beginners pathway (15 modules): Exposure, Aperture, Shutter Speed, ISO, Manual Exposure, Metering, Exposure Bracketing, Focusing, Depth of Field, Dynamic Range, White Balance, Camera Drive Modes, JPEG vs RAW, Full Frame vs Crop Sensor, and Focal Length.`;
  y=writeWrapped(doc, blurb, 12, y, 186, 6); y+=3;
  const link1="Course page: "+branding.courseUrl.replace(/^https?:\/\//,'');
  // Get the correct module article URL from the modules array
  const currentModule = modules.find(m => m.id === currentQuizConfig.moduleId);
  const moduleArticleUrl = currentModule ? currentModule.article : branding.exposureUrl;
  const link2="Module article: "+moduleArticleUrl.replace(/^https?:\/\//,'');
  doc.setTextColor(37,99,235); doc.text(link1,12,y); doc.link(12,y-4,doc.getTextWidth(link1),6,{url:branding.courseUrl}); y+=6;
  doc.text(link2,12,y); doc.link(12,y-4,doc.getTextWidth(link2),6,{url:moduleArticleUrl}); doc.setTextColor(0,0,0); y+=10;

  doc.setFont('helvetica','bold'); doc.text('Question review',12,y); y+=6; doc.setFont('helvetica','normal');
  if (!lastReport.misses.length) { y=writeWrapped(doc,'Great work ‚Äî no weak topics identified for this module.',12,y,186,6); }
  else {
    lastReport.misses.forEach((m,i)=>{ y=writeWrapped(doc,`${i+1}. ${m.id.toUpperCase()}: ${m.reviewHint||'Please review the relevant section.'}`,12,y,186,6); });
    y+=4; doc.setFont('helvetica','bold'); doc.text('Topics to review',12,y); y+=6; doc.setFont('helvetica','normal');
    const keys=[...new Set(lastReport.misses.flatMap(m=>currentQuizConfig.feedbackMap.questionTopics[m.id]||[]))];
    keys.forEach(k=>{ const label=(currentQuizConfig.feedbackMap.topics.find(t=>t.key===k)||{}).label||k; y=writeWrapped(doc,`‚Ä¢ ${label}`,16,y,182,6); });
  }
  doc.save(`${slugify(lastReport.moduleId)}-results-${Date.now()}.pdf`);
});

/* ---------- CERTIFICATE PDF ---------- */
document.getElementById("btn-certificate").addEventListener("click", async () => {
  console.log("Certificate button clicked", lastReport);
  if (!lastReport || !lastReport.pass) { console.log("No report or didn't pass"); return; }
  
  try {
    console.log("Starting certificate generation...");
    const doc = new jsPDF({ orientation:'l', unit:'mm', format:'a4' });
    console.log("jsPDF created");
    
    console.log("Loading images from URLs:", {logo: branding.logoUrl, academy: branding.academyUrl, sign: branding.signatureUrl, emblem: branding.emblemUrl});
    
    const [logo, academy, sign, emblem] = await Promise.all([
      toDataURL(branding.logoUrl).catch(err => { console.error("Logo failed to load:", err); return null; }),
      toDataURL(branding.academyUrl).catch(err => { console.error("Academy failed to load:", err); return null; }),
      toDataURL(branding.signatureUrl).catch(err => { console.error("Signature failed to load:", err); return null; }),
      toDataURLWithTransparency(branding.emblemUrl).catch(err => { console.error("Emblem failed to load:", err); return null; })
    ]);
    console.log("Images loaded", {logo: !!logo, academy: !!academy, sign: !!sign, emblem: !!emblem});

  doc.setDrawColor(240,89,34); doc.setLineWidth(3);  doc.rect(10,10,277,187);
  doc.setDrawColor(200,200,200); doc.setLineWidth(0.6); doc.rect(16,16,265,175);

  // Add your full logo back in top-left (no distortion)
  if (logo) { const logoDims=await getImgDims(logo); const logoFitted=fitWithin(logoDims.w,logoDims.h,50,20);
    doc.addImage(logo,'PNG',22,22,logoFitted.w,logoFitted.h); }
  
  
  if (academy) doc.addImage(academy,'PNG',290-42,22,20,20);
  
  // Add emblem to top center with proper aspect ratio
  if (emblem) {
    try {
      const emblemDims = await getImgDims(emblem);
      console.log("Emblem dimensions:", emblemDims);
      
      // Scale to fit within 40x40mm while preserving aspect ratio
      const maxSize = 40;
      const fitted = fitWithin(emblemDims.w, emblemDims.h, maxSize, maxSize);
      console.log("Fitted emblem dimensions:", fitted);
      
      // Center horizontally: (297 - fitted.w) / 2
      const x = (297 - fitted.w) / 2;
      const y = 22;
      
      doc.addImage(emblem, 'PNG', x, y, fitted.w, fitted.h);
      console.log(`Emblem added successfully at position (${x}, ${y}) with size ${fitted.w}x${fitted.h}`);
    } catch (err) {
      console.error("Failed to add emblem:", err);
    }
  } else {
    console.log("No emblem available, skipping...");
  }

  doc.setFont('times','bold'); doc.setFontSize(30); doc.text('Certificate of Achievement',148.5,72,{align:'center'});
  doc.setFont('times','normal'); doc.setFontSize(14); doc.text('This certifies that',148.5,88,{align:'center'});
  doc.setFont('times','bold'); doc.setFontSize(26); doc.setTextColor(0,0,139); doc.text(lastReport.name||'Student',148.5,104,{align:'center'});
  doc.setFont('times','normal'); doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('has successfully passed',148.5,120,{align:'center'});
  doc.setFont('times','bold'); doc.setFontSize(20); doc.setTextColor(0,0,139); doc.text(currentQuizConfig.moduleTitle,148.5,136,{align:'center'});
  // Score line with mixed colors and formatting - italic score, bold date
  doc.setFont('times','italic'); doc.setFontSize(13);
  
  const prefix = `with a score of `;
  const scoreResults = `${lastReport.percent}% (${lastReport.correct}/${lastReport.total})`;
  const suffix = ` on `;
  const dateText = `${formatDate(new Date(lastReport.timestamp))}.`;
  const fullText = prefix + scoreResults + suffix + dateText;
  
  // Calculate text widths for positioning
  const prefixWidth = doc.getTextWidth(prefix);
  const scoreWidth = doc.getTextWidth(scoreResults);
  const suffixWidth = doc.getTextWidth(suffix);
  const dateWidth = doc.getTextWidth(dateText);
  const totalWidth = prefixWidth + scoreWidth + suffixWidth + dateWidth;
  
  // Center the entire text block
  const startX = 148.5 - (totalWidth / 2);
  
  // Draw each segment with appropriate color and formatting
  doc.setTextColor(0,0,0); // Black for prefix
  doc.text(prefix, startX, 150);
  
  doc.setTextColor(50,50,50); // Dark grey for score results
  doc.text(scoreResults, startX + prefixWidth, 150);
  
  doc.setTextColor(0,0,0); // Black for suffix
  doc.text(suffix, startX + prefixWidth + scoreWidth, 150);
  
  doc.setFont('times','bold'); // Bold for date
  doc.setTextColor(0,0,0); // Black for date
  doc.text(dateText, startX + prefixWidth + scoreWidth + suffixWidth, 150);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text('Alan Ranger Photography Academy ‚Äî Beginners Modules',148.5,160,{align:'center'});

  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  doc.text('Instructor: Alan Ranger',22,172);
  const siteText='Website: alanranger.com'; doc.text(siteText,22,180); doc.link(22,176,doc.getTextWidth(siteText),6,{url:branding.siteUrl});

  const sigLineY=184;
  if (sign){ 
    console.log("Adding signature to certificate...");
    try {
      const dims=await getImgDims(sign); 
      const fitted=fitWithin(dims.w,dims.h,130*0.8,50*0.8);
      const x=290-22-fitted.w; 
      const y=sigLineY-fitted.h+3; 
      doc.addImage(sign,'PNG',x,y,fitted.w,fitted.h);
      console.log("Signature added successfully");
    } catch (err) {
      console.error("Failed to add signature:", err);
    }
  } else {
    console.log("No signature available, skipping...");
  }
  doc.setDrawColor(240,89,34); doc.setLineWidth(0.6); doc.line(290-80,sigLineY,290-22,sigLineY);
  doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text('Signature',290-22,sigLineY+6,{align:'right'});

  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text(`Certificate ID: ${slugify(lastReport.moduleId)}-${Date.now()}`,290-16,46,{align:'right'});

  console.log("About to save certificate...");
  doc.save(`${slugify(lastReport.moduleId)}-certificate-${Date.now()}.pdf`);
  console.log("Certificate saved successfully!");
  
  } catch (error) {
    console.error("Error generating certificate:", error);
    alert("Error generating certificate: " + error.message);
  }
});
</script>