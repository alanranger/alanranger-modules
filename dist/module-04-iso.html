<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ISO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  :root{
  /* Alan Ranger brand */
  --ar-orange:#E57200;          /* primary brand orange */
  --ar-orange-700:#cc6500;      /* hover/active (approx. -12%) */
  --ar-blue:#2563eb;
  --ar-border:#e9e9e9;
  --ar-text:#111;
  --ar-muted:#6b7280;
}

/* Page container with brand bar + left gutter spacing */
#ar-assessment{
  border-left:12px solid var(--ar-orange);  /* strong page accent */
  padding-left:18px;                        /* <-- gutter between bar and cards */
  max-width:880px;
  margin:28px auto;
  background:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ar-text);
}

/* Cards (matches your CTA card style) */
.card{
  background:#fff;
  border:1px solid var(--ar-border);
  border-radius:12px;
  padding:18px 20px;
  margin:24px 0;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}

/* Pale info bar (matches blog snippet blocks) */
.bar{
  border-left:6px solid var(--ar-orange);
  background:#fafafa;
  padding:18px 20px;
  margin:24px 0;
  border-radius:8px;
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}

/* Titles */
.qtitle{
  color:var(--ar-orange);
  font-weight:700;
  margin:0 0 6px 0;
}

/* Buttons */
.btn{
  border:0;
  border-radius:10px;
  padding:12px 16px;
  font-weight:700;
  cursor:pointer;
  line-height:1.1;
  transition:background .15s ease, opacity .15s ease, box-shadow .15s ease;
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-orange{background:var(--ar-orange);color:#fff}
.btn-orange:hover{background:var(--ar-orange-700)}
.btn-blue{background:#1e40af;color:#fff}
.btn-green{background:#10b981;color:#fff}
.btn-neutral{background:#fff;border:1px solid var(--ar-orange);color:var(--ar-orange)}
.btn-neutral:hover{box-shadow:0 0 0 2px rgba(229,114,0,.2) inset}

/* Button row spacing */
.actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

/* Helper text */
.help{
  font-size:12px;
  color:var(--ar-muted);
  margin:8px 0 0 0;
}

/* Status pill */
.pill{
  display:inline-block;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  background:#fff;
  font-size:12px
}
.pill.ok{background:#e8fff4;border-color:#b7f0d2;color:#067647;font-weight:700}
.pill.warn{background:#fff5f5;border-color:#fac5c5;color:#b42318;font-weight:700}

/* Radio button styling */
.radio-option{
  display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border-radius:6px;transition:background 0.15s ease;
}
.radio-input{
  margin:0;width:16px;height:16px;accent-color:var(--ar-orange);
}
.radio-text{
  font-weight:400;color:var(--ar-text);
}

/* Toast (for later steps) */
#ar-toast{
  position:fixed;left:50%;top:22px;transform:translateX(-50%);
  z-index:99999;background:#111;color:#fff;border-radius:10px;
  padding:10px 14px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.18)
}
#ar-toast.ok{background:#10b981}
#ar-toast.err{background:#ef4444}
#ar-toast.info{background:#2563eb}

  </style>
</head>
<body>
  <div id="ar-assessment">
    <!-- The app will render inside this container -->
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  
  <script>
    // Embedded module definition
    const MODULE = {"moduleId":"module-04-iso","title":"ISO","passMark":80,"questions":[{"question":"What does ISO actually control in a digital camera?","options":["The physical sensitivity of the sensor","The amount of light the lens transmits","The amplification of the sensor's signal after capture","The color temperature of the image"],"correct":2,"reviewHint":"ISO = signal gain, not lens light or white balance."},{"question":"Going from ISO 100 → ISO 400 equals…","options":["Half a stop","One stop","Two stops","Four stops"],"correct":2,"reviewHint":"Each doubling = +1 stop (100→200→400 = +2 stops)."},{"question":"As ISO increases (all else equal), which artifact increases most?","options":["Motion blur","Diffraction","Image noise/grain","Perspective distortion"],"correct":2,"reviewHint":"Higher ISO → more visible noise, especially in shadows."},{"question":"Best everyday practice with ISO is to…","options":["Always shoot base ISO, even if motion blurs","Use the lowest ISO that still gives the shutter/aperture you need","Always use Auto ISO","Use maximum ISO and denoise later"],"correct":1,"reviewHint":"Balance clean image vs. needed shutter/aperture."},{"question":"Which is most likely a camera's base/native ISO?","options":["3200","1600","100","12,800"],"correct":2,"reviewHint":"Many cameras have base ISO ≈ 100 (some ≈ 64 or 200)."},{"question":"Indoors at 1/30s, f/2.8, ISO 100, your subject is blurry from motion. Quickest fix (same mode) is to…","options":["Raise ISO","Stop down to f/5.6","Lower ISO","Turn off stabilization"],"correct":0,"reviewHint":"Higher ISO lets you use a faster shutter to freeze motion."},{"question":"In Aperture Priority with Auto ISO and a minimum shutter set, as light drops (and max ISO isn't reached) the camera will…","options":["Open the aperture further","Go below your min shutter","Raise ISO","Apply exposure compensation"],"correct":2,"reviewHint":"Auto ISO tries to hold your min shutter by increasing ISO."},{"question":"Does ISO change depth of field or perspective?","options":["Yes, higher ISO gives shallower depth of field","No—ISO doesn't change DoF or perspective","Yes, higher ISO compresses perspective","Yes, lower ISO increases background blur"],"correct":1,"reviewHint":"ISO only affects signal gain/brightness, not optics."},{"question":"Your photo at ISO 6400 looks noisy. Next time, what helps reduce noise most?","options":["Use a lower ISO with a longer shutter (tripod/brace)","Use a smaller aperture (higher f-number)","Increase ISO further and denoise later","Switch to JPEG"],"correct":0,"reviewHint":"Lower ISO generally = cleaner file (if you can stabilize)."},{"question":"With manual flash power fixed, increasing ISO from 200 → 400 will…","options":["Brighten ambient but not flash exposure","Brighten both ambient and flash-lit areas by one stop","Only change white balance","Reduce the effective flash power"],"correct":1,"reviewHint":"ISO boosts all recorded light, including flash."},{"question":"Which statement about Auto ISO is accurate?","options":["It changes aperture automatically","It adjusts ISO (within limits) to maintain exposure/min shutter","It turns off the light meter","It locks ISO to base"],"correct":1,"reviewHint":"Auto ISO raises/lowers ISO automatically within your limits."},{"question":"Start at 1/60s, f/4, ISO 100. You change to ISO 400 (+2 stops). To keep the same exposure, which shutter?","options":["1/15s","1/30s","1/60s","1/250s"],"correct":3,"reviewHint":"+2 stops ISO → make shutter 2 stops faster (1/60 → 1/125 → 1/250)."}],"feedbackMap":{"topics":[{"key":"iso-basics","label":"ISO basics"},{"key":"stops-doubling","label":"Stops and doubling ISO"},{"key":"noise-impact","label":"Noise and ISO"},{"key":"practical-choice","label":"Choosing ISO in practice"},{"key":"base-iso","label":"Base/Native ISO"},{"key":"freezing-action-iso","label":"Using ISO to freeze motion"},{"key":"auto-iso-min-shutter","label":"Auto ISO & minimum shutter"},{"key":"iso-and-dof","label":"What ISO does NOT change"},{"key":"reduce-noise","label":"Ways to reduce noise"},{"key":"flash-and-iso","label":"Flash exposure & ISO"},{"key":"auto-iso-overview","label":"Auto ISO overview"},{"key":"exposure-equivalence","label":"Exposure equivalence (trade-offs)"}],"questionTopics":{"q1":["iso-basics"],"q2":["stops-doubling"],"q3":["noise-impact"],"q4":["practical-choice"],"q5":["base-iso"],"q6":["freezing-action-iso"],"q7":["auto-iso-min-shutter"],"q8":["iso-and-dof"],"q9":["reduce-noise"],"q10":["flash-and-iso"],"q11":["auto-iso-overview"],"q12":["exposure-equivalence"]},"topicLinks":{"iso-basics":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography","stops-doubling":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#stops","noise-impact":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#noise","practical-choice":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#practice","base-iso":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#base-iso","freezing-action-iso":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#freeze","auto-iso-min-shutter":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#auto-iso","iso-and-dof":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#does-not-change","reduce-noise":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#reduce-noise","flash-and-iso":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#flash","auto-iso-overview":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#auto-iso","exposure-equivalence":"https://www.alanranger.com/blog-on-photography/what-is-iso-in-photography#equivalence"}}};
  </script>

  <script>
  // Bundled app logic (engine, auth, pdf generators etc.)
  // Alan Ranger Photography Academy - Assessment Engine
(function(){
  // Supabase configuration
  const SUPABASE_URL = 'https://dqrtcsvqsfgbqmnonkpt.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxcnRjc3Zxc2ZnYnFtbm9ua3B0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5OTA4MjUsImV4cCI6MjA3MjU2NjgyNX0.e19j8NOUK5HWoTGZv4B62U_n0je_19Tp-F20qKGbWDk';
  
  // Initialize Supabase client
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // App state
  let currentUser = null;
  let quizAnswers = {};
  let isSubmitting = false;
  let lastEmailSent = 0;
  const EMAIL_DEBOUNCE_MS = 60000; // 60 seconds
  
  // Module loading system
  let currentModule = null;
  const moduleCache = new Map();
  
  // Load module from JSON file
  async function loadModule(moduleId) {
    if (moduleCache.has(moduleId)) {
      return moduleCache.get(moduleId);
    }
    
    try {
      // Use GitHub Pages URL for module files
      const response = await fetch(`https://alanranger.github.io/alanranger-modules/modules/${moduleId}.json`);
      if (!response.ok) {
        throw new Error(`Failed to load module: ${response.status}`);
      }
      const moduleData = await response.json();
      moduleCache.set(moduleId, moduleData);
      return moduleData;
    } catch (error) {
      console.error('Error loading module:', error);
      showToast(`Failed to load module ${moduleId}`, 'err');
      return null;
    }
  }
  
  // Initialize with current module
  async function initializeModule() {
    if (window.MODULE) {
      currentModule = window.MODULE;
    } else {
      // Fallback to module-01 if no module specified
      currentModule = await loadModule('module-01');
    }
    
    if (currentModule) {
      renderQuiz();
    }
  }
  
  // Switch to a different module
  async function switchModule(moduleId) {
    const newModule = await loadModule(moduleId);
    if (newModule) {
      currentModule = newModule;
      quizAnswers = {}; // Clear previous answers
      render();
    }
  }
  
  // Make switchModule globally available
  window.switchModule = switchModule;
  
  // Toast notification system
  function showToast(message, type = 'info') {
    const toast = document.getElementById('ar-toast');
    toast.textContent = message;
    toast.className = `ar-toast ${type}`;
    toast.style.display = 'block';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, 5000);
  }
  
  // Authentication functions
  async function signInWithEmail(email) {
    if (!email || !email.includes('@')) {
      showToast('Please enter a valid email address', 'err');
      return;
    }
    
    const now = Date.now();
    if (now - lastEmailSent < EMAIL_DEBOUNCE_MS) {
      showToast('Use the link we just sent, or try again in ~60s.', 'warn');
      return;
    }
    
    try {
      const { error } = await supabaseClient.auth.signInWithOtp({
        email: email,
        options: {
          emailRedirectTo: window.location.href
        }
      });
      
      if (error) {
        if (error.message.includes('rate limit')) {
          showToast('Use the link we just sent, or try again in ~60s.', 'warn');
        } else {
          showToast('Invalid email address', 'err');
        }
        return;
      }
      
      lastEmailSent = now;
      showToast('Magic link sent! Check your email and click the link to sign in.', 'ok');
      
      // Queue current results for auto-save
      queueResultsForSave();
      
    } catch (err) {
      showToast('Something went wrong. Please try again.', 'err');
    }
  }
  
  async function signOut() {
    await supabaseClient.auth.signOut();
    currentUser = null;
    localStorage.removeItem('ar_queued_results');
    render();
  }
  
  // Save flow functions
  function queueResultsForSave() {
    const results = {
      moduleId: currentModule.moduleId,
      answers: quizAnswers,
      timestamp: new Date().toISOString(),
      score: calculateScore()
    };
    localStorage.setItem('ar_queued_results', JSON.stringify(results));
  }
  
  async function saveResults() {
    if (!currentUser) {
      showToast('Please sign in to save your results', 'warn');
      return;
    }
    
    try {
      const results = {
        user_id: currentUser.id,
        module_id: currentModule.moduleId,
        answers: quizAnswers,
        score: calculateScore(),
        passed: calculateScore() >= currentModule.passMark,
        completed_at: new Date().toISOString()
      };
      
      const { error } = await supabaseClient
        .from('module_results')
        .upsert(results, { onConflict: 'user_id,module_id' });
      
      if (error) throw error;
      
      showToast('Results saved to your account!', 'ok');
      
    } catch (err) {
      showToast('Failed to save results. Please try again.', 'err');
    }
  }
  
  async function autoSaveQueuedResults() {
    const queued = localStorage.getItem('ar_queued_results');
    if (!queued || !currentUser) return;
    
    try {
      const results = JSON.parse(queued);
      if (results.moduleId !== currentModule.moduleId) return;
      
      const saveData = {
        user_id: currentUser.id,
        module_id: currentModule.moduleId,
        answers: results.answers,
        score: results.score,
        passed: results.score >= currentModule.passMark,
        completed_at: results.timestamp
      };
      
      const { error } = await supabaseClient
        .from('module_results')
        .upsert(saveData, { onConflict: 'user_id,module_id' });
      
      if (!error) {
        localStorage.removeItem('ar_queued_results');
        showToast('Previous results automatically saved!', 'ok');
      }
      
    } catch (err) {
      console.error('Auto-save failed:', err);
    }
  }
  
  // Quiz functions
  function calculateScore() {
    if (!currentModule.questions || currentModule.questions.length === 0) return 0;
    
    let correct = 0;
    currentModule.questions.forEach((q, i) => {
      if (quizAnswers[i] === q.correct) correct++;
    });
    
    return Math.round((correct / currentModule.questions.length) * 100);
  }
  
  function handleAnswerChange(questionIndex, answer) {
    quizAnswers[questionIndex] = answer;
    render();
  }
  
  function resetQuiz() {
    quizAnswers = {};
    window.quizResults = null;
    render();
  }
  
  function submitAnswers() {
    if (isSubmitting) return;
    
    const answered = Object.keys(quizAnswers).length;
    const total = currentModule.questions ? currentModule.questions.length : 0;
    
    if (answered < total) {
      showToast(`Please answer all ${total} questions before submitting.`, 'warn');
      return;
    }
    
    isSubmitting = true;
    const score = calculateScore();
    const passed = score >= currentModule.passMark;
    
    // Generate compact results display
    const results = currentModule.questions.map((q, i) => {
      const isCorrect = quizAnswers[i] === q.correct;
      return `Q${i + 1}: ${isCorrect ? 'Correct' : 'Incorrect'}`;
    }).join(', ');
    
    showToast(
      `Quiz completed! Score: ${score}% ${passed ? '✅ Passed' : '❌ Failed'}`, 
      passed ? 'ok' : 'warn'
    );
    
    // Store results for display
    window.quizResults = { score, passed, results, submitted: true };
    
    // Queue for save if not signed in
    if (!currentUser) {
      queueResultsForSave();
    }
    
    isSubmitting = false;
    render();
  }
  
  // Render function
  function render() {
    const authStatus = currentUser ? 
      `<div class="pill ok">Signed in as ${currentUser.email}</div>` : 
      `<div class="pill warn">Not signed in</div>`;
    
    const signInForm = !currentUser ? `
      <div class="card">
        <h3 class="qtitle">Sign in to save your progress</h3>
        <div style="display:flex;gap:8px;align-items:center;margin:12px 0;">
          <input type="email" id="email-input" placeholder="your@email.com" 
                 style="flex:1;padding:8px 12px;border:1px solid var(--ar-border);border-radius:6px;">
          <button class="btn btn-orange" onclick="handleSignIn()">Send magic link</button>
        </div>
        <div class="help">We'll send you a secure link to sign in. No password required.</div>
      </div>
    ` : '';
    
    const signOutButton = currentUser ? 
      `<button class="btn btn-neutral" onclick="handleSignOut()" style="margin-left:auto;">Force sign out</button>` : '';
    
    const quizContent = currentModule.questions && currentModule.questions.length > 0 ? 
      currentModule.questions.map((q, i) => `
        <div class="card">
          <h3 class="qtitle">Question ${i + 1}</h3>
          <p style="margin:8px 0 16px 0;">${q.question}</p>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${q.options.map((option, j) => `
              <label class="radio-option" 
                     onmouseover="this.style.background='#f9f9f9'" 
                     onmouseout="this.style.background='transparent'">
                <input type="radio" name="q${i}" value="${j}" 
                       ${quizAnswers[i] === j ? 'checked' : ''}
                       onchange="handleAnswerChange(${i}, ${j})" 
                       class="radio-input">
                <span class="radio-text">${option}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `).join('') : `
        <div class="card">
          <h3 class="qtitle">No questions available</h3>
          <p>The quiz questions haven't been loaded yet. Please check the module configuration.</p>
        </div>
      `;
    
    const resultsDisplay = window.quizResults && window.quizResults.submitted ? `
      <div class="card" style="background:#f8f9fa;border-left:4px solid var(--ar-orange);">
        <h3 class="qtitle">Quiz Results</h3>
        <p style="margin:8px 0;font-weight:600;color:${window.quizResults.passed ? '#10b981' : '#ef4444'};">
          Score: ${window.quizResults.score}% ${window.quizResults.passed ? '✅ Passed' : '❌ Failed'}
        </p>
        <p style="margin:8px 0 0 0;font-size:14px;color:var(--ar-muted);">
          ${window.quizResults.results}
        </p>
      </div>
    ` : '';
    
    const score = calculateScore();
    const answered = Object.keys(quizAnswers).length;
    const total = currentModule.questions ? currentModule.questions.length : 0;
    
  root.innerHTML = `
    <div class="bar card">
        ${authStatus}
        <h2 style="margin:10px 0 0 0">Module: ${currentModule.title}</h2>
        <div class="help">
          ${total > 0 ? `Progress: ${answered}/${total} questions answered` : 'Quiz content loading...'}
          ${score > 0 ? ` • Current score: ${score}%` : ''}
        </div>
    </div>
      
      ${signInForm}
      
      ${quizContent}
      
      ${resultsDisplay}

    <div class="card">
      <div class="actions">
          <button class="btn btn-orange" onclick="submitAnswers()" 
                  ${isSubmitting || answered < total ? 'disabled' : ''}>
            Submit answers
          </button>
          <button class="btn btn-neutral" onclick="resetQuiz()">Reset</button>
          <button class="btn btn-blue" onclick="downloadResultsPDF()" 
                  ${!window.quizResults || !window.quizResults.submitted ? 'disabled' : ''}>
            Download results (PDF)
          </button>
          <button class="btn btn-green" onclick="downloadCertificatePDF()" 
                  ${!window.quizResults || !window.quizResults.submitted || !window.quizResults.passed ? 'disabled' : ''}>
            Download certificate (PDF)
          </button>
          <button class="btn btn-neutral" onclick="saveResults()" 
                  ${!currentUser ? 'disabled' : ''}>
            Save to my account
          </button>
          ${signOutButton}
        </div>
        <div class="help">
          ${total > 0 ? `Answer all ${total} questions to submit. Pass mark: ${currentModule.passMark}%` : 'Quiz configuration needed.'}
      </div>
    </div>

    <div id="ar-toast" role="status" aria-live="polite"></div>
  `;
  }
  
  // PDF Generation functions
  async function downloadResultsPDF() {
    if (!window.quizResults || !window.quizResults.submitted) return;
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Orange header bar
      doc.setFillColor(229, 114, 0);
      doc.rect(0, 0, 210, 20, 'F');
      
      // Org icon on left (from logo-full.png)
      const orgIcon = await getBase64Image('src/assets/logo-full.png');
      if (orgIcon) {
        doc.addImage('data:image/png;base64,' + orgIcon, 'PNG', 10, 5, 15, 10);
      }
      
      // Academy cap on right (correct aspect)
      const academyCap = await getBase64Image('src/assets/academy.png');
      if (academyCap) {
        doc.addImage('data:image/png;base64,' + academyCap, 'PNG', 180, 5, 20, 10);
      }
      
      // Title
      doc.setFontSize(18);
      doc.setTextColor(0, 0, 0);
      doc.text('Module 1: What is Exposure', 20, 40);
      
      // Top info box
      doc.setDrawColor(200, 200, 200);
      doc.setFillColor(248, 249, 250);
      doc.rect(20, 50, 170, 40, 'FD');
      
      const studentName = currentUser ? currentUser.email : 'Student';
      doc.setFontSize(10);
      doc.text(`Name: ${studentName}`, 25, 60);
      doc.text(`Score: ${window.quizResults.score}%`, 25, 68);
      doc.text(`Result: ${window.quizResults.passed ? 'PASSED' : 'FAILED'}`, 25, 76);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 25, 84);
      
      // Links section (blue and clickable)
      doc.setFontSize(12);
      doc.setTextColor(37, 99, 235);
      doc.text('Related Links:', 20, 110);
      
      const links = [
        { text: 'What is Exposure', url: 'https://www.alanranger.com/blog-on-photography/what-is-exposure-in-photography' },
        { text: 'Aperture', url: 'https://www.alanranger.com/blog-on-photography/aperture' },
        { text: 'Shutter Speed', url: 'https://www.alanranger.com/blog-on-photography/shutter-speed' },
        { text: 'ISO', url: 'https://www.alanranger.com/blog-on-photography/iso' },
        { text: 'Academy site', url: 'https://www.alanranger.com/academy' }
      ];
      
      let linkY = 120;
      links.forEach(link => {
        doc.textWithLink(link.text, 20, linkY, { url: link.url });
        linkY += 8;
      });
      
      // Q1..Q5 results line (not overlapping)
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      const results = currentModule.questions.map((q, i) => {
        const isCorrect = quizAnswers[i] === q.correct;
        return `Q${i + 1}: ${isCorrect ? 'Correct' : 'Incorrect'}`;
      }).join(', ');
      doc.text(results, 20, linkY + 15);
      
      doc.save(`assessment-results-${currentModule.moduleId}.pdf`);
      
    } catch (err) {
      showToast('Failed to generate PDF. Please try again.', 'err');
    }
  }
  
  async function downloadCertificatePDF() {
    if (!window.quizResults || !window.quizResults.submitted || !window.quizResults.passed) return;
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Outer orange frame
      doc.setDrawColor(229, 114, 0);
      doc.setLineWidth(3);
      doc.rect(10, 10, 277, 190);
      
      // Inner grey keyline
      doc.setDrawColor(128, 128, 128);
      doc.setLineWidth(1);
      doc.rect(15, 15, 267, 180);
      
      // Top-right brand logo (inset 16-20pt from keyline, not touching Certificate ID)
      const logoWidth = 40;
      const logoHeight = 20;
      const brandLogo = await getBase64Image('src/assets/logo-full.png');
      if (brandLogo) {
        doc.addImage('data:image/png;base64,' + brandLogo, 'PNG', 240, 25, logoWidth, logoHeight);
      }
      
      // Certificate ID (top left, away from logo)
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.text('Certificate ID: AR-2024-001', 20, 25);
      
      // Main typographic block centered
      const pageWidth = 297; // A4 landscape width
      const centerX = pageWidth / 2;
      
      // Certificate of Achievement (Times Bold)
      doc.setFont('times', 'bold');
      doc.setFontSize(28);
      doc.setTextColor(0, 0, 0);
      const titleText = 'Certificate of Achievement';
      const titleWidth = doc.getTextWidth(titleText);
      doc.text(titleText, centerX - titleWidth/2, 80);
      
      // Student name
      doc.setFont('times', 'normal');
      doc.setFontSize(16);
      const studentName = currentUser ? currentUser.email : 'Student';
      const nameText = `This certifies that ${studentName}`;
      const nameWidth = doc.getTextWidth(nameText);
      doc.text(nameText, centerX - nameWidth/2, 100);
      
      // Module completion
      doc.setFontSize(14);
      const moduleText = `has successfully completed ${currentModule.title}`;
      const moduleWidth = doc.getTextWidth(moduleText);
      doc.text(moduleText, centerX - moduleWidth/2, 120);
      
      const scoreText = `with a score of ${window.quizResults.score}%`;
      const scoreWidth = doc.getTextWidth(scoreText);
      doc.text(scoreText, centerX - scoreWidth/2, 135);
      
      // Date
      const dateText = `Completed on ${new Date().toLocaleDateString()}`;
      const dateWidth = doc.getTextWidth(dateText);
      doc.text(dateText, centerX - dateWidth/2, 150);
      
      // Strapline above signature (no overlap)
      doc.setFontSize(10);
      doc.setTextColor(107, 114, 128);
      const straplineText = 'Alan Ranger Photography Academy — Beginners Modules included';
      const straplineWidth = doc.getTextWidth(straplineText);
      doc.text(straplineText, centerX - straplineWidth/2, 170);
      
      // Thin orange rule for signature
      doc.setDrawColor(229, 114, 0);
      doc.setLineWidth(1);
      const ruleStartX = centerX - 50;
      const ruleEndX = centerX + 50;
      doc.line(ruleStartX, 180, ruleEndX, 180);
      
      // Signature image (left-aligned to rule start, no stretch)
      const sigWidth = 50;
      const sigHeight = 15;
      const signature = await getBase64Image('src/assets/signature.png');
      if (signature) {
        doc.addImage('data:image/png;base64,' + signature, 'PNG', ruleStartX, 185, sigWidth, sigHeight);
      }
      
      // Footer left
      doc.setFontSize(8);
      doc.setTextColor(0, 0, 0);
      doc.text('Instructor: Alan Ranger', 20, 200);
      doc.text('Website: www.alanranger.com', 20, 205);
      
      doc.save(`certificate-${currentModule.moduleId}.pdf`);
      
    } catch (err) {
      showToast('Failed to generate certificate. Please try again.', 'err');
    }
  }
  
  // Helper function to convert image to base64
  async function getBase64Image(imagePath) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png').split(',')[1]);
      };
      img.onerror = () => resolve(''); // Return empty string if image fails to load
      img.src = imagePath;
    });
  }
  
  // Global event handlers
  window.handleSignIn = function() {
    const email = document.getElementById('email-input').value;
    signInWithEmail(email);
  };
  
  window.handleSignOut = signOut;
  window.handleAnswerChange = handleAnswerChange;
  window.submitAnswers = submitAnswers;
  window.resetQuiz = resetQuiz;
  window.saveResults = saveResults;
  window.downloadResultsPDF = downloadResultsPDF;
  window.downloadCertificatePDF = downloadCertificatePDF;
  
  // Initialize app
  async function init() {
    // Load the module first
    await initializeModule();
    
    // Check for existing auth session
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
      currentUser = session.user;
      await autoSaveQueuedResults();
    }
    
    // Listen for auth changes
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        currentUser = session.user;
        await autoSaveQueuedResults();
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
      }
      render();
    });
    
    render();
  }
  
  // Start the app
  init();
})();

  </script>
</body>
</html>
